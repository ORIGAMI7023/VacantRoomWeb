@page "/"
@rendermode InteractiveServer
@inject VacantRoomService VacantService

<div class="vacant-room-container">
    <div class="page-header">
        <h3>教室查询系统</h3>
        <p>@TodayText</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button @onclick="() => SetActiveTab(0)"
                class="tab-btn @(ActiveTab == 0 ? "active" : "")">
            空教室查询
        </button>
        <button @onclick="() => SetActiveTab(1)"
                class="tab-btn @(ActiveTab == 1 ? "active" : "")">
            教室使用情况查询
        </button>
    </div>

    <div class="content-wrapper">
        @if (ActiveTab == 0)
        {
            <!-- 空教室查询 -->
            <div class="query-form">
                <div class="form-group">
                    <label>校区：</label>
                    <select @bind="Campus">
                        <option value="奉贤校区">奉贤</option>
                        <option value="徐汇校区">徐汇</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>星期：</label>
                    <select @bind="Weekday">
                        <option>周一</option>
                        <option>周二</option>
                        <option>周三</option>
                        <option>周四</option>
                        <option>周五</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>节次：</label>
                    <select @bind="Period">
                        <option>1-2节</option>
                        <option>3-4节</option>
                        <option>5-6节</option>
                        <option>7-8节</option>
                        <option>9-10节</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>教学楼：</label>
                    <select @bind="Building">
                        <option>所有</option>
                        <option>A</option>
                        <option>B</option>
                        <option>C</option>
                        <option>D</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>第几周：</label>
                    <select @bind="Week">
                        @for (int i = 1; i <= 18; i++)
                        {
                            <option value="@($"第{i}周")">第 @i 周</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <button @onclick="QueryVacantRooms" class="btn btn-primary">
                        查询空教室
                    </button>
                </div>
            </div>


            @if (VacantResult != null)
            {
                <div class="result-section">
                    <p class="result-summary">共查询到 @VacantResult.Count 个空教室</p>
                    <div class="result-list">
                        @foreach (var room in VacantResult)
                        {
                            <span class="room-item">@room</span>
                        }
                    </div>
                </div>
            }
            else
            {
                <p class="empty-hint">请填写条件后点击查询</p>
            }
        }
        else
        {
            <!-- 教室使用情况查询 -->
            <div class="query-form">
                <div class="form-group">
                    <label>校区：</label>
                    <select @bind="RoomCampus">
                        <option value="奉贤校区">奉贤</option>
                        <option value="徐汇校区">徐汇</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>教学楼：</label>
                    <select value="@RoomBuilding" @onchange="OnBuildingChanged">
                        <option value="">请选择教学楼</option>
                        <option value="A">A楼</option>
                        <option value="B">B楼</option>
                        <option value="C">C楼</option>
                        <option value="D">D楼</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>教室号：</label>
                    <select @bind="RoomNumber" disabled="@string.IsNullOrEmpty(RoomBuilding)">
                        @if (string.IsNullOrEmpty(RoomBuilding))
                        {
                            <option value="">请先选择教学楼</option>
                        }
                        else
                        {
                            <option value="">请选择教室</option>
                            @foreach (var room in GetRoomsForBuilding(RoomBuilding))
                            {
                                <option value="@room">@room</option>
                            }
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>星期：</label>
                    <select @bind="RoomWeekday">
                        <option>周一</option>
                        <option>周二</option>
                        <option>周三</option>
                        <option>周四</option>
                        <option>周五</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>第几周：</label>
                    <select @bind="RoomWeek">
                        @for (int i = 1; i <= 18; i++)
                        {
                            <option value="@($"第{i}周")">第 @i 周</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <button @onclick="QueryRoomUsage"
                            disabled="@string.IsNullOrEmpty(RoomNumber)"
                            class="btn btn-success">
                        查询教室使用情况
                    </button>
                </div>
            </div>

            @if (UsageResult != null)
            {
                <div class="usage-result">
                    <h4>@RoomBuilding@RoomNumber 教室使用情况</h4>
                    <p class="usage-meta">@RoomCampus · @RoomWeekday · @RoomWeek</p>

                    @if (UsageResult.Count == 0)
                    {
                        <p class="no-usage">✅ 该教室当天全天空闲</p>
                    }
                    else
                    {
                        <div class="usage-list">
                            @foreach (var usage in UsageResult)
                            {
                                <div class="usage-item">
                                    <div class="usage-header">
                                        <span class="period">@usage.Period</span>
                                        <span class="time-range">@usage.TimeRange</span>
                                    </div>
                                    <div class="usage-course">
                                        <strong>课程：</strong>@usage.CourseName
                                    </div>
                                    @if (!string.IsNullOrEmpty(usage.Teacher))
                                    {
                                        <div class="usage-teacher">
                                            <strong>教师：</strong>@usage.Teacher
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="empty-hint">请选择教室后点击查询</p>
            }
        }
    </div>
</div>

<style>
    .vacant-room-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        position: relative;
        z-index: 1;
        background: transparent;
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }

        .page-header h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .page-header p {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
        }

    .tab-navigation {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 30px;
        border-bottom: 2px solid #e9ecef;
    }

    .tab-btn {
        padding: 12px 24px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
        font-weight: 500;
        font-size: 1rem;
        transition: all 0.3s;
        color: #666;
    }

        .tab-btn.active {
            background: #007bff;
            color: white;
        }

        .tab-btn:not(.active):hover {
            background: #f8f9fa;
            color: #333;
        }

    .content-wrapper {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 30px;
        border: 1px solid #e9ecef;
    }

    .query-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 25px;
    }

    .form-group {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

        .form-group label {
            min-width: 80px;
            text-align: right;
            font-weight: 500;
            color: #333;
        }

        .form-group select {
            width: 200px;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            color: #333;
            transition: border-color 0.3s;
        }

            .form-group select:focus {
                outline: none;
                border-color: #007bff;
            }

            .form-group select:disabled {
                background: #f8f9fa;
                color: #6c757d;
            }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        min-width: 160px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #0056b3, #003d82);
            transform: translateY(-1px);
        }

    .btn-success {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
    }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #1e7e34, #155724);
            transform: translateY(-1px);
        }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .debug-info {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #ffc107;
    }

        .debug-info p {
            color: #856404;
            margin: 0;
            font-size: 0.9rem;
            font-family: monospace;
        }

    .result-section {
        text-align: center;
    }

    .result-summary {
        color: #e67e22;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    .result-list {
        max-height: 300px;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    .room-item {
        background: #007bff;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .usage-result {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

        .usage-result h4 {
            margin: 0 0 10px 0;
            color: #495057;
            text-align: center;
        }

    .usage-meta {
        color: #6c757d;
        margin-bottom: 15px;
        text-align: center;
        font-size: 0.95rem;
    }

    .no-usage {
        color: #28a745;
        font-weight: bold;
        text-align: center;
        font-size: 1.1rem;
    }

    .usage-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .usage-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #dc3545;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .usage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .period {
        font-weight: bold;
        color: #dc3545;
        font-size: 1rem;
    }

    .time-range {
        font-size: 0.9rem;
        color: #6c757d;
        font-family: monospace;
    }

    .usage-course {
        margin-bottom: 4px;
        color: #495057;
    }

    .usage-teacher {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .empty-hint {
        color: #adb5bd;
        text-align: center;
        font-style: italic;
        margin: 20px 0;
        cursor: default;
    }

    /* 防止页面加载时出现异常元素 */
    .vacant-room-container::before,
    .vacant-room-container::after {
        display: none !important;
    }

    /* 隐藏可能的加载状态元素 */
    .loading-indicator,
    .spinner,
    .cursor-wait {
        display: none !important;
    }

    /* 确保页面内容完全覆盖 */
    body, html {
        overflow-x: hidden;
    }

    /* 响应式设计 */
    @@media (max-width: 768px) {
        .vacant-room-container {
            padding: 16px;
            max-width: 100%;
        }

        .content-wrapper {
            padding: 20px;
        }

        .form-group {
            flex-direction: column;
            gap: 8px;
        }

            .form-group label {
                text-align: center;
                min-width: auto;
            }

            .form-group select {
                width: 100%;
                max-width: 250px;
            }

        .tab-navigation {
            flex-direction: column;
            gap: 4px;
        }

        .tab-btn {
            width: 100%;
        }

        .usage-header {
            flex-direction: column;
            gap: 4px;
        }

        .result-list {
            justify-content: flex-start;
        }
    }
</style>

@code {
    // Tab management
    int ActiveTab = 0;

    // 空教室查询相关变量
    string Campus = "奉贤校区";
    string Weekday = "";
    string Period = "1-2节";
    string Building = "所有";
    string Week = "第1周";
    List<string> VacantResult;

    // 教室使用情况查询相关变量
    string RoomCampus = "奉贤校区";
    string RoomBuilding = "";
    string RoomNumber = "";
    string RoomWeekday = "";
    string RoomWeek = "第1周";
    List<RoomUsage> UsageResult;

    string TodayText;

    // RoomUsage class is now in VacantRoomService.cs

    void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
        // 切换标签时清空结果
        if (tabIndex == 0)
        {
            UsageResult = null;
        }
        else
        {
            VacantResult = null;
        }
    }

    // —— 节次时间表（仅用于自动选择）——
    List<(TimeSpan Start, TimeSpan End, string Label)> PeriodSlots = new()
    {
        (new TimeSpan(8, 00, 00), new TimeSpan(9, 40, 00), "1-2节"),
        (new TimeSpan(9, 55, 00), new TimeSpan(11, 35, 00), "3-4节"),
        (new TimeSpan(13, 30, 00), new TimeSpan(15, 10, 00), "5-6节"),
        (new TimeSpan(15, 25, 00), new TimeSpan(17, 05, 00), "7-8节"),
        (new TimeSpan(18, 30, 00), new TimeSpan(20, 10, 00), "9-10节"),
    };

    void SetDefaultPeriodByNow()
    {
        DateTime now = DateTime.Now;
        TimeSpan t = now.TimeOfDay;

        // Check each time slot to see if current time falls within it
        for (int i = 0; i < PeriodSlots.Count; i++)
        {
            (TimeSpan Start, TimeSpan End, string Label) slot = PeriodSlots[i];

            // If current time is within this period, select it
            if (t >= slot.Start && t <= slot.End)
            {
                Period = slot.Label;  // Select current period, not next
                return;
            }
        }

        // If before first period (before 8:00), default to first period
        if (t < PeriodSlots[0].Start)
        {
            Period = PeriodSlots[0].Label; // "1-2节"
            return;
        }

        // If between periods or after all periods, find the next upcoming period
        for (int i = 0; i < PeriodSlots.Count - 1; i++)
        {
            if (t > PeriodSlots[i].End && t < PeriodSlots[i + 1].Start)
            {
                Period = PeriodSlots[i + 1].Label; // Next period
                return;
            }
        }

        // If after all periods (after 20:10), default to first period of next day
        Period = "1-2节";
    }

    void QueryVacantRooms()
    {
        VacantResult = VacantService.GetVacantRooms(Campus, Weekday, Period, Building, Week);
    }

    void QueryRoomUsage()
    {
        if (string.IsNullOrEmpty(RoomNumber)) return;

        // 调用服务获取教室使用情况
        UsageResult = VacantService.GetRoomUsage(RoomCampus, RoomBuilding + RoomNumber, RoomWeekday, RoomWeek);
    }

    void OnBuildingChanged(ChangeEventArgs e)
    {
        RoomBuilding = e.Value?.ToString() ?? "";
        RoomNumber = ""; // 清空教室号选择
    }

    List<string> GetRoomsForBuilding(string building)
    {
        // 使用服务获取实际的教室列表
        return VacantService.GetRoomsForBuilding(building);
    }

    protected override void OnInitialized()
    {
        var today = DateTime.Today.DayOfWeek;
        TodayText = DateTime.Today.ToString("D");

        string todayWeekday = today switch
        {
            DayOfWeek.Monday => "周一",
            DayOfWeek.Tuesday => "周二",
            DayOfWeek.Wednesday => "周三",
            DayOfWeek.Thursday => "周四",
            DayOfWeek.Friday => "周五",
            _ => "周一"
        };

        Weekday = todayWeekday;
        RoomWeekday = todayWeekday;

        DateTime week14Start = new DateTime(2025, 9, 8);
        int passedDays = (DateTime.Today - week14Start).Days;
        int weekOffset = passedDays / 7;
        int currentWeekNumber = 1 + weekOffset;

        if (currentWeekNumber < 1) currentWeekNumber = 1;
        if (currentWeekNumber > 18) currentWeekNumber = 18;

        Week = $"第{currentWeekNumber}周";
        RoomWeek = $"第{currentWeekNumber}周";

        SetDefaultPeriodByNow();
    }
}