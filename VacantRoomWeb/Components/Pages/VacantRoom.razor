@page "/"
@rendermode InteractiveServer
@inject VacantRoomService VacantService

<h3 style="margin-bottom: 1rem;">教室查询系统</h3>
<p style="font-size: 1.1rem; color: gray;">@TodayText</p>

<!-- Tab Navigation -->
<div style="margin-bottom: 2rem;">
    <button @onclick="() => SetActiveTab(0)"
            style="@GetTabStyle(0)">
        空教室查询
    </button>
    <button @onclick="() => SetActiveTab(1)"
            style="@GetTabStyle(1)">
        教室使用情况查询
    </button>
</div>

<div style="max-width: 500px;">

    @if (ActiveTab == 0)
    {
        <!-- 空教室查询 -->
        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">校区：</label>
            <select @bind="Campus" style="width: 200px;">
                <option value="奉贤校区">奉贤</option>
                <option value="徐汇校区">徐汇</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">星期：</label>
            <select @bind="Weekday" style="width: 200px;">
                <option>周一</option>
                <option>周二</option>
                <option>周三</option>
                <option>周四</option>
                <option>周五</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">节次：</label>
            <select @bind="Period" style="width: 200px;">
                <option>1-2节</option>
                <option>3-4节</option>
                <option>5-6节</option>
                <option>7-8节</option>
                <option>9-10节</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">教学楼：</label>
            <select @bind="Building" style="width: 200px;">
                <option>所有</option>
                <option>A</option>
                <option>B</option>
                <option>C</option>
                <option>D</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">第几周：</label>
            <select @bind="Week" style="width: 200px;">
                @for (int i = 1; i <= 18; i++)
                {
                    <option value="@($"第{i}周")">第 @i 周</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <button @onclick="QueryVacantRooms" style="padding: 8px 16px; font-weight: bold; background-color: #007bff; color: white; border: none; border-radius: 4px;">
                查询空教室
            </button>
        </div>

        <hr />

        <p style="color: red;">[Debug]当前选中： @Campus, @Weekday, @Period, @Building, @Week</p>

        @if (VacantResult != null)
        {
            <p style="color: orange;">[Debug]共查询到 @VacantResult.Count 个空教室</p>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 4px;">
                <ul style="margin: 0; padding-left: 20px;">
                    @foreach (var room in VacantResult)
                    {
                        <li>@room</li>
                    }
                </ul>
            </div>
        }
        else
        {
            <p style="color: gray;">请填写条件后点击查询</p>
        }
    }
    else
    {
        <!-- 教室使用情况查询 -->
        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">校区：</label>
            <select @bind="RoomCampus" style="width: 200px;">
                <option value="奉贤校区">奉贤</option>
                <option value="徐汇校区">徐汇</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">教学楼：</label>
            <select value="@RoomBuilding" @onchange="OnBuildingChanged" style="width: 200px;">
                <option value="">请选择教学楼</option>
                <option value="A">A楼</option>
                <option value="B">B楼</option>
                <option value="C">C楼</option>
                <option value="D">D楼</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">教室号：</label>
            <select @bind="RoomNumber" style="width: 200px;" disabled="@string.IsNullOrEmpty(RoomBuilding)">
                @if (string.IsNullOrEmpty(RoomBuilding))
                {
                    <option value="">请先选择教学楼</option>
                }
                else
                {
                    <option value="">请选择教室</option>
                    @foreach (var room in GetRoomsForBuilding(RoomBuilding))
                    {
                        <option value="@room">@room</option>
                    }
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">星期：</label>
            <select @bind="RoomWeekday" style="width: 200px;">
                <option>周一</option>
                <option>周二</option>
                <option>周三</option>
                <option>周四</option>
                <option>周五</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">第几周：</label>
            <select @bind="RoomWeek" style="width: 200px;">
                @for (int i = 1; i <= 18; i++)
                {
                    <option value="@($"第{i}周")">第 @i 周</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <button @onclick="QueryRoomUsage"
                    disabled="@string.IsNullOrEmpty(RoomNumber)"
                    style="padding: 8px 16px; font-weight: bold; background-color: #28a745; color: white; border: none; border-radius: 4px; opacity: @(string.IsNullOrEmpty(RoomNumber) ? "0.5" : "1");">
                查询教室使用情况
            </button>
        </div>

        <hr />

        <p style="color: red;">[Debug]当前选中： @RoomCampus, @RoomBuilding @RoomNumber, @RoomWeekday, @RoomWeek</p>

        @if (UsageResult != null)
        {
            <div style="border: 1px solid #ccc; border-radius: 4px; padding: 15px; background-color: #f8f9fa;">
                <h4 style="margin-top: 0; color: #495057;">@RoomBuilding@RoomNumber 教室使用情况</h4>
                <p style="color: #6c757d; margin-bottom: 15px;">@RoomCampus · @RoomWeekday · @RoomWeek</p>

                @if (UsageResult.Count == 0)
                {
                    <p style="color: green; font-weight: bold;">✅ 该教室当天全天空闲</p>
                }
                else
                {
                    <div style="display: grid; gap: 8px;">
                        @foreach (var usage in UsageResult)
                        {
                            <div style="background-color: white; padding: 12px; border-radius: 4px; border-left: 4px solid #dc3545;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: #dc3545;">@usage.Period</span>
                                    <span style="font-size: 0.9em; color: #6c757d;">@usage.TimeRange</span>
                                </div>
                                <div style="margin-top: 4px; color: #495057;">
                                    <strong>课程：</strong>@usage.CourseName
                                </div>
                                @if (!string.IsNullOrEmpty(usage.Teacher))
                                {
                                    <div style="font-size: 0.9em; color: #6c757d;">
                                        <strong>教师：</strong>@usage.Teacher
                                    </div>
                                }
                                
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <p style="color: gray;">请选择教室后点击查询</p>
        }
    }

</div>

<!-- ======= 备案信息页脚 BEGIN ======= -->
<footer class="text-center text-muted small py-3" style="white-space:nowrap;">
    ©@(DateTime.Now.Year) origami7023.cn&nbsp;|&nbsp;
    <a href="https://beian.miit.gov.cn/" target="_blank">
        沪ICP备2025129900号-1
    </a>
</footer>
<!-- ======= 备案信息页脚 END ======= -->
@code {
    // Tab management
    int ActiveTab = 0;

    // 空教室查询相关变量
    string Campus = "奉贤校区";
    string Weekday = "";
    string Period = "1-2节";
    string Building = "所有";
    string Week = "第1周";
    List<string> VacantResult;

    // 教室使用情况查询相关变量
    string RoomCampus = "奉贤校区";
    string RoomBuilding = "";
    string RoomNumber = "";
    string RoomWeekday = "";
    string RoomWeek = "第1周";
    List<VacantRoomWeb.RoomUsage> UsageResult;

    string TodayText;

    // RoomUsage class is now in VacantRoomService.cs

    void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
        // 切换标签时清空结果
        if (tabIndex == 0)
        {
            UsageResult = null;
        }
        else
        {
            VacantResult = null;
        }
    }

    string GetTabStyle(int tabIndex)
    {
        var baseStyle = "padding: 10px 20px; margin-right: 5px; border: 1px solid #ccc; border-radius: 4px 4px 0 0; cursor: pointer; background-color: ";
        return baseStyle + (ActiveTab == tabIndex ? "#007bff; color: white;" : "#f8f9fa; color: #495057;");
    }

    // —— 节次时间表（仅用于自动选择）——
    List<(TimeSpan Start, TimeSpan End, string Label)> PeriodSlots = new()
    {
        (new TimeSpan(8, 00, 00), new TimeSpan(9, 40, 00), "1-2节"),
        (new TimeSpan(9, 55, 00), new TimeSpan(11, 35, 00), "3-4节"),
        (new TimeSpan(13, 30, 00), new TimeSpan(15, 10, 00), "5-6节"),
        (new TimeSpan(15, 25, 00), new TimeSpan(17, 05, 00), "7-8节"),
        (new TimeSpan(18, 30, 00), new TimeSpan(20, 10, 00), "9-10节"),
    };

    void SetDefaultPeriodByNow()
    {
        DateTime now = DateTime.Now;
        TimeSpan t = now.TimeOfDay;

        // Check each time slot to see if current time falls within it
        for (int i = 0; i < PeriodSlots.Count; i++)
        {
            (TimeSpan Start, TimeSpan End, string Label) slot = PeriodSlots[i];

            // If current time is within this period, select it
            if (t >= slot.Start && t <= slot.End)
            {
                Period = slot.Label;  // Select current period, not next
                return;
            }
        }

        // If before first period (before 8:00), default to first period
        if (t < PeriodSlots[0].Start)
        {
            Period = PeriodSlots[0].Label; // "1-2节"
            return;
        }

        // If between periods or after all periods, find the next upcoming period
        for (int i = 0; i < PeriodSlots.Count - 1; i++)
        {
            if (t > PeriodSlots[i].End && t < PeriodSlots[i + 1].Start)
            {
                Period = PeriodSlots[i + 1].Label; // Next period
                return;
            }
        }

        // If after all periods (after 20:10), default to first period of next day
        Period = "1-2节";
    }

    void QueryVacantRooms()
    {
        VacantResult = VacantService.GetVacantRooms(Campus, Weekday, Period, Building, Week);
    }

    void QueryRoomUsage()
    {
        if (string.IsNullOrEmpty(RoomNumber)) return;

        // 调用服务获取教室使用情况
        UsageResult = VacantService.GetRoomUsage(RoomCampus, RoomBuilding + RoomNumber, RoomWeekday, RoomWeek);
    }

    void OnBuildingChanged(ChangeEventArgs e)
    {
        RoomBuilding = e.Value?.ToString() ?? "";
        RoomNumber = ""; // 清空教室号选择
    }

    List<string> GetRoomsForBuilding(string building)
    {
        // 使用服务获取实际的教室列表
        return VacantService.GetRoomsForBuilding(building);
    }

    protected override void OnInitialized()
    {
        var today = DateTime.Today.DayOfWeek;
        TodayText = DateTime.Today.ToString("D");

        string todayWeekday = today switch
        {
            DayOfWeek.Monday => "周一",
            DayOfWeek.Tuesday => "周二",
            DayOfWeek.Wednesday => "周三",
            DayOfWeek.Thursday => "周四",
            DayOfWeek.Friday => "周五",
            _ => "周一"
        };

        Weekday = todayWeekday;
        RoomWeekday = todayWeekday;

        DateTime week14Start = new DateTime(2025, 9, 8);
        int passedDays = (DateTime.Today - week14Start).Days;
        int weekOffset = passedDays / 7;
        int currentWeekNumber = 1 + weekOffset;

        if (currentWeekNumber < 1) currentWeekNumber = 1;
        if (currentWeekNumber > 18) currentWeekNumber = 18;

        Week = $"第{currentWeekNumber}周";
        RoomWeek = $"第{currentWeekNumber}周";

        SetDefaultPeriodByNow();
    }
}