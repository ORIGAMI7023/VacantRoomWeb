@page "/admin"
@rendermode InteractiveServer
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject EnhancedLoggingService LoggingService
@inject ConnectionCounterService ConnectionService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ApplicationStartupService StartupService
@inject IEmailService EmailService
@inject IConfiguration Configuration

<PageTitle>管理后台</PageTitle>

@if (!IsAuthenticated)
{
    <div class="loading-container">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>
}
else
{
    <div class="admin-dashboard">
        <div class="dashboard-header">
            <h1>管理后台</h1>
            <div class="header-actions">
                <span class="user-info">欢迎，管理员</span>
                <button @onclick="HandleLogout" class="btn btn-outline-secondary btn-sm">退出登录</button>
            </div>
        </div>

        <!-- 统计概览 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-content">
                    <h3>@CurrentConnections</h3>
                    <p>活跃连接数</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">🛡️</div>
                <div class="stat-content">
                    <h3>@SecurityStats["TotalBannedIPs"]</h3>
                    <p>已封禁IP</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">⚠️</div>
                <div class="stat-content">
                    <h3>@SecurityStats["RecentBreachAttempts"]</h3>
                    <p>近期攻击次数(24小时)</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <h3>@LogStats["TodayLogs"]</h3>
                    <p>今日日志总数</p>
                    <small>内存: @LogStats["MemoryLogs"] 条</small>
                </div>
            </div>
        </div>

        <!-- 系统状态 -->
        @if ((bool)SecurityStats["AdminPanelLocked"])
        {
            <div class="alert alert-warning">
                <strong>⚠️ 系统警告：</strong> 管理面板目前处于锁定状态，解锁时间：@SecurityStats["LockdownUntil"]
            </div>
        }

        <!-- 标签页导航 -->
        <div class="tab-navigation">
            <button @onclick="() => SetActiveTab(0)" class="tab-btn @(ActiveTab == 0 ? "active" : "")">
                📊 访问日志
            </button>
            <button @onclick="() => SetActiveTab(1)" class="tab-btn @(ActiveTab == 1 ? "active" : "")">
                🛡️ 安全事件
            </button>
            <button @onclick="() => SetActiveTab(2)" class="tab-btn @(ActiveTab == 2 ? "active" : "")">
                ⚙️ 系统信息
            </button>
            <button @onclick="() => SetActiveTab(3)" class="tab-btn @(ActiveTab == 3 ? "active" : "")">
                🗂️ 日志管理
            </button>
            <button @onclick="() => SetActiveTab(4)" class="tab-btn @(ActiveTab == 4 ? "active" : "")">
                📧 邮件管理
            </button>
        </div>

        <!-- 标签页内容 -->
        <div class="tab-content">
            @if (ActiveTab == 0)
            {
                <!-- 访问日志标签页 -->
                <div class="logs-section">
                    <div class="section-header">
                        <h3>最近访问日志</h3>
                        <div class="header-buttons">
                            <button @onclick="RefreshLogs" class="btn btn-primary btn-sm">🔄 刷新</button>
                            <button @onclick="ClearLogs" class="btn btn-warning btn-sm">🗑️ 清空内存日志</button>
                        </div>
                    </div>

                    <div class="logs-table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th class="time-header">时间</th>
                                    <th class="ip-header">IP地址</th>
                                    <th class="action-header">操作类型</th>
                                    <th class="details-header">详细信息</th>
                                    <th class="ua-header">用户代理</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in FilteredLogs.Take(50))
                                {
                                    <tr class="@GetLogRowClass(log.Action)">
                                        <td class="time-cell">@log.Timestamp.ToString("MM-dd HH:mm:ss")</td>
                                        <td class="ip-cell" title="点击复制IP地址">@log.IP</td>
                                        <td class="action-cell" title="@log.Action">@FormatActionType(log.Action)</td>
                                        <td class="details-cell" title="@log.Details">@log.Details</td>
                                        <td class="ua-cell" title="@log.UserAgent">@TruncateUserAgent(log.UserAgent)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else if (ActiveTab == 1)
            {
                <!-- 安全事件标签页 -->
                <div class="security-section">
                    <div class="section-header">
                        <h3>安全事件</h3>
                        <button @onclick="RefreshSecurity" class="btn btn-primary btn-sm">🔄 刷新</button>
                    </div>

                    <div class="security-events">
                        @foreach (var secEvent in SecurityEvents)
                        {
                            <div class="security-event @GetSecurityEventClass(secEvent.EventType)">
                                <div class="event-header">
                                    <span class="event-type">@secEvent.EventType</span>
                                    <span class="event-time">@secEvent.Timestamp.ToString("MM-dd HH:mm:ss")</span>
                                </div>
                                <div class="event-details">
                                    <strong>IP地址：</strong> @secEvent.IP<br />
                                    <strong>详细信息：</strong> @secEvent.Details
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (ActiveTab == 2)
            {
                <!-- 系统信息标签页 -->
                <div class="system-section">
                    <div class="section-header">
                        <h3>系统信息</h3>
                        <button @onclick="RefreshSystemInfo" class="btn btn-primary btn-sm">🔄 刷新</button>
                    </div>

                    <div class="info-grid">
                        <div class="info-card">
                            <h4>服务器状态</h4>
                            <p><strong>启动时间：</strong> @StartupService.GetApplicationStartTime().ToString("yyyy-MM-dd HH:mm:ss")</p>
                            <p><strong>运行时间：</strong> @StartupService.GetDetailedUptime()</p>
                            <p><strong>运行环境：</strong> @Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")</p>
                            <p><strong>服务器时间：</strong> @DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</p>
                            <p><strong>机器名称：</strong> @Environment.MachineName</p>
                            <p><strong>内存使用：</strong> @($"{Environment.WorkingSet / 1024 / 1024:F0} MB")</p>
                        </div>

                        <div class="info-card">
                            <h4>安全状态</h4>
                            <p><strong>活跃IP跟踪：</strong> @SecurityStats.GetValueOrDefault("ActiveIPTracking", "未知")</p>
                            <p><strong>面板锁定：</strong> @((bool)SecurityStats.GetValueOrDefault("AdminPanelLocked", false) ? "是" : "否")</p>
                            <p><strong>可用日志日期：</strong> @AvailableLogDates.Count 个</p>
                            <p><strong>当前连接数：</strong> @CurrentConnections</p>
                            <p><strong>已封禁IP：</strong> @SecurityStats.GetValueOrDefault("TotalBannedIPs", "0")</p>
                        </div>

                        <div class="info-card">
                            <h4>日志统计</h4>
                            <p><strong>今日日志总数：</strong> @LogStats.GetValueOrDefault("TodayLogs", "未知")</p>
                            <p><strong>内存日志数：</strong> @LogStats.GetValueOrDefault("MemoryLogs", "未知")</p>
                            <p><strong>今日唯一IP：</strong> @LogStats.GetValueOrDefault("TodayUniqueIPs", "未知")</p>
                            <p><strong>今日安全事件：</strong> @LogStats.GetValueOrDefault("TodaySecurityEvents", "未知")</p>
                            <p><strong>今日管理事件：</strong> @LogStats.GetValueOrDefault("TodayAdminEvents", "未知")</p>
                            <p><strong>日志文件大小：</strong> @LogStats.GetValueOrDefault("TodayLogFileSize", "未知")</p>
                        </div>
                    </div>
                </div>
            }
            else if (ActiveTab == 3)
            {
                <!-- 日志管理标签页 -->
                <div class="log-management-section">
                    <h3>日志管理</h3>

                    <div class="management-actions">
                        <div class="action-group">
                            <h4>日志过滤</h4>
                            <div class="filter-controls">
                                <select @bind="LogFilter" class="form-control">
                                    <option value="ALL">所有日志</option>
                                    <option value="SECURITY">安全事件</option>
                                    <option value="ADMIN">管理操作</option>
                                    <option value="ACCESS">页面访问</option>
                                    <option value="CONNECTION">连接事件</option>
                                </select>
                                <button @onclick="ApplyFilter" class="btn btn-primary btn-sm">应用过滤</button>
                            </div>
                        </div>

                        <div class="action-group">
                            <h4>日志维护</h4>
                            <div class="maintenance-controls">
                                <button @onclick="ClearLogs" class="btn btn-warning">清空内存日志</button>
                                <button @onclick="CleanupOldLogs" class="btn btn-danger">清理30天前日志文件</button>
                                <button @onclick="ExportLogs" class="btn btn-info">导出当日日志</button>
                            </div>
                        </div>

                        <div class="action-group">
                            <h4>日志文件</h4>
                            <div class="log-files">
                                @foreach (var fileInfo in LogFileInfo.Take(10))
                                {
                                    <div class="log-file-item">
                                        <div class="log-file-details">
                                            <span class="log-date">@fileInfo.Date</span>
                                            <span class="log-count">@fileInfo.Count 条</span>
                                            <span class="log-size">@fileInfo.Size</span>
                                        </div>
                                        <button @onclick="() => ViewLogFile(fileInfo.Date)" class="btn btn-sm btn-outline-primary">查看</button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (ActiveTab == 4)
            {
                <!-- 邮件管理标签页 -->
                <div class="email-management-section">
                    <div class="section-header">
                        <h3>邮件通知管理</h3>
                        <button @onclick="RefreshEmailStatus" class="btn btn-primary btn-sm">🔄 刷新状态</button>
                    </div>

                    <div class="email-stats">
                        <div class="stat-card">
                            <div class="stat-icon">📧</div>
                            <div class="stat-content">
                                <h3>@EmailStats["TotalSent"]</h3>
                                <p>邮件发送总数</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">✅</div>
                            <div class="stat-content">
                                <h3>@EmailStats["SuccessRate"]%</h3>
                                <p>成功发送率</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">⏰</div>
                            <div class="stat-content">
                                <h3>@EmailStats["LastSent"]</h3>
                                <p>最后发送时间</p>
                            </div>
                        </div>
                    </div>

                    <div class="email-actions">
                        <div class="action-group">
                            <h4>邮件服务测试</h4>
                            <div class="test-controls">
                                <button @onclick="TestEmailService"
                                        disabled="@IsEmailTesting"
                                        class="btn btn-primary">
                                    @if (IsEmailTesting)
                                    {
                                        <span>⏳ 测试中...</span>
                                    }
                                    else
                                    {
                                        <span>📧 发送测试邮件</span>
                                    }
                                </button>
                            </div>

                            @if (!string.IsNullOrEmpty(EmailTestResult))
                            {
                                <div class="test-result @(EmailTestSuccess ? "success" : "error")">
                                    @EmailTestResult
                                </div>
                            }
                        </div>

                        <div class="action-group">
                            <h4>邮件配置</h4>
                            <div class="config-display">
                                <p><strong>API地址：</strong> @EmailConfig["ApiUrl"]</p>
                                <p><strong>收件人：</strong> @EmailConfig["Recipient"]</p>
                                <p><strong>冷却时间：</strong> @EmailConfig["Cooldown"] 分钟</p>
                                <p>
                                    <strong>服务状态：</strong>
                                    <span class="@(EmailConfig["ServiceStatus"] == "正常" ? "status-ok" : "status-error")">
                                        @EmailConfig["ServiceStatus"]
                                    </span>
                                </p>
                            </div>
                        </div>

                        <div class="action-group">
                            <h4>安全警报设置</h4>
                            <div class="alert-settings">
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" @bind="EmailSettings.EnableDDoSAlerts" />
                                        DDoS攻击警报
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" @bind="EmailSettings.EnableBruteForceAlerts" />
                                        暴力破解警报
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" @bind="EmailSettings.EnableSystemLockdownAlerts" />
                                        系统锁定警报
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" @bind="EmailSettings.EnableIPBanAlerts" />
                                        IP封禁警报
                                    </label>
                                </div>

                                <button @onclick="SaveEmailSettings" class="btn btn-success btn-sm">💾 保存设置</button>
                            </div>
                        </div>

                        <div class="action-group">
                            <h4>手动发送通知</h4>
                            <div class="manual-send">
                                <div class="form-group">
                                    <label>主题：</label>
                                    <input @bind="ManualEmailSubject" class="form-control" placeholder="输入邮件主题" />
                                </div>
                                <div class="form-group">
                                    <label>内容：</label>
                                    <textarea @bind="ManualEmailContent" class="form-control" rows="4" placeholder="输入邮件内容"></textarea>
                                </div>
                                <button @onclick="SendManualEmail"
                                        disabled="@(string.IsNullOrEmpty(ManualEmailSubject) || IsEmailTesting)"
                                        class="btn btn-info">
                                    📤 发送通知邮件
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .admin-dashboard {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

        .dashboard-header h1 {
            color: #333;
            margin: 0;
        }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-info {
        color: #666;
        font-weight: 500;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .stat-icon {
        font-size: 2rem;
    }

    .stat-content h3 {
        margin: 0;
        font-size: 1.8rem;
        color: #333;
    }

    .stat-content p {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.9rem;
    }

    .tab-navigation {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 5px 5px 0 0;
        font-weight: 500;
        transition: all 0.3s;
    }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:not(.active):hover {
            background: #f8f9fa;
        }

    .tab-content {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
    }

    /* 优化的表格样式 */
    .logs-table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        background: white;
    }

    .logs-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        font-family: 'Consolas', 'Monaco', monospace;
    }

        .logs-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #5a67d8;
            font-size: 0.9rem;
        }

        .logs-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: top;
            word-break: break-word;
        }

        .logs-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .logs-table tr:hover {
            background-color: #e3f2fd;
            transition: background-color 0.2s;
        }

        /* 优化列宽 */
        .logs-table .time-cell {
            width: 140px;
            min-width: 140px;
            font-family: monospace;
            color: #495057;
            font-weight: 500;
        }

        .logs-table .ip-cell {
            width: 120px;
            min-width: 120px;
            font-family: monospace;
            color: #007bff;
            font-weight: 600;
        }

        .logs-table .action-cell {
            width: 180px;
            min-width: 180px;
            font-weight: 600;
        }

        .logs-table .details-cell {
            width: 300px;
            min-width: 250px;
            color: #6c757d;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .logs-table .ua-cell {
            width: 250px;
            min-width: 200px;
            color: #868e96;
            font-size: 0.75rem;
            line-height: 1.3;
        }

    /* 操作类型的颜色标识 */
    .security-row {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107;
    }

        .security-row .action-cell {
            color: #856404;
            font-weight: bold;
        }

    .error-row {
        background-color: #f8d7da !important;
        border-left: 4px solid #dc3545;
    }

        .error-row .action-cell {
            color: #721c24;
            font-weight: bold;
        }

    .access-row {
        background-color: #d1ecf1 !important;
        border-left: 4px solid #17a2b8;
    }

        .access-row .action-cell {
            color: #0c5460;
            font-weight: bold;
        }

    /* 默认行样式 */
    .logs-table tr:not(.security-row):not(.error-row):not(.access-row) {
        border-left: 4px solid #28a745;
    }

        .logs-table tr:not(.security-row):not(.error-row):not(.access-row) .action-cell {
            color: #155724;
            font-weight: bold;
        }

    /* 安全事件样式 */
    .security-events {
        max-height: 600px;
        overflow-y: auto;
    }

    .security-event {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
    }

        .security-event.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }

        .security-event.danger {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

    .event-header {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        margin-bottom: 8px;
    }

    /* 系统信息样式 */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .info-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

        .info-card h4 {
            margin-top: 0;
            color: #333;
        }

    /* 日志管理样式 */
    .management-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .action-group {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

        .action-group h4 {
            margin-top: 0;
            color: #333;
        }

    .filter-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .maintenance-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .log-files {
        max-height: 200px;
        overflow-y: auto;
    }

    .log-file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #dee2e6;
    }

    .log-file-details {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .log-date {
        font-family: monospace;
        font-weight: 600;
        min-width: 80px;
    }

    .log-count {
        font-size: 0.9em;
        color: #6c757d;
        min-width: 60px;
    }

    .log-size {
        font-size: 0.9em;
        color: #6c757d;
        min-width: 60px;
    }

    /* 邮件管理样式 */
    .email-management-section {
        padding: 20px;
    }

    .email-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .email-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .action-group {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

        .action-group h4 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

    .test-controls {
        margin: 15px 0;
    }

    .test-result {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        font-weight: 500;
    }

        .test-result.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-result.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

    .config-display {
        background: white;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

        .config-display p {
            margin: 8px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

    .status-ok {
        color: #28a745;
        font-weight: bold;
    }

    .status-error {
        color: #dc3545;
        font-weight: bold;
    }

    .alert-settings {
        background: white;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .setting-item {
        margin: 10px 0;
        display: flex;
        align-items: center;
    }

        .setting-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }

        .setting-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

    .manual-send {
        background: white;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .form-group {
        margin-bottom: 15px;
    }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }

    /* 按钮样式 */
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-outline-primary {
        background: transparent;
        color: #667eea;
        border: 1px solid #667eea;
    }

    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }

    .btn-success {
        background: #28a745;
        color: white;
        border: 1px solid #28a745;
    }

        .btn-success:hover:not(:disabled) {
            background: #218838;
            border-color: #1e7e34;
        }

    .btn-sm {
        padding: 5px 10px;
        font-size: 0.875rem;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* 警告框样式 */
    .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }


    {
        grid-template-columns: 1fr;
    }

    .email-stats {
        grid-template-columns: 1fr;
    }

    .action-group {
        padding: 15px;
    }

    }
</style>


@code {
    private bool IsAuthenticated = false;
    private int ActiveTab = 0;
    private int CurrentConnections = 0;
    private List<LogEntry> RecentLogs = new();
    private List<LogEntry> FilteredLogs = new();
    private List<SecurityEvent> SecurityEvents = new();
    private Dictionary<string, object> SecurityStats = new();
    private Dictionary<string, object> LogStats = new();
    private List<string> AvailableLogDates = new();
    private List<(string Date, int Count, string Size)> LogFileInfo = new();
    private DateTime StartTime = DateTime.Now;
    private string LogFilter = "ALL";
    private Timer? _refreshTimer;

    // 邮件管理相关变量
    private Dictionary<string, object> EmailStats = new();
    private Dictionary<string, string> EmailConfig = new();
    private EmailNotificationSettings EmailSettings = new();
    private bool IsEmailTesting = false;
    private string EmailTestResult = "";
    private bool EmailTestSuccess = false;
    private string ManualEmailSubject = "";
    private string ManualEmailContent = "";

    protected override async Task OnInitializedAsync()
    {
        IsAuthenticated = AuthService.IsAuthenticated();

        if (!IsAuthenticated)
        {
            Navigation.NavigateTo("/admin/login");
            return;
        }

        await LoadDashboardData();
        await LoadEmailData();

        // 设置定时刷新 - 每30秒自动刷新统计数据
        _refreshTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                LogStats = LoggingService.GetLogStats();
                SecurityStats = SecurityService.GetSecurityStats();
                CurrentConnections = ConnectionService.GetCount();
                await LoadEmailData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    private async Task LoadDashboardData()
    {
        CurrentConnections = ConnectionService.GetCount();
        RecentLogs = LoggingService.GetRecentLogs(100);
        FilteredLogs = RecentLogs;
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        LogStats = LoggingService.GetLogStats();
        AvailableLogDates = LoggingService.GetAvailableLogDates();
        LogFileInfo = LoggingService.GetLogFileInfo();

        StateHasChanged();
    }

    // 加载邮件相关数据
    private async Task LoadEmailData()
    {
        EmailStats = GetEmailStats();
        EmailConfig = GetEmailConfig();
        EmailSettings = GetEmailSettings();
    }

    // 获取邮件统计信息
    private Dictionary<string, object> GetEmailStats()
    {
        var recentLogs = LoggingService.GetRecentLogs(1000);
        var emailLogs = recentLogs.Where(l => l.Action.Contains("EMAIL") || l.Action.Contains("ALERT")).ToList();

        var totalSent = emailLogs.Count;
        var successCount = emailLogs.Count(l => !l.Details.Contains("失败") && !l.Details.Contains("error"));
        var successRate = totalSent > 0 ? (successCount * 100 / totalSent) : 100;

        var lastSent = emailLogs.OrderByDescending(l => l.Timestamp).FirstOrDefault()?.Timestamp.ToString("MM-dd HH:mm") ?? "未发送";

        return new Dictionary<string, object>
        {
            ["TotalSent"] = totalSent,
            ["SuccessRate"] = successRate,
            ["LastSent"] = lastSent
        };
    }

    // 获取邮件配置信息
    private Dictionary<string, string> GetEmailConfig()
    {
        var apiUrl = Configuration["Email:NotifyHubAPI:BaseUrl"] ?? "未配置";
        var recipient = Configuration["Email:DefaultRecipient"] ?? "未配置";

        return new Dictionary<string, string>
        {
            ["ApiUrl"] = apiUrl,
            ["Recipient"] = recipient,
            ["Cooldown"] = "5",
            ["ServiceStatus"] = "正常"
        };
    }

    // 获取邮件通知设置
    private EmailNotificationSettings GetEmailSettings()
    {
        return new EmailNotificationSettings
        {
            EnableDDoSAlerts = true,
            EnableBruteForceAlerts = true,
            EnableSystemLockdownAlerts = true,
            EnableIPBanAlerts = true
        };
    }

    // 测试邮件服务
    private async Task TestEmailService()
    {
        IsEmailTesting = true;
        EmailTestResult = "";
        StateHasChanged();

        try
        {
            var success = await EmailService.TestEmailServiceAsync();

            if (success)
            {
                EmailTestResult = "✅ 邮件服务测试成功！测试邮件已发送到 " + (Configuration["Email:DefaultRecipient"] ?? "未知邮箱");
                EmailTestSuccess = true;
            }
            else
            {
                EmailTestResult = "❌ 邮件服务测试失败，请检查配置和网络连接";
                EmailTestSuccess = false;
            }
        }
        catch (Exception ex)
        {
            EmailTestResult = $"❌ 邮件服务测试异常：{ex.Message}";
            EmailTestSuccess = false;
        }
        finally
        {
            IsEmailTesting = false;
            StateHasChanged();
        }
    }

    // 刷新邮件状态
    private async Task RefreshEmailStatus()
    {
        await LoadEmailData();
        StateHasChanged();
    }

    // 保存邮件设置
    private async Task SaveEmailSettings()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("alert", "邮件设置已保存");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"保存失败：{ex.Message}");
        }
    }

    // 发送手动邮件
    private async Task SendManualEmail()
    {
        if (string.IsNullOrEmpty(ManualEmailSubject) || string.IsNullOrEmpty(ManualEmailContent))
        {
            await JSRuntime.InvokeVoidAsync("alert", "请填写邮件主题和内容");
            return;
        }

        IsEmailTesting = true;
        StateHasChanged();

        try
        {
            var success = await EmailService.SendSystemNotificationAsync(ManualEmailSubject, ManualEmailContent);

            if (success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "邮件发送成功！");
                ManualEmailSubject = "";
                ManualEmailContent = "";
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "邮件发送失败，请检查配置");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"邮件发送异常：{ex.Message}");
        }
        finally
        {
            IsEmailTesting = false;
            StateHasChanged();
        }
    }

    private void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
    }

    private async Task RefreshLogs()
    {
        RecentLogs = LoggingService.GetRecentLogs(100);
        ApplyFilter();
        StateHasChanged();
    }

    private async Task RefreshSecurity()
    {
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        StateHasChanged();
    }

    private async Task RefreshStats()
    {
        LogStats = LoggingService.GetLogStats();
        SecurityStats = SecurityService.GetSecurityStats();
        CurrentConnections = ConnectionService.GetCount();
        StateHasChanged();
    }

    private async Task ClearLogs()
    {
        LoggingService.ClearRecentLogs();
        await RefreshLogs();
    }

    private async Task CleanupOldLogs()
    {
        LoggingService.CleanupOldLogs(30);
        AvailableLogDates = LoggingService.GetAvailableLogDates();
        StateHasChanged();
    }

    private async Task ExportLogs()
    {
        var today = DateTime.Now.ToString("yyyy-MM-dd");
        await JSRuntime.InvokeVoidAsync("alert", $"导出功能开发中，将导出 {today} 的日志文件");
    }

    private async Task ViewLogFile(string date)
    {
        await JSRuntime.InvokeVoidAsync("alert", $"查看功能开发中，将显示 {date} 的日志内容");
    }

    private void ApplyFilter()
    {
        FilteredLogs = LogFilter switch
        {
            "SECURITY" => RecentLogs.Where(l => l.Action.StartsWith("SECURITY_")).ToList(),
            "ADMIN" => RecentLogs.Where(l => l.Action.Contains("ADMIN")).ToList(),
            "ACCESS" => RecentLogs.Where(l => l.Action == "ACCESS").ToList(),
            "CONNECTION" => RecentLogs.Where(l => l.Action.Contains("CONNECTION")).ToList(),
            _ => RecentLogs
        };
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        try
        {
            await AuthService.SignOutAsync(JSRuntime);
            await JSRuntime.InvokeVoidAsync("location.replace", "/admin/login");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Logout error: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("location.replace", "/admin/login");
        }
    }

    private string GetLogRowClass(string action)
    {
        if (action.StartsWith("SECURITY_")) return "security-row";
        if (action.StartsWith("ERROR_")) return "error-row";
        if (action == "ACCESS") return "access-row";
        return "";
    }

    private string GetSecurityEventClass(string eventType)
    {
        if (eventType.Contains("BRUTE_FORCE") || eventType.Contains("DDOS") || eventType.Contains("BANNED"))
            return "danger";
        return "warning";
    }

    private string TruncateUserAgent(string userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "N/A";
        return userAgent.Length > 30 ? userAgent.Substring(0, 30) + "..." : userAgent;
    }

    private string GetUptime()
    {
        var uptime = DateTime.Now - StartTime;
        return $"{uptime.Days}d {uptime.Hours}h {uptime.Minutes}m";
    }

    private string FormatActionType(string action)
    {
        return action switch
        {
            "ACCESS" => "页面访问",
            "BLAZOR_CONNECTION_UP" => "连接建立",
            "BLAZOR_CONNECTION_DOWN" => "连接断开",
            "LOCALHOST_ADMIN_ACCESS" => "本地管理访问",
            "ADMIN_SUBDOMAIN_ACCESS" => "管理域名访问",
            "ADMIN_SUBDOMAIN_REDIRECT" => "管理域名重定向",
            "ADMIN_PATH_REWRITE" => "路径重写",
            "ADMIN_ACCESS_BLOCKED" => "管理访问被阻止",
            "ACCESS_DENIED_BANNED" => "访问被拒绝(IP封禁)",
            "ACCESS_DENIED_LOCKDOWN" => "访问被拒绝(系统锁定)",
            "SECURITY_DDOS_DETECTED" => "检测到DDoS攻击",
            "SECURITY_BRUTE_FORCE_DETECTED" => "检测到暴力破解",
            "SECURITY_IP_BANNED" => "IP地址被封禁",
            "SECURITY_ADMIN_LOCKDOWN" => "管理面板锁定",
            "ADMIN_LOGIN_SUCCESS" => "管理员登录成功",
            "ADMIN_LOGIN_FAILED" => "管理员登录失败",
            "ADMIN_LOGOUT" => "管理员退出登录",
            "ADMIN_AUTH_COOKIE_SET" => "设置认证Cookie",
            "EMAIL_ALERT_TRIGGERED" => "邮件警报触发",
            "QUERY_VACANT_ROOMS" => "查询空教室",
            "QUERY_ROOM_USAGE" => "查询教室使用情况",
            "QUERY_RESULT" => "查询结果",
            "ERROR_FILE_NOT_FOUND" => "文件未找到错误",
            _ => action
        };
    }

    private async Task RefreshSystemInfo()
    {
        LogStats = LoggingService.GetLogStats();
        SecurityStats = SecurityService.GetSecurityStats();
        CurrentConnections = ConnectionService.GetCount();
        AvailableLogDates = LoggingService.GetAvailableLogDates();
        StateHasChanged();
    }
}