@page "/admin"
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject EnhancedLoggingService LoggingService
@inject ConnectionCounterService ConnectionService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Admin Dashboard</PageTitle>

@if (!IsAuthenticated)
{
    <div class="loading-container">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="admin-dashboard">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <div class="header-actions">
                <span class="user-info">Welcome, Admin</span>
                <button @onclick="HandleLogout" class="btn btn-outline-secondary btn-sm">Logout</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-content">
                    <h3>@CurrentConnections</h3>
                    <p>Active Connections</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">🛡️</div>
                <div class="stat-content">
                    <h3>@SecurityStats["TotalBannedIPs"]</h3>
                    <p>Banned IPs</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">⚠️</div>
                <div class="stat-content">
                    <h3>@SecurityStats["RecentBreachAttempts"]</h3>
                    <p>Recent Attacks (24h)</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <h3>@RecentLogs.Count</h3>
                    <p>Recent Log Entries</p>
                </div>
            </div>
        </div>

        <!-- System Status -->
        @if ((bool)SecurityStats["AdminPanelLocked"])
        {
            <div class="alert alert-warning">
                <strong>⚠️ System Alert:</strong> Admin panel is currently under lockdown until @SecurityStats["LockdownUntil"]
            </div>
        }

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button @onclick="() => SetActiveTab(0)" class="tab-btn @(ActiveTab == 0 ? "active" : "")">
                📊 Access Logs
            </button>
            <button @onclick="() => SetActiveTab(1)" class="tab-btn @(ActiveTab == 1 ? "active" : "")">
                🛡️ Security Events
            </button>
            <button @onclick="() => SetActiveTab(2)" class="tab-btn @(ActiveTab == 2 ? "active" : "")">
                ⚙️ System Info
            </button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            @if (ActiveTab == 0)
            {
                <!-- Access Logs Tab -->
                <div class="logs-section">
                    <div class="section-header">
                        <h3>Recent Access Logs</h3>
                        <button @onclick="RefreshLogs" class="btn btn-primary btn-sm">🔄 Refresh</button>
                    </div>

                    <div class="logs-table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>IP Address</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>User Agent</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in RecentLogs.Take(50))
                                {
                                    <tr class="@GetLogRowClass(log.Action)">
                                        <td class="time-cell">@log.Timestamp.ToString("MM-dd HH:mm:ss")</td>
                                        <td class="ip-cell">@log.IP</td>
                                        <td class="action-cell">@log.Action</td>
                                        <td class="details-cell">@log.Details</td>
                                        <td class="ua-cell" title="@log.UserAgent">@TruncateUserAgent(log.UserAgent)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else if (ActiveTab == 1)
            {
                <!-- Security Events Tab -->
                <div class="security-section">
                    <div class="section-header">
                        <h3>Security Events</h3>
                        <button @onclick="RefreshSecurity" class="btn btn-primary btn-sm">🔄 Refresh</button>
                    </div>

                    <div class="security-events">
                        @foreach (var secEvent in SecurityEvents)
                        {
                            <div class="security-event @GetSecurityEventClass(secEvent.EventType)">
                                <div class="event-header">
                                    <span class="event-type">@secEvent.EventType</span>
                                    <span class="event-time">@secEvent.Timestamp.ToString("MM-dd HH:mm:ss")</span>
                                </div>
                                <div class="event-details">
                                    <strong>IP:</strong> @secEvent.IP<br />
                                    <strong>Details:</strong> @secEvent.Details
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (ActiveTab == 2)
            {
                <!-- System Info Tab -->
                <div class="system-section">
                    <h3>System Information</h3>

                    <div class="info-grid">
                        <div class="info-card">
                            <h4>Server Status</h4>
                            <p><strong>Uptime:</strong> @GetUptime()</p>
                            <p><strong>Environment:</strong> @Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")</p>
                            <p><strong>Server Time:</strong> @DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</p>
                        </div>

                        <div class="info-card">
                            <h4>Security Status</h4>
                            <p><strong>Active IP Tracking:</strong> @SecurityStats["ActiveIPTracking"]</p>
                            <p><strong>Panel Locked:</strong> @((bool)SecurityStats["AdminPanelLocked"] ? "Yes" : "No")</p>
                            <p><strong>Available Log Dates:</strong> @AvailableLogDates.Count</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .admin-dashboard {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

        .dashboard-header h1 {
            color: #333;
            margin: 0;
        }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-info {
        color: #666;
        font-weight: 500;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .stat-icon {
        font-size: 2rem;
    }

    .stat-content h3 {
        margin: 0;
        font-size: 1.8rem;
        color: #333;
    }

    .stat-content p {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.9rem;
    }

    .tab-navigation {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 5px 5px 0 0;
        font-weight: 500;
        transition: all 0.3s;
    }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:not(.active):hover {
            background: #f8f9fa;
        }

    .tab-content {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .logs-table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
    }

    .logs-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

        .logs-table th,
        .logs-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .logs-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .logs-table .time-cell {
            width: 120px;
        }

        .logs-table .ip-cell {
            width: 120px;
        }

        .logs-table .action-cell {
            width: 150px;
        }

        .logs-table .details-cell {
            width: 200px;
        }

        .logs-table .ua-cell {
            width: 150px;
        }

    .security-row {
        background-color: #fff3cd;
    }

    .error-row {
        background-color: #f8d7da;
    }

    .access-row {
        background-color: #d1ecf1;
    }

    .security-events {
        max-height: 600px;
        overflow-y: auto;
    }

    .security-event {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
    }

        .security-event.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }

        .security-event.danger {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

    .event-header {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .info-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

        .info-card h4 {
            margin-top: 0;
            color: #333;
        }

    .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 0.875rem;
    }
</style>

@code {
    private bool IsAuthenticated = false;
    private int ActiveTab = 0;
    private int CurrentConnections = 0;
    private List<LogEntry> RecentLogs = new();
    private List<SecurityEvent> SecurityEvents = new();
    private Dictionary<string, object> SecurityStats = new();
    private List<string> AvailableLogDates = new();
    private DateTime StartTime = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        IsAuthenticated = AuthService.IsAuthenticated();

        if (!IsAuthenticated)
        {
            Navigation.NavigateTo("/admin/login");
            return;
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        CurrentConnections = ConnectionService.GetCount();
        RecentLogs = LoggingService.GetRecentLogs(100);
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        AvailableLogDates = LoggingService.GetAvailableLogDates();

        StateHasChanged();
    }

    private void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
    }

    private async Task RefreshLogs()
    {
        RecentLogs = LoggingService.GetRecentLogs(100);
        StateHasChanged();
    }

    private async Task RefreshSecurity()
    {
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        AuthService.SignOut();
        await JSRuntime.InvokeVoidAsync("location.replace", "/admin/login");
    }

    private string GetLogRowClass(string action)
    {
        if (action.StartsWith("SECURITY_")) return "security-row";
        if (action.StartsWith("ERROR_")) return "error-row";
        if (action == "ACCESS") return "access-row";
        return "";
    }

    private string GetSecurityEventClass(string eventType)
    {
        if (eventType.Contains("BRUTE_FORCE") || eventType.Contains("DDOS") || eventType.Contains("BANNED"))
            return "danger";
        return "warning";
    }

    private string TruncateUserAgent(string userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "N/A";
        return userAgent.Length > 30 ? userAgent.Substring(0, 30) + "..." : userAgent;
    }

    private string GetUptime()
    {
        var uptime = DateTime.Now - StartTime;
        return $"{uptime.Days}d {uptime.Hours}h {uptime.Minutes}m";
    }
}