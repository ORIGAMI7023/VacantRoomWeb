@page "/admin"
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject EnhancedLoggingService LoggingService
@inject ConnectionCounterService ConnectionService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>管理后台</PageTitle>

@if (!IsAuthenticated)
{
    <div class="loading-container">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>
}
else
{
    <div class="admin-dashboard">
        <div class="dashboard-header">
            <h1>管理后台</h1>
            <div class="header-actions">
                <span class="user-info">欢迎，管理员</span>
                <button @onclick="HandleLogout" class="btn btn-outline-secondary btn-sm">退出登录</button>
            </div>
        </div>

        <!-- 统计概览 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-content">
                    <h3>@CurrentConnections</h3>
                    <p>活跃连接数</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">🛡️</div>
                <div class="stat-content">
                    <h3>@SecurityStats["TotalBannedIPs"]</h3>
                    <p>已封禁IP</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">⚠️</div>
                <div class="stat-content">
                    <h3>@SecurityStats["RecentBreachAttempts"]</h3>
                    <p>近期攻击次数(24小时)</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <h3>@RecentLogs.Count</h3>
                    <p>最近日志条目</p>
                </div>
            </div>
        </div>

        <!-- 系统状态 -->
        @if ((bool)SecurityStats["AdminPanelLocked"])
        {
            <div class="alert alert-warning">
                <strong>⚠️ 系统警告：</strong> 管理面板目前处于锁定状态，解锁时间：@SecurityStats["LockdownUntil"]
            </div>
        }

        <!-- 标签页导航 -->
        <div class="tab-navigation">
            <button @onclick="() => SetActiveTab(0)" class="tab-btn @(ActiveTab == 0 ? "active" : "")">
                📊 访问日志
            </button>
            <button @onclick="() => SetActiveTab(1)" class="tab-btn @(ActiveTab == 1 ? "active" : "")">
                🛡️ 安全事件
            </button>
            <button @onclick="() => SetActiveTab(2)" class="tab-btn @(ActiveTab == 2 ? "active" : "")">
                ⚙️ 系统信息
            </button>
        </div>

        <!-- 标签页内容 -->
        <div class="tab-content">
            @if (ActiveTab == 0)
            {
                <!-- 访问日志标签页 -->
                <div class="logs-section">
                    <div class="section-header">
                        <h3>最近访问日志</h3>
                        <button @onclick="RefreshLogs" class="btn btn-primary btn-sm">🔄 刷新</button>
                    </div>

                    <div class="logs-table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th class="time-header">时间</th>
                                    <th class="ip-header">IP地址</th>
                                    <th class="action-header">操作类型</th>
                                    <th class="details-header">详细信息</th>
                                    <th class="ua-header">用户代理</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in RecentLogs.Take(50))
                                {
                                    <tr class="@GetLogRowClass(log.Action)">
                                        <td class="time-cell">@log.Timestamp.ToString("MM-dd HH:mm:ss")</td>
                                        <td class="ip-cell" title="点击复制IP地址">@log.IP</td>
                                        <td class="action-cell" title="@log.Action">@FormatActionType(log.Action)</td>
                                        <td class="details-cell" title="@log.Details">@log.Details</td>
                                        <td class="ua-cell" title="@log.UserAgent">@TruncateUserAgent(log.UserAgent)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else if (ActiveTab == 1)
            {
                <!-- 安全事件标签页 -->
                <div class="security-section">
                    <div class="section-header">
                        <h3>安全事件</h3>
                        <button @onclick="RefreshSecurity" class="btn btn-primary btn-sm">🔄 刷新</button>
                    </div>

                    <div class="security-events">
                        @foreach (var secEvent in SecurityEvents)
                        {
                            <div class="security-event @GetSecurityEventClass(secEvent.EventType)">
                                <div class="event-header">
                                    <span class="event-type">@secEvent.EventType</span>
                                    <span class="event-time">@secEvent.Timestamp.ToString("MM-dd HH:mm:ss")</span>
                                </div>
                                <div class="event-details">
                                    <strong>IP地址：</strong> @secEvent.IP<br />
                                    <strong>详细信息：</strong> @secEvent.Details
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (ActiveTab == 2)
            {
                <!-- 系统信息标签页 -->
                <div class="system-section">
                    <h3>系统信息</h3>

                    <div class="info-grid">
                        <div class="info-card">
                            <h4>服务器状态</h4>
                            <p><strong>运行时间：</strong> @GetUptime()</p>
                            <p><strong>运行环境：</strong> @Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")</p>
                            <p><strong>服务器时间：</strong> @DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</p>
                        </div>

                        <div class="info-card">
                            <h4>安全状态</h4>
                            <p><strong>活跃IP跟踪：</strong> @SecurityStats["ActiveIPTracking"]</p>
                            <p><strong>面板锁定：</strong> @((bool)SecurityStats["AdminPanelLocked"] ? "是" : "否")</p>
                            <p><strong>可用日志日期：</strong> @AvailableLogDates.Count 个</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}


@code {
    private bool IsAuthenticated = false;
    private int ActiveTab = 0;
    private int CurrentConnections = 0;
    private List<LogEntry> RecentLogs = new();
    private List<SecurityEvent> SecurityEvents = new();
    private Dictionary<string, object> SecurityStats = new();
    private List<string> AvailableLogDates = new();
    private DateTime StartTime = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        IsAuthenticated = AuthService.IsAuthenticated();

        if (!IsAuthenticated)
        {
            Navigation.NavigateTo("/admin/login");
            return;
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        CurrentConnections = ConnectionService.GetCount();
        RecentLogs = LoggingService.GetRecentLogs(100);
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        AvailableLogDates = LoggingService.GetAvailableLogDates();

        StateHasChanged();
    }

    private void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
    }

    private async Task RefreshLogs()
    {
        RecentLogs = LoggingService.GetRecentLogs(100);
        StateHasChanged();
    }

    private async Task RefreshSecurity()
    {
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        AuthService.SignOut();
        await JSRuntime.InvokeVoidAsync("location.replace", "/admin/login");
    }

    private string GetLogRowClass(string action)
    {
        if (action.StartsWith("SECURITY_")) return "security-row";
        if (action.StartsWith("ERROR_")) return "error-row";
        if (action == "ACCESS") return "access-row";
        return "";
    }

    private string GetSecurityEventClass(string eventType)
    {
        if (eventType.Contains("BRUTE_FORCE") || eventType.Contains("DDOS") || eventType.Contains("BANNED"))
            return "danger";
        return "warning";
    }

    private string TruncateUserAgent(string userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "N/A";
        return userAgent.Length > 30 ? userAgent.Substring(0, 30) + "..." : userAgent;
    }

    private string GetUptime()
    {
        var uptime = DateTime.Now - StartTime;
        return $"{uptime.Days}d {uptime.Hours}h {uptime.Minutes}m";
    }

    private string FormatActionType(string action)
    {
        return action switch
        {
            "ACCESS" => "页面访问",
            "BLAZOR_CONNECTION_UP" => "连接建立",
            "BLAZOR_CONNECTION_DOWN" => "连接断开",
            "LOCALHOST_ADMIN_ACCESS" => "本地管理访问",
            "ADMIN_SUBDOMAIN_ACCESS" => "管理域名访问",
            "ADMIN_PATH_REWRITE" => "路径重写",
            "ADMIN_ACCESS_BLOCKED" => "管理访问被阻止",
            "ACCESS_DENIED_BANNED" => "访问被拒绝(IP封禁)",
            "ACCESS_DENIED_LOCKDOWN" => "访问被拒绝(系统锁定)",
            "SECURITY_DDOS_DETECTED" => "检测到DDoS攻击",
            "SECURITY_BRUTE_FORCE_DETECTED" => "检测到暴力破解",
            "SECURITY_IP_BANNED" => "IP地址被封禁",
            "SECURITY_ADMIN_LOCKDOWN" => "管理面板锁定",
            "ADMIN_LOGIN_SUCCESS" => "管理员登录成功",
            "ADMIN_LOGIN_FAILED" => "管理员登录失败",
            "ADMIN_LOGOUT" => "管理员退出登录",
            "ADMIN_AUTH_COOKIE_SET" => "设置认证Cookie",
            "EMAIL_ALERT_TRIGGERED" => "邮件警报触发",
            "QUERY_VACANT_ROOMS" => "查询空教室",
            "QUERY_ROOM_USAGE" => "查询教室使用情况",
            "QUERY_RESULT" => "查询结果",
            "ERROR_FILE_NOT_FOUND" => "文件未找到错误",
            _ => action // 如果没有匹配的，返回原始值
        };
    }
}