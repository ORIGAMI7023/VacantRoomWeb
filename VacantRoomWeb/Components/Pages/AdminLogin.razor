@page "/admin/login"
@rendermode InteractiveServer
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Admin Login</PageTitle>

<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc;">
    <h2>Admin Login</h2>

    <div style="margin-bottom: 15px;">
        <label>Username:</label><br />
        <input @bind="Username" @oninput="OnUsernameInput" type="text" style="width: 100%; padding: 8px;" />
    </div>

    <div style="margin-bottom: 15px;">
        <label>Password:</label><br />
        <input @bind="Password" @oninput="OnPasswordInput" type="password" style="width: 100%; padding: 8px;" />
    </div>

    <button @onclick="LoginTest" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; margin: 5px 0;">
        登录
    </button>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; margin-top: 15px; max-height: 300px; overflow-y: auto;">
            <pre style="white-space: pre-wrap; font-size: 12px; margin: 0;">@Message</pre>
        </div>
    }
</div>

<style>
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .admin-dashboard {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

        .dashboard-header h1 {
            color: #333;
            margin: 0;
        }

    /* 这里添加我之前提供的所有表格优化样式 */
    .logs-table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        background: white;
    }

    .logs-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        font-family: 'Consolas', 'Monaco', monospace;
    }

        .logs-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #5a67d8;
            font-size: 0.9rem;
        }

</style>

@code {
    private string Username = "";
    private string Password = "";
    private string Message = "";

    protected override async Task OnInitializedAsync()
    {
        // 检查管理面板锁定状态
        if (SecurityService.IsAdminPanelLocked())
        {
            Message = "⚠️ 管理面板已锁定";
            return;
        }

        // 如果已认证，跳转到仪表板
        if (AuthService.IsAuthenticated())
        {
            await Task.Delay(100);
            Navigation.NavigateTo("/admin", true);
        }
    }

    private void OnUsernameInput(ChangeEventArgs e)
    {
        Username = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private void OnPasswordInput(ChangeEventArgs e)
    {
        Password = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private async Task LoginTest()
    {
        if (SecurityService.IsAdminPanelLocked())
        {
            Message = "⚠️ 管理面板已锁定";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrEmpty(Username) || string.IsNullOrEmpty(Password))
        {
            Message = "请输入用户名和密码";
            StateHasChanged();
            return;
        }

        try
        {
            var result = AuthService.ValidateCredentials(Username, Password);

            if (result)
            {
                try
                {
                    await AuthService.SetAuthCookieAsync(Username, JSRuntime);
                    Navigation.NavigateTo("/admin", forceLoad: true);
                }
                catch (Exception cookieEx)
                {
                    Message = $"Cookie设置失败: {cookieEx.Message}";
                    StateHasChanged();
                    return;
                }
            }
            else
            {
                Message = "登录失败";
                Password = "";
            }
        }
        catch (Exception ex)
        {
            Message = $"登录异常: {ex.Message}";
        }

        StateHasChanged();
    }
}