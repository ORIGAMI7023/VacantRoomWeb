@page "/admin/login"
@rendermode InteractiveServer
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Admin Login</PageTitle>

<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc;">
    <h2>Admin Login</h2>

    <div style="margin-bottom: 15px;">
        <label>Username:</label><br />
        <input @bind="Username" @oninput="OnUsernameInput" type="text" style="width: 100%; padding: 8px;" />
    </div>

    <div style="margin-bottom: 15px;">
        <label>Password:</label><br />
        <input @bind="Password" @oninput="OnPasswordInput" type="password" style="width: 100%; padding: 8px;" />
    </div>

    <button @onclick="LoginTest" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; margin: 5px 0;">
        登录
    </button>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; margin-top: 15px; max-height: 300px; overflow-y: auto;">
            <pre style="white-space: pre-wrap; font-size: 12px; margin: 0;">@Message</pre>
        </div>
    }
</div>

<style>
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .admin-dashboard {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

        .dashboard-header h1 {
            color: #333;
            margin: 0;
        }

    /* 这里添加我之前提供的所有表格优化样式 */
    .logs-table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        background: white;
    }

    .logs-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        font-family: 'Consolas', 'Monaco', monospace;
    }

        .logs-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #5a67d8;
            font-size: 0.9rem;
        }

</style>

@code {
    private string Username = "";
    private string Password = "";
    private string Message = "";

    protected override async Task OnInitializedAsync()
    {
        // 检查管理面板锁定状态
        if (SecurityService.IsAdminPanelLocked())
        {
            Message = "⚠️ 管理面板已锁定";
            return;
        }

        // 如果已认证，跳转到仪表板
        if (AuthService.IsAuthenticated())
        {
            await Task.Delay(100);
            Navigation.NavigateTo("/admin", true);
        }
    }

    private void OnUsernameInput(ChangeEventArgs e)
    {
        Username = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private void OnPasswordInput(ChangeEventArgs e)
    {
        Password = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private async Task LoginTest()
    {
        Message = "开始登录验证...";
        StateHasChanged();

        try
        {
            // 1. 检查各个服务是否正常注入
            if (AuthService == null)
            {
                Message = "错误：AuthService 未注入";
                StateHasChanged();
                return;
            }

            if (SecurityService == null)
            {
                Message = "错误：SecurityService 未注入";
                StateHasChanged();
                return;
            }

            Message = "服务注入正常，检查管理面板状态...";
            StateHasChanged();

            // 2. 检查管理面板是否锁定
            bool isLocked = false;
            try
            {
                isLocked = SecurityService.IsAdminPanelLocked();
            }
            catch (Exception ex)
            {
                Message = $"检查管理面板状态时出错：{ex.Message}";
                StateHasChanged();
                return;
            }

            if (isLocked)
            {
                Message = "管理面板已锁定";
                StateHasChanged();
                return;
            }

            Message = "管理面板状态正常，检查输入...";
            StateHasChanged();

            // 3. 检查用户输入
            if (string.IsNullOrEmpty(Username) || string.IsNullOrEmpty(Password))
            {
                Message = "请输入用户名和密码";
                StateHasChanged();
                return;
            }

            Message = "输入验证通过，开始验证凭据...";
            StateHasChanged();

            // 4. 验证凭据
            // 4. 验证凭据
            bool result = false;
            try
            {
                // 添加调试信息
                Message = $"正在验证用户名: '{Username}' 和密码...";
                StateHasChanged();
                await Task.Delay(500); // 让用户看到这条消息

                result = AuthService.ValidateCredentials(Username, Password);
            }
            catch (Exception ex)
            {
                Message = $"验证凭据时出错：{ex.Message}\n\n堆栈跟踪：{ex.StackTrace}";
                StateHasChanged();
                return;
            }

            Message = $"凭据验证结果：{(result ? "成功" : "失败")}";
            StateHasChanged();

            if (result)
            {
                try
                {
                    Message = "凭据验证成功，设置认证Cookie...";
                    StateHasChanged();

                    await AuthService.SetAuthCookieAsync(Username, JSRuntime);

                    Message = "Cookie设置成功，准备跳转...";
                    StateHasChanged();

                    await Task.Delay(500);
                    Navigation.NavigateTo("/admin", forceLoad: true);
                }
                catch (Exception cookieEx)
                {
                    Message = $"Cookie设置失败: {cookieEx.Message}\n\n堆栈跟踪：{cookieEx.StackTrace}";
                    StateHasChanged();
                    return;
                }
            }
            else
            {
                Message = "登录失败：用户名或密码错误";
                Password = "";
            }
        }
        catch (Exception ex)
        {
            Message = $"登录过程中发生未知错误：\n错误信息：{ex.Message}\n\n错误类型：{ex.GetType().Name}\n\n堆栈跟踪：{ex.StackTrace}";

            if (ex.InnerException != null)
            {
                Message += $"\n\n内部异常：{ex.InnerException.Message}";
            }
        }

        StateHasChanged();
    }
}