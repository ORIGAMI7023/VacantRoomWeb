================================================================================
VACANTROOM WEB PROJECT - ALL CODE FILES
================================================================================


============================================================
FILE: AdminAuthService.cs
============================================================
ï»¿using System.Security.Cryptography;
using System.Text;
using Microsoft.JSInterop;

namespace VacantRoomWeb
{
    public class AdminConfig
    {
        public string Username { get; set; } = "";
        public string PasswordHash { get; set; } = "";
        public string Salt { get; set; } = "";
    }

    public class AdminAuthService
    {
        private readonly IConfiguration _configuration;
        private readonly SecurityService _securityService;
        private readonly EnhancedLoggingService _logger;
        private readonly IHttpContextAccessor _httpContextAccessor;

        public AdminAuthService(
            IConfiguration configuration,
            SecurityService securityService,
            EnhancedLoggingService logger,
            IHttpContextAccessor httpContextAccessor)
        {
            _configuration = configuration;
            _securityService = securityService;
            _logger = logger;
            _httpContextAccessor = httpContextAccessor;
        }

        public bool ValidateCredentials(string username, string password)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = _httpContextAccessor.HttpContext?.Request.Headers.UserAgent.ToString() ?? "";

            var adminConfig = _configuration.GetSection("AdminConfig").Get<AdminConfig>();

            if (adminConfig == null || string.IsNullOrEmpty(adminConfig.Username))
            {
                _logger.LogAccess(ip, "ADMIN_CONFIG_ERROR", "Admin configuration not found", userAgent);
                return false;
            }

            bool isValid = adminConfig.Username == username &&
                          VerifyPassword(password, adminConfig.PasswordHash, adminConfig.Salt);

            // Always check with security service to track attempts
            _securityService.CheckLoginAttempt(ip, isValid, userAgent);

            return isValid;
        }

        public async Task SetAuthCookieAsync(string username, IJSRuntime jsRuntime)
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return;

            var cookieValue = CreateAuthToken(username);
            var expires = DateTime.UtcNow.AddDays(7);

            // ä½¿ç”¨ JavaScript è®¾ç½® Cookie
            var secure = context.Request.IsHttps ? "secure; " : "";
            var cookieString = $"AdminAuth={cookieValue}; expires={expires:R}; path=/; {secure}samesite=strict";

            await jsRuntime.InvokeVoidAsync("eval", $"document.cookie = '{cookieString}'");

            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            _logger.LogAccess(ip, "ADMIN_AUTH_COOKIE_SET", username);
        }

        public void SetAuthCookie(string username)
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return;

            try
            {
                var cookieValue = CreateAuthToken(username);
                var options = new CookieOptions
                {
                    HttpOnly = true,
                    Secure = context.Request.IsHttps,
                    SameSite = SameSiteMode.Strict,
                    Expires = DateTime.UtcNow.AddDays(7)
                };

                context.Response.Cookies.Append("AdminAuth", cookieValue, options);

                var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
                _logger.LogAccess(ip, "ADMIN_AUTH_COOKIE_SET", username);
            }
            catch (InvalidOperationException)
            {
                // Response has already started, can't set cookie through HttpContext
                // This will be handled by the caller using JavaScript
                var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
                _logger.LogAccess(ip, "ADMIN_AUTH_COOKIE_SET_FAILED", "Response already started");
                throw;
            }
        }

        public bool IsAuthenticated()
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return false;

            var cookieValue = context.Request.Cookies["AdminAuth"];
            if (string.IsNullOrEmpty(cookieValue)) return false;

            return ValidateAuthToken(cookieValue);
        }

        public void SignOut()
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return;

            context.Response.Cookies.Delete("AdminAuth");

            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            _logger.LogAccess(ip, "ADMIN_LOGOUT");
        }

        private string CreateAuthToken(string username)
        {
            var timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds().ToString();
            var data = $"{username}:{timestamp}";
            var signature = ComputeHmac(data);
            return Convert.ToBase64String(Encoding.UTF8.GetBytes($"{data}:{signature}"));
        }

        private bool ValidateAuthToken(string token)
        {
            try
            {
                var decoded = Encoding.UTF8.GetString(Convert.FromBase64String(token));
                var parts = decoded.Split(':');

                if (parts.Length != 3) return false;

                var username = parts[0];
                var timestampStr = parts[1];
                var signature = parts[2];

                // Verify signature
                var data = $"{username}:{timestampStr}";
                var expectedSignature = ComputeHmac(data);
                if (signature != expectedSignature) return false;

                // Check expiration (7 days)
                if (long.TryParse(timestampStr, out var timestamp))
                {
                    var tokenTime = DateTimeOffset.FromUnixTimeSeconds(timestamp);
                    if (DateTime.UtcNow.Subtract(tokenTime.DateTime).TotalDays > 7)
                        return false;
                }

                return true;
            }
            catch
            {
                return false;
            }
        }

        private string ComputeHmac(string data)
        {
            var key = _configuration["AdminConfig:SecretKey"] ?? "DefaultSecretKey";
            using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(key));
            var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(data));
            return Convert.ToBase64String(hash);
        }

        private bool VerifyPassword(string password, string storedHash, string salt)
        {
            var hash = ComputePasswordHash(password, salt);
            return hash == storedHash;
        }

        public static string ComputePasswordHash(string password, string salt)
        {
            using var sha256 = SHA256.Create();
            var saltedPassword = salt + password;
            var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(saltedPassword));
            return Convert.ToBase64String(hash);
        }

        public static (string hash, string salt) CreatePasswordHash(string password)
        {
            var salt = GenerateSalt();
            var hash = ComputePasswordHash(password, salt);
            return (hash, salt);
        }

        private static string GenerateSalt()
        {
            var saltBytes = new byte[32];
            using var rng = RandomNumberGenerator.Create();
            rng.GetBytes(saltBytes);
            return Convert.ToBase64String(saltBytes);
        }

        public AdminConfig? GetAdminConfig()
        {
            return _configuration.GetSection("AdminConfig").Get<AdminConfig>();
        }

        public bool ValidatePassword(string password, string storedHash, string salt)
        {
            return VerifyPassword(password, storedHash, salt);
        }
    }
}


============================================================
FILE: ClientConnectionTracker.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// ç”¨äºåœ¨ç”¨æˆ·è¿æ¥æ—¶è®°å½• IPï¼Œåœ¨æ–­å¼€æ—¶æŸ¥å‡ºå¯¹åº” IP
    /// </summary>
    public class ClientConnectionTracker
    {
        private readonly Dictionary<string, string> _ipMap = new();
        private readonly object _lock = new();

        public void SetClientIp(string circuitId, string ip)
        {
            lock (_lock)
            {
                _ipMap[circuitId] = ip;
            }
        }

        public string? GetClientIp(string circuitId)
        {
            lock (_lock)
            {
                return _ipMap.TryGetValue(circuitId, out var ip) ? ip : null;
            }
        }

        public void Remove(string circuitId)
        {
            lock (_lock)
            {
                _ipMap.Remove(circuitId);
            }
        }
    }

}



============================================================
FILE: Components\App.razor
============================================================
ï»¿<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="VacantRoomWeb.styles.css" />
    <link href="css/layout.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <HeadOutlet />
</head>

<body>
    <Routes />
    <script src="_framework/blazor.web.js"></script>
</body>

</html>


============================================================
FILE: Components\Layout\MainLayout.razor
============================================================
ï»¿@inherits LayoutComponentBase

<div class="page-wrapper">
    <div class="page">
        <div class="sidebar">
            <NavMenu />
        </div>

        <main>
            <div class="top-row px-4">
                <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
            </div>

            <div class="content px-4">
                @Body
            </div>

            <!-- Sticky Footer - always at bottom of main area -->
            <footer class="sticky-footer">
                Â©@(DateTime.Now.Year) origami7023.cn&nbsp;|&nbsp;
                <a href="https://beian.miit.gov.cn/" target="_blank">
                    æ²ªICPå¤‡2025129900å·-1
                </a>
            </footer>
        </main>
    </div>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">ğŸ—™</a>
</div>


============================================================
FILE: Components\Layout\NavMenu.razor
============================================================
ï»¿<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">VacantRoomWeb</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="">
                <span class="oi oi-list-rich" aria-hidden="true"></span> ç©ºæ•™å®¤æŸ¥è¯¢
            </NavLink>
        </div>
    </nav>
</div>


============================================================
FILE: Components\Pages\AdminDashboard.razor
============================================================
ï»¿@page "/admin"
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject EnhancedLoggingService LoggingService
@inject ConnectionCounterService ConnectionService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>ç®¡ç†åå°</PageTitle>

@if (!IsAuthenticated)
{
    <div class="loading-container">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
    </div>
}
else
{
    <div class="admin-dashboard">
        <div class="dashboard-header">
            <h1>ç®¡ç†åå°</h1>
            <div class="header-actions">
                <span class="user-info">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
                <button @onclick="HandleLogout" class="btn btn-outline-secondary btn-sm">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <h3>@CurrentConnections</h3>
                    <p>æ´»è·ƒè¿æ¥æ•°</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ›¡ï¸</div>
                <div class="stat-content">
                    <h3>@SecurityStats["TotalBannedIPs"]</h3>
                    <p>å·²å°ç¦IP</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-content">
                    <h3>@SecurityStats["RecentBreachAttempts"]</h3>
                    <p>è¿‘æœŸæ”»å‡»æ¬¡æ•°(24å°æ—¶)</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <h3>@RecentLogs.Count</h3>
                    <p>æœ€è¿‘æ—¥å¿—æ¡ç›®</p>
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        @if ((bool)SecurityStats["AdminPanelLocked"])
        {
            <div class="alert alert-warning">
                <strong>âš ï¸ ç³»ç»Ÿè­¦å‘Šï¼š</strong> ç®¡ç†é¢æ¿ç›®å‰å¤„äºé”å®šçŠ¶æ€ï¼Œè§£é”æ—¶é—´ï¼š@SecurityStats["LockdownUntil"]
            </div>
        }

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tab-navigation">
            <button @onclick="() => SetActiveTab(0)" class="tab-btn @(ActiveTab == 0 ? "active" : "")">
                ğŸ“Š è®¿é—®æ—¥å¿—
            </button>
            <button @onclick="() => SetActiveTab(1)" class="tab-btn @(ActiveTab == 1 ? "active" : "")">
                ğŸ›¡ï¸ å®‰å…¨äº‹ä»¶
            </button>
            <button @onclick="() => SetActiveTab(2)" class="tab-btn @(ActiveTab == 2 ? "active" : "")">
                âš™ï¸ ç³»ç»Ÿä¿¡æ¯
            </button>
        </div>

        <!-- æ ‡ç­¾é¡µå†…å®¹ -->
        <div class="tab-content">
            @if (ActiveTab == 0)
            {
                <!-- è®¿é—®æ—¥å¿—æ ‡ç­¾é¡µ -->
                <div class="logs-section">
                    <div class="section-header">
                        <h3>æœ€è¿‘è®¿é—®æ—¥å¿—</h3>
                        <button @onclick="RefreshLogs" class="btn btn-primary btn-sm">ğŸ”„ åˆ·æ–°</button>
                    </div>

                    <div class="logs-table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th class="time-header">æ—¶é—´</th>
                                    <th class="ip-header">IPåœ°å€</th>
                                    <th class="action-header">æ“ä½œç±»å‹</th>
                                    <th class="details-header">è¯¦ç»†ä¿¡æ¯</th>
                                    <th class="ua-header">ç”¨æˆ·ä»£ç†</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in RecentLogs.Take(50))
                                {
                                    <tr class="@GetLogRowClass(log.Action)">
                                        <td class="time-cell">@log.Timestamp.ToString("MM-dd HH:mm:ss")</td>
                                        <td class="ip-cell" title="ç‚¹å‡»å¤åˆ¶IPåœ°å€">@log.IP</td>
                                        <td class="action-cell" title="@log.Action">@FormatActionType(log.Action)</td>
                                        <td class="details-cell" title="@log.Details">@log.Details</td>
                                        <td class="ua-cell" title="@log.UserAgent">@TruncateUserAgent(log.UserAgent)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else if (ActiveTab == 1)
            {
                <!-- å®‰å…¨äº‹ä»¶æ ‡ç­¾é¡µ -->
                <div class="security-section">
                    <div class="section-header">
                        <h3>å®‰å…¨äº‹ä»¶</h3>
                        <button @onclick="RefreshSecurity" class="btn btn-primary btn-sm">ğŸ”„ åˆ·æ–°</button>
                    </div>

                    <div class="security-events">
                        @foreach (var secEvent in SecurityEvents)
                        {
                            <div class="security-event @GetSecurityEventClass(secEvent.EventType)">
                                <div class="event-header">
                                    <span class="event-type">@secEvent.EventType</span>
                                    <span class="event-time">@secEvent.Timestamp.ToString("MM-dd HH:mm:ss")</span>
                                </div>
                                <div class="event-details">
                                    <strong>IPåœ°å€ï¼š</strong> @secEvent.IP<br />
                                    <strong>è¯¦ç»†ä¿¡æ¯ï¼š</strong> @secEvent.Details
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (ActiveTab == 2)
            {
                <!-- ç³»ç»Ÿä¿¡æ¯æ ‡ç­¾é¡µ -->
                <div class="system-section">
                    <h3>ç³»ç»Ÿä¿¡æ¯</h3>

                    <div class="info-grid">
                        <div class="info-card">
                            <h4>æœåŠ¡å™¨çŠ¶æ€</h4>
                            <p><strong>è¿è¡Œæ—¶é—´ï¼š</strong> @GetUptime()</p>
                            <p><strong>è¿è¡Œç¯å¢ƒï¼š</strong> @Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")</p>
                            <p><strong>æœåŠ¡å™¨æ—¶é—´ï¼š</strong> @DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</p>
                        </div>

                        <div class="info-card">
                            <h4>å®‰å…¨çŠ¶æ€</h4>
                            <p><strong>æ´»è·ƒIPè·Ÿè¸ªï¼š</strong> @SecurityStats["ActiveIPTracking"]</p>
                            <p><strong>é¢æ¿é”å®šï¼š</strong> @((bool)SecurityStats["AdminPanelLocked"] ? "æ˜¯" : "å¦")</p>
                            <p><strong>å¯ç”¨æ—¥å¿—æ—¥æœŸï¼š</strong> @AvailableLogDates.Count ä¸ª</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}


@code {
    private bool IsAuthenticated = false;
    private int ActiveTab = 0;
    private int CurrentConnections = 0;
    private List<LogEntry> RecentLogs = new();
    private List<SecurityEvent> SecurityEvents = new();
    private Dictionary<string, object> SecurityStats = new();
    private List<string> AvailableLogDates = new();
    private DateTime StartTime = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        IsAuthenticated = AuthService.IsAuthenticated();

        if (!IsAuthenticated)
        {
            Navigation.NavigateTo("/admin/login");
            return;
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        CurrentConnections = ConnectionService.GetCount();
        RecentLogs = LoggingService.GetRecentLogs(100);
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        AvailableLogDates = LoggingService.GetAvailableLogDates();

        StateHasChanged();
    }

    private void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
    }

    private async Task RefreshLogs()
    {
        RecentLogs = LoggingService.GetRecentLogs(100);
        StateHasChanged();
    }

    private async Task RefreshSecurity()
    {
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        AuthService.SignOut();
        await JSRuntime.InvokeVoidAsync("location.replace", "/admin/login");
    }

    private string GetLogRowClass(string action)
    {
        if (action.StartsWith("SECURITY_")) return "security-row";
        if (action.StartsWith("ERROR_")) return "error-row";
        if (action == "ACCESS") return "access-row";
        return "";
    }

    private string GetSecurityEventClass(string eventType)
    {
        if (eventType.Contains("BRUTE_FORCE") || eventType.Contains("DDOS") || eventType.Contains("BANNED"))
            return "danger";
        return "warning";
    }

    private string TruncateUserAgent(string userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "N/A";
        return userAgent.Length > 30 ? userAgent.Substring(0, 30) + "..." : userAgent;
    }

    private string GetUptime()
    {
        var uptime = DateTime.Now - StartTime;
        return $"{uptime.Days}d {uptime.Hours}h {uptime.Minutes}m";
    }

    private string FormatActionType(string action)
    {
        return action switch
        {
            "ACCESS" => "é¡µé¢è®¿é—®",
            "BLAZOR_CONNECTION_UP" => "è¿æ¥å»ºç«‹",
            "BLAZOR_CONNECTION_DOWN" => "è¿æ¥æ–­å¼€",
            "LOCALHOST_ADMIN_ACCESS" => "æœ¬åœ°ç®¡ç†è®¿é—®",
            "ADMIN_SUBDOMAIN_ACCESS" => "ç®¡ç†åŸŸåè®¿é—®",
            "ADMIN_PATH_REWRITE" => "è·¯å¾„é‡å†™",
            "ADMIN_ACCESS_BLOCKED" => "ç®¡ç†è®¿é—®è¢«é˜»æ­¢",
            "ACCESS_DENIED_BANNED" => "è®¿é—®è¢«æ‹’ç»(IPå°ç¦)",
            "ACCESS_DENIED_LOCKDOWN" => "è®¿é—®è¢«æ‹’ç»(ç³»ç»Ÿé”å®š)",
            "SECURITY_DDOS_DETECTED" => "æ£€æµ‹åˆ°DDoSæ”»å‡»",
            "SECURITY_BRUTE_FORCE_DETECTED" => "æ£€æµ‹åˆ°æš´åŠ›ç ´è§£",
            "SECURITY_IP_BANNED" => "IPåœ°å€è¢«å°ç¦",
            "SECURITY_ADMIN_LOCKDOWN" => "ç®¡ç†é¢æ¿é”å®š",
            "ADMIN_LOGIN_SUCCESS" => "ç®¡ç†å‘˜ç™»å½•æˆåŠŸ",
            "ADMIN_LOGIN_FAILED" => "ç®¡ç†å‘˜ç™»å½•å¤±è´¥",
            "ADMIN_LOGOUT" => "ç®¡ç†å‘˜é€€å‡ºç™»å½•",
            "ADMIN_AUTH_COOKIE_SET" => "è®¾ç½®è®¤è¯Cookie",
            "EMAIL_ALERT_TRIGGERED" => "é‚®ä»¶è­¦æŠ¥è§¦å‘",
            "QUERY_VACANT_ROOMS" => "æŸ¥è¯¢ç©ºæ•™å®¤",
            "QUERY_ROOM_USAGE" => "æŸ¥è¯¢æ•™å®¤ä½¿ç”¨æƒ…å†µ",
            "QUERY_RESULT" => "æŸ¥è¯¢ç»“æœ",
            "ERROR_FILE_NOT_FOUND" => "æ–‡ä»¶æœªæ‰¾åˆ°é”™è¯¯",
            _ => action // å¦‚æœæ²¡æœ‰åŒ¹é…çš„ï¼Œè¿”å›åŸå§‹å€¼
        };
    }
}


============================================================
FILE: Components\Pages\AdminLogin.razor
============================================================
ï»¿@page "/admin/login"
@rendermode InteractiveServer
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Admin Login - Debug</PageTitle>

<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc;">
    <h2>Admin Login - Debug Mode</h2>

    <p>å½“å‰æ—¶é—´: @DateTime.Now.ToString("HH:mm:ss")</p>
    <p>è®¡æ•°å™¨: @counter</p>

    <button @onclick="IncrementCounter" style="padding: 10px; margin: 5px; background: #007bff; color: white; border: none;">
        ç‚¹å‡»æµ‹è¯• (@counter)
    </button>

    <hr />

    <div style="margin-bottom: 15px;">
        <label>Username:</label><br />
        <input @bind="Username" @oninput="OnUsernameInput" type="text" style="width: 100%; padding: 8px;" />
        <small>è¾“å…¥çš„å€¼: @Username</small>
    </div>

    <div style="margin-bottom: 15px;">
        <label>Password:</label><br />
        <input @bind="Password" @oninput="OnPasswordInput" type="password" style="width: 100%; padding: 8px;" />
        <small>å¯†ç é•¿åº¦: @(Password?.Length ?? 0)</small>
    </div>

    <button @onclick="SimpleTest" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none; margin: 5px 0;">
        æµ‹è¯•é…ç½®
    </button>

    <button @onclick="LoginTest" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; margin: 5px 0;">
        ç™»å½•
    </button>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; margin-top: 15px; max-height: 300px; overflow-y: auto;">
            <pre style="white-space: pre-wrap; font-size: 12px; margin: 0;">@Message</pre>
        </div>
    }
</div>

<style>
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .admin-dashboard {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

        .dashboard-header h1 {
            color: #333;
            margin: 0;
        }

    /* è¿™é‡Œæ·»åŠ æˆ‘ä¹‹å‰æä¾›çš„æ‰€æœ‰è¡¨æ ¼ä¼˜åŒ–æ ·å¼ */
    .logs-table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        background: white;
    }

    .logs-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        font-family: 'Consolas', 'Monaco', monospace;
    }

        .logs-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #5a67d8;
            font-size: 0.9rem;
        }

</style>

@code {
    private int counter = 0;
    private string Username = "";
    private string Password = "";
    private string Message = "é¡µé¢å·²åŠ è½½ï¼Œç­‰å¾…æµ‹è¯•...";

    protected override async Task OnInitializedAsync()
    {
        Message = $"é¡µé¢åˆå§‹åŒ–å®Œæˆ: {DateTime.Now:yyyy-MM-dd HH:mm:ss}";

        // Check if admin panel is locked
        if (SecurityService.IsAdminPanelLocked())
        {
            Message += "\nâš ï¸ ç®¡ç†é¢æ¿å·²é”å®š";
            return;
        }

        // If already authenticated, redirect to dashboard
        if (AuthService.IsAuthenticated())
        {
            Message += "\nâœ… å·²è®¤è¯ï¼Œå‡†å¤‡è·³è½¬...";
            await Task.Delay(100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿ç»„ä»¶å®Œå…¨åŠ è½½
            Navigation.NavigateTo("/admin", true);
        }
    }

    private void IncrementCounter()
    {
        counter++;
        Message += $"\nè®¡æ•°å™¨ç‚¹å‡»: {counter} - {DateTime.Now:HH:mm:ss}";
        StateHasChanged();
    }

    private void OnUsernameInput(ChangeEventArgs e)
    {
        Username = e.Value?.ToString() ?? "";
        Message += $"\nç”¨æˆ·åè¾“å…¥: '{Username}'";
        StateHasChanged();
    }

    private void OnPasswordInput(ChangeEventArgs e)
    {
        Password = e.Value?.ToString() ?? "";
        Message += $"\nå¯†ç è¾“å…¥é•¿åº¦: {Password.Length}";
        StateHasChanged();
    }

    private void SimpleTest()
    {
        Message += $"\n=== é…ç½®æµ‹è¯•å¼€å§‹ ===";
        Message += $"\næ—¶é—´: {DateTime.Now:yyyy-MM-dd HH:mm:ss}";

        try
        {
            Message += $"\næ­£åœ¨è·å– AdminConfig...";
            var adminConfig = AuthService.GetAdminConfig();

            if (adminConfig == null)
            {
                Message += $"\nâŒ AdminConfig ä¸º null";
                Message += $"\næ£€æŸ¥ appsettings.json æ˜¯å¦åŒ…å« AdminConfig èŠ‚ç‚¹";
            }
            else
            {
                Message += $"\nâœ… AdminConfig å·²åŠ è½½";
                Message += $"\nUsername: '{adminConfig.Username}'";
                Message += $"\nPasswordHash é•¿åº¦: {adminConfig.PasswordHash?.Length ?? 0}";
                Message += $"\nSalt é•¿åº¦: {adminConfig.Salt?.Length ?? 0}";

                if (!string.IsNullOrEmpty(adminConfig.PasswordHash) && !string.IsNullOrEmpty(adminConfig.Salt))
                {
                    Message += $"\næ­£åœ¨æµ‹è¯•å¯†ç éªŒè¯...";
                    var testResult = AuthService.ValidatePassword("K9mP#3xR8qW$7nZ5", adminConfig.PasswordHash, adminConfig.Salt);
                    Message += $"\næµ‹è¯•å¯†ç éªŒè¯: {(testResult ? "âœ… æˆåŠŸ" : "âŒ å¤±è´¥")}";
                }
                else
                {
                    Message += $"\nâŒ å¯†ç å“ˆå¸Œæˆ–ç›å€¼ä¸ºç©º";
                }
            }

            Message += $"\næµ‹è¯•å®Œæˆ: {DateTime.Now:yyyy-MM-dd HH:mm:ss}";
        }
        catch (Exception ex)
        {
            Message += $"\nâŒ æµ‹è¯•å¼‚å¸¸: {ex.Message}";
        }

        StateHasChanged();
    }

    private async Task LoginTest()
    {
        if (SecurityService.IsAdminPanelLocked())
        {
            Message += $"\nâŒ ç®¡ç†é¢æ¿å·²é”å®š";
            StateHasChanged();
            return;
        }

        Message += $"\n=== ç™»å½•æµ‹è¯•å¼€å§‹ ===";
        Message += $"\nç™»å½•å¼€å§‹: {DateTime.Now:yyyy-MM-dd HH:mm:ss}";
        Message += $"\nè¾“å…¥ç”¨æˆ·å: '{Username}'";
        Message += $"\nè¾“å…¥å¯†ç é•¿åº¦: {Password?.Length ?? 0}";

        try
        {
            if (string.IsNullOrEmpty(Username) || string.IsNullOrEmpty(Password))
            {
                Message += $"\nâŒ ç”¨æˆ·åæˆ–å¯†ç ä¸ºç©º";
                StateHasChanged();
                return;
            }

            var result = AuthService.ValidateCredentials(Username, Password);
            Message += $"\néªŒè¯ç»“æœ: {(result ? "âœ… æˆåŠŸ" : "âŒ å¤±è´¥")}";

            if (result)
            {
                Message += $"\nè®¾ç½®è®¤è¯ Cookie...";

                // å°è¯•ä½¿ç”¨ JavaScript è®¾ç½® Cookie
                try
                {
                    await AuthService.SetAuthCookieAsync(Username, JSRuntime);
                    Message += $"\nâœ… Cookie è®¾ç½®æˆåŠŸ";
                }
                catch (Exception cookieEx)
                {
                    Message += $"\nâŒ Cookie è®¾ç½®å¤±è´¥: {cookieEx.Message}";
                    StateHasChanged();
                    return;
                }

                Message += $"\nå‡†å¤‡è·³è½¬åˆ° /admin";
                StateHasChanged();

                await Task.Delay(1000); // è®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸä¿¡æ¯

                Navigation.NavigateTo("/admin", forceLoad: true);
            }
            else
            {
                Message += $"\nç™»å½•å¤±è´¥ï¼Œæ¸…ç©ºå¯†ç ";
                Password = "";
            }
        }
        catch (Exception ex)
        {
            Message += $"\nâŒ ç™»å½•å¼‚å¸¸: {ex.Message}";
        }

        Message += $"\n=== ç™»å½•æµ‹è¯•ç»“æŸ ===";
        StateHasChanged();
    }
}


============================================================
FILE: Components\Pages\Error.razor
============================================================
ï»¿@page "/Error"
@using System.Diagnostics

<PageTitle>Error</PageTitle>

<h1 class="text-danger">Error.</h1>
<h2 class="text-danger">An error occurred while processing your request.</h2>

@if (ShowRequestId)
{
    <p>
        <strong>Request ID:</strong> <code>@RequestId</code>
    </p>
}

<h3>Development Mode</h3>
<p>
    Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
</p>
<p>
    <strong>The Development environment shouldn't be enabled for deployed applications.</strong>
    It can result in displaying sensitive information from exceptions to end users.
    For local debugging, enable the <strong>Development</strong> environment by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
    and restarting the app.
</p>

@code{
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private string? RequestId { get; set; }
    private bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

    protected override void OnInitialized() =>
        RequestId = Activity.Current?.Id ?? HttpContext?.TraceIdentifier;
}



============================================================
FILE: Components\Pages\VacantRoom.razor
============================================================
ï»¿@page "/"
@rendermode InteractiveServer
@inject VacantRoomService VacantService

<h3 style="margin-bottom: 1rem;">æ•™å®¤æŸ¥è¯¢ç³»ç»Ÿ</h3>
<p style="font-size: 1.1rem; color: gray;">@TodayText</p>

<!-- Tab Navigation -->
<div style="margin-bottom: 2rem;">
    <button @onclick="() => SetActiveTab(0)"
            style="@GetTabStyle(0)">
        ç©ºæ•™å®¤æŸ¥è¯¢
    </button>
    <button @onclick="() => SetActiveTab(1)"
            style="@GetTabStyle(1)">
        æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢
    </button>
</div>

<div style="max-width: 500px;">

    @if (ActiveTab == 0)
    {
        <!-- ç©ºæ•™å®¤æŸ¥è¯¢ -->
        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ ¡åŒºï¼š</label>
            <select @bind="Campus" style="width: 200px;">
                <option value="å¥‰è´¤æ ¡åŒº">å¥‰è´¤</option>
                <option value="å¾æ±‡æ ¡åŒº">å¾æ±‡</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ˜ŸæœŸï¼š</label>
            <select @bind="Weekday" style="width: 200px;">
                <option>å‘¨ä¸€</option>
                <option>å‘¨äºŒ</option>
                <option>å‘¨ä¸‰</option>
                <option>å‘¨å››</option>
                <option>å‘¨äº”</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">èŠ‚æ¬¡ï¼š</label>
            <select @bind="Period" style="width: 200px;">
                <option>1-2èŠ‚</option>
                <option>3-4èŠ‚</option>
                <option>5-6èŠ‚</option>
                <option>7-8èŠ‚</option>
                <option>9-10èŠ‚</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å­¦æ¥¼ï¼š</label>
            <select @bind="Building" style="width: 200px;">
                <option>æ‰€æœ‰</option>
                <option>A</option>
                <option>B</option>
                <option>C</option>
                <option>D</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">ç¬¬å‡ å‘¨ï¼š</label>
            <select @bind="Week" style="width: 200px;">
                @for (int i = 1; i <= 18; i++)
                {
                    <option value="@($"ç¬¬{i}å‘¨")">ç¬¬ @i å‘¨</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <button @onclick="QueryVacantRooms" style="padding: 8px 16px; font-weight: bold; background-color: #007bff; color: white; border: none; border-radius: 4px;">
                æŸ¥è¯¢ç©ºæ•™å®¤
            </button>
        </div>

        <hr />

        <p style="color: red;">[Debug]å½“å‰é€‰ä¸­ï¼š @Campus, @Weekday, @Period, @Building, @Week</p>

        @if (VacantResult != null)
        {
            <p style="color: orange;">[Debug]å…±æŸ¥è¯¢åˆ° @VacantResult.Count ä¸ªç©ºæ•™å®¤</p>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 4px;">
                <ul style="margin: 0; padding-left: 20px;">
                    @foreach (var room in VacantResult)
                    {
                        <li>@room</li>
                    }
                </ul>
            </div>
        }
        else
        {
            <p style="color: gray;">è¯·å¡«å†™æ¡ä»¶åç‚¹å‡»æŸ¥è¯¢</p>
        }
    }
    else
    {
        <!-- æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢ -->
        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ ¡åŒºï¼š</label>
            <select @bind="RoomCampus" style="width: 200px;">
                <option value="å¥‰è´¤æ ¡åŒº">å¥‰è´¤</option>
                <option value="å¾æ±‡æ ¡åŒº">å¾æ±‡</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å­¦æ¥¼ï¼š</label>
            <select value="@RoomBuilding" @onchange="OnBuildingChanged" style="width: 200px;">
                <option value="">è¯·é€‰æ‹©æ•™å­¦æ¥¼</option>
                <option value="A">Aæ¥¼</option>
                <option value="B">Bæ¥¼</option>
                <option value="C">Cæ¥¼</option>
                <option value="D">Dæ¥¼</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å®¤å·ï¼š</label>
            <select @bind="RoomNumber" style="width: 200px;" disabled="@string.IsNullOrEmpty(RoomBuilding)">
                @if (string.IsNullOrEmpty(RoomBuilding))
                {
                    <option value="">è¯·å…ˆé€‰æ‹©æ•™å­¦æ¥¼</option>
                }
                else
                {
                    <option value="">è¯·é€‰æ‹©æ•™å®¤</option>
                    @foreach (var room in GetRoomsForBuilding(RoomBuilding))
                    {
                        <option value="@room">@room</option>
                    }
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ˜ŸæœŸï¼š</label>
            <select @bind="RoomWeekday" style="width: 200px;">
                <option>å‘¨ä¸€</option>
                <option>å‘¨äºŒ</option>
                <option>å‘¨ä¸‰</option>
                <option>å‘¨å››</option>
                <option>å‘¨äº”</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">ç¬¬å‡ å‘¨ï¼š</label>
            <select @bind="RoomWeek" style="width: 200px;">
                @for (int i = 1; i <= 18; i++)
                {
                    <option value="@($"ç¬¬{i}å‘¨")">ç¬¬ @i å‘¨</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <button @onclick="QueryRoomUsage"
                    disabled="@string.IsNullOrEmpty(RoomNumber)"
                    style="padding: 8px 16px; font-weight: bold; background-color: #28a745; color: white; border: none; border-radius: 4px; opacity: @(string.IsNullOrEmpty(RoomNumber) ? "0.5" : "1");">
                æŸ¥è¯¢æ•™å®¤ä½¿ç”¨æƒ…å†µ
            </button>
        </div>

        <hr />

        <p style="color: red;">[Debug]å½“å‰é€‰ä¸­ï¼š @RoomCampus, @RoomBuilding @RoomNumber, @RoomWeekday, @RoomWeek</p>

        @if (UsageResult != null)
        {
            <div style="border: 1px solid #ccc; border-radius: 4px; padding: 15px; background-color: #f8f9fa;">
                <h4 style="margin-top: 0; color: #495057;">@RoomBuilding@RoomNumber æ•™å®¤ä½¿ç”¨æƒ…å†µ</h4>
                <p style="color: #6c757d; margin-bottom: 15px;">@RoomCampus Â· @RoomWeekday Â· @RoomWeek</p>

                @if (UsageResult.Count == 0)
                {
                    <p style="color: green; font-weight: bold;">âœ… è¯¥æ•™å®¤å½“å¤©å…¨å¤©ç©ºé—²</p>
                }
                else
                {
                    <div style="display: grid; gap: 8px;">
                        @foreach (var usage in UsageResult)
                        {
                            <div style="background-color: white; padding: 12px; border-radius: 4px; border-left: 4px solid #dc3545;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: #dc3545;">@usage.Period</span>
                                    <span style="font-size: 0.9em; color: #6c757d;">@usage.TimeRange</span>
                                </div>
                                <div style="margin-top: 4px; color: #495057;">
                                    <strong>è¯¾ç¨‹ï¼š</strong>@usage.CourseName
                                </div>
                                @if (!string.IsNullOrEmpty(usage.Teacher))
                                {
                                    <div style="font-size: 0.9em; color: #6c757d;">
                                        <strong>æ•™å¸ˆï¼š</strong>@usage.Teacher
                                    </div>
                                }
                                
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <p style="color: gray;">è¯·é€‰æ‹©æ•™å®¤åç‚¹å‡»æŸ¥è¯¢</p>
        }
    }

</div>


@code {
    // Tab management
    int ActiveTab = 0;

    // ç©ºæ•™å®¤æŸ¥è¯¢ç›¸å…³å˜é‡
    string Campus = "å¥‰è´¤æ ¡åŒº";
    string Weekday = "";
    string Period = "1-2èŠ‚";
    string Building = "æ‰€æœ‰";
    string Week = "ç¬¬1å‘¨";
    List<string> VacantResult;

    // æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢ç›¸å…³å˜é‡
    string RoomCampus = "å¥‰è´¤æ ¡åŒº";
    string RoomBuilding = "";
    string RoomNumber = "";
    string RoomWeekday = "";
    string RoomWeek = "ç¬¬1å‘¨";
    List<VacantRoomWeb.RoomUsage> UsageResult;

    string TodayText;

    // RoomUsage class is now in VacantRoomService.cs

    void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
        // åˆ‡æ¢æ ‡ç­¾æ—¶æ¸…ç©ºç»“æœ
        if (tabIndex == 0)
        {
            UsageResult = null;
        }
        else
        {
            VacantResult = null;
        }
    }

    string GetTabStyle(int tabIndex)
    {
        var baseStyle = "padding: 10px 20px; margin-right: 5px; border: 1px solid #ccc; border-radius: 4px 4px 0 0; cursor: pointer; background-color: ";
        return baseStyle + (ActiveTab == tabIndex ? "#007bff; color: white;" : "#f8f9fa; color: #495057;");
    }

    // â€”â€” èŠ‚æ¬¡æ—¶é—´è¡¨ï¼ˆä»…ç”¨äºè‡ªåŠ¨é€‰æ‹©ï¼‰â€”â€”
    List<(TimeSpan Start, TimeSpan End, string Label)> PeriodSlots = new()
    {
        (new TimeSpan(8, 00, 00), new TimeSpan(9, 40, 00), "1-2èŠ‚"),
        (new TimeSpan(9, 55, 00), new TimeSpan(11, 35, 00), "3-4èŠ‚"),
        (new TimeSpan(13, 30, 00), new TimeSpan(15, 10, 00), "5-6èŠ‚"),
        (new TimeSpan(15, 25, 00), new TimeSpan(17, 05, 00), "7-8èŠ‚"),
        (new TimeSpan(18, 30, 00), new TimeSpan(20, 10, 00), "9-10èŠ‚"),
    };

    void SetDefaultPeriodByNow()
    {
        DateTime now = DateTime.Now;
        TimeSpan t = now.TimeOfDay;

        // Check each time slot to see if current time falls within it
        for (int i = 0; i < PeriodSlots.Count; i++)
        {
            (TimeSpan Start, TimeSpan End, string Label) slot = PeriodSlots[i];

            // If current time is within this period, select it
            if (t >= slot.Start && t <= slot.End)
            {
                Period = slot.Label;  // Select current period, not next
                return;
            }
        }

        // If before first period (before 8:00), default to first period
        if (t < PeriodSlots[0].Start)
        {
            Period = PeriodSlots[0].Label; // "1-2èŠ‚"
            return;
        }

        // If between periods or after all periods, find the next upcoming period
        for (int i = 0; i < PeriodSlots.Count - 1; i++)
        {
            if (t > PeriodSlots[i].End && t < PeriodSlots[i + 1].Start)
            {
                Period = PeriodSlots[i + 1].Label; // Next period
                return;
            }
        }

        // If after all periods (after 20:10), default to first period of next day
        Period = "1-2èŠ‚";
    }

    void QueryVacantRooms()
    {
        VacantResult = VacantService.GetVacantRooms(Campus, Weekday, Period, Building, Week);
    }

    void QueryRoomUsage()
    {
        if (string.IsNullOrEmpty(RoomNumber)) return;

        // è°ƒç”¨æœåŠ¡è·å–æ•™å®¤ä½¿ç”¨æƒ…å†µ
        UsageResult = VacantService.GetRoomUsage(RoomCampus, RoomBuilding + RoomNumber, RoomWeekday, RoomWeek);
    }

    void OnBuildingChanged(ChangeEventArgs e)
    {
        RoomBuilding = e.Value?.ToString() ?? "";
        RoomNumber = ""; // æ¸…ç©ºæ•™å®¤å·é€‰æ‹©
    }

    List<string> GetRoomsForBuilding(string building)
    {
        // ä½¿ç”¨æœåŠ¡è·å–å®é™…çš„æ•™å®¤åˆ—è¡¨
        return VacantService.GetRoomsForBuilding(building);
    }

    protected override void OnInitialized()
    {
        var today = DateTime.Today.DayOfWeek;
        TodayText = DateTime.Today.ToString("D");

        string todayWeekday = today switch
        {
            DayOfWeek.Monday => "å‘¨ä¸€",
            DayOfWeek.Tuesday => "å‘¨äºŒ",
            DayOfWeek.Wednesday => "å‘¨ä¸‰",
            DayOfWeek.Thursday => "å‘¨å››",
            DayOfWeek.Friday => "å‘¨äº”",
            _ => "å‘¨ä¸€"
        };

        Weekday = todayWeekday;
        RoomWeekday = todayWeekday;

        DateTime week14Start = new DateTime(2025, 9, 8);
        int passedDays = (DateTime.Today - week14Start).Days;
        int weekOffset = passedDays / 7;
        int currentWeekNumber = 1 + weekOffset;

        if (currentWeekNumber < 1) currentWeekNumber = 1;
        if (currentWeekNumber > 18) currentWeekNumber = 18;

        Week = $"ç¬¬{currentWeekNumber}å‘¨";
        RoomWeek = $"ç¬¬{currentWeekNumber}å‘¨";

        SetDefaultPeriodByNow();
    }
}


============================================================
FILE: Components\Routes.razor
============================================================
ï»¿<Router AppAssembly="typeof(Program).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)" />
        <FocusOnNavigate RouteData="routeData" Selector="h1" />
    </Found>
</Router>



============================================================
FILE: Components\_Imports.razor
============================================================
ï»¿@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@using VacantRoomWeb
@using VacantRoomWeb.Components
@using System.ComponentModel.DataAnnotations


============================================================
FILE: ConnectionCounterService.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// ç»´æŠ¤å½“å‰åœ¨çº¿è¿æ¥æ•°
    /// </summary>
    public class ConnectionCounterService
    {
        private int _count = 0;

        public int Increment()
        {
            return Interlocked.Increment(ref _count);
        }

        public int Decrement()
        {
            return Interlocked.Decrement(ref _count);
        }

        public int GetCount()
        {
            return _count;
        }
    }

}



============================================================
FILE: ConnectionLoggingCircuitHandler.cs
============================================================
ï»¿using Microsoft.AspNetCore.Components.Server.Circuits;

namespace VacantRoomWeb
{
    public class ConnectionLoggingCircuitHandler : CircuitHandler
    {
        private readonly ConnectionCounterService _counter;
        private readonly ClientConnectionTracker _ipTracker;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private readonly EnhancedLoggingService _logger;

        public ConnectionLoggingCircuitHandler(
            ConnectionCounterService counter,
            ClientConnectionTracker ipTracker,
            IHttpContextAccessor httpContextAccessor,
            EnhancedLoggingService logger)
        {
            _counter = counter;
            _ipTracker = ipTracker;
            _httpContextAccessor = httpContextAccessor;
            _logger = logger;
        }

        public override Task OnConnectionUpAsync(Circuit circuit, CancellationToken cancellationToken)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = _httpContextAccessor.HttpContext?.Request.Headers.UserAgent.ToString() ?? "";

            _ipTracker.SetClientIp(circuit.Id, ip);

            var count = _counter.Increment();
            _logger.LogAccess(ip, "BLAZOR_CONNECTION_UP", $"Active connections: {count}", userAgent);

            return Task.CompletedTask;
        }

        public override Task OnConnectionDownAsync(Circuit circuit, CancellationToken cancellationToken)
        {
            var ip = _ipTracker.GetClientIp(circuit.Id);

            if (ip != null)
            {
                _ipTracker.Remove(circuit.Id);
                var count = _counter.Decrement();
                _logger.LogAccess(ip, "BLAZOR_CONNECTION_DOWN", $"Active connections: {count}");
            }
            else
            {
                _logger.LogAccess("Unknown", "BLAZOR_CONNECTION_DOWN", "IP not tracked");
            }

            return Task.CompletedTask;
        }
    }
}


============================================================
FILE: DomainRoutingMiddleware.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    public class DomainRoutingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly EnhancedLoggingService _logger;

        public DomainRoutingMiddleware(RequestDelegate next, EnhancedLoggingService logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var host = context.Request.Host.Host.ToLowerInvariant();
            var path = context.Request.Path.ToString();
            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";

            // Allow localhost admin access in development
            if (host.Contains("localhost") && path.StartsWith("/admin"))
            {
                _logger.LogAccess(ip, "LOCALHOST_ADMIN_ACCESS", $"Host: {host}, Path: {path}");
                // Allow direct admin access on localhost
                await _next(context);
                return;
            }

            // Handle admin subdomain
            if (host.StartsWith("admin."))
            {
                _logger.LogAccess(ip, "ADMIN_SUBDOMAIN_ACCESS", $"Host: {host}, Path: {path}");

                // Redirect root admin domain to login
                if (path == "/" || string.IsNullOrEmpty(path))
                {
                    context.Response.Redirect("/admin/login");
                    return;
                }

                // Ensure admin paths are properly routed
                if (!path.StartsWith("/admin"))
                {
                    var newPath = "/admin" + path;
                    context.Request.Path = newPath;
                    _logger.LogAccess(ip, "ADMIN_PATH_REWRITE", $"Rewritten: {path} -> {newPath}");
                }
            }
            else
            {
                // Block access to admin paths from main domain (except localhost)
                if (path.StartsWith("/admin") && !host.Contains("localhost"))
                {
                    _logger.LogAccess(ip, "ADMIN_ACCESS_BLOCKED", $"Admin access attempt from main domain: {host}");
                    context.Response.StatusCode = 404;
                    await context.Response.WriteAsync("Not Found");
                    return;
                }
            }

            await _next(context);
        }
    }
}


============================================================
FILE: EnhancedLoggingService.cs
============================================================
ï»¿using System.Collections.Concurrent;

namespace VacantRoomWeb
{
    public class LogEntry
    {
        public DateTime Timestamp { get; set; }
        public string IP { get; set; } = "";
        public string Action { get; set; } = "";
        public string Details { get; set; } = "";
        public string UserAgent { get; set; } = "";
        public string RequestPath { get; set; } = "";
    }

    public class EnhancedLoggingService
    {
        private readonly string _logDirectory;
        private readonly ConcurrentQueue<LogEntry> _recentLogs = new();
        private readonly object _fileLock = new();
        private const int MaxRecentLogs = 1000;

        public EnhancedLoggingService()
        {
            _logDirectory = Path.Combine(AppContext.BaseDirectory, "Logs");
            Directory.CreateDirectory(_logDirectory);
        }

        public void LogAccess(string ip, string action, string details = "", string userAgent = "", string requestPath = "")
        {
            var logEntry = new LogEntry
            {
                Timestamp = DateTime.Now,
                IP = ip,
                Action = action,
                Details = details,
                UserAgent = userAgent,
                RequestPath = requestPath
            };

            // Add to memory queue
            _recentLogs.Enqueue(logEntry);

            // Keep only recent logs in memory
            while (_recentLogs.Count > MaxRecentLogs)
            {
                _recentLogs.TryDequeue(out _);
            }

            // Write to file (no console output for IIS)
            WriteToFile(logEntry);
        }

        private void WriteToFile(LogEntry entry)
        {
            try
            {
                var fileName = $"access-{DateTime.Now:yyyy-MM-dd}.log";
                var filePath = Path.Combine(_logDirectory, fileName);

                var logLine = $"[{entry.Timestamp:yyyy-MM-dd HH:mm:ss}] IP:{entry.IP} ACTION:{entry.Action} PATH:{entry.RequestPath} DETAILS:{entry.Details} UA:{entry.UserAgent}";

                lock (_fileLock)
                {
                    File.AppendAllText(filePath, logLine + Environment.NewLine);
                }
            }
            catch
            {
                // Silently fail in production environment
            }
        }

        public List<LogEntry> GetRecentLogs(int count = 100)
        {
            return _recentLogs.TakeLast(count).ToList();
        }

        public List<LogEntry> GetLogsByDate(DateTime date)
        {
            var fileName = $"access-{date:yyyy-MM-dd}.log";
            var filePath = Path.Combine(_logDirectory, fileName);

            if (!File.Exists(filePath))
                return new List<LogEntry>();

            try
            {
                var lines = File.ReadAllLines(filePath);
                var logs = new List<LogEntry>();

                foreach (var line in lines)
                {
                    if (TryParseLogLine(line, out var logEntry))
                    {
                        logs.Add(logEntry);
                    }
                }

                return logs;
            }
            catch
            {
                return new List<LogEntry>();
            }
        }

        private bool TryParseLogLine(string line, out LogEntry logEntry)
        {
            logEntry = new LogEntry();

            try
            {
                var parts = line.Split(new[] { " IP:", " ACTION:", " PATH:", " DETAILS:", " UA:" }, StringSplitOptions.None);

                if (parts.Length >= 6)
                {
                    var timestampStr = parts[0].Trim('[', ']');
                    logEntry.Timestamp = DateTime.Parse(timestampStr);
                    logEntry.IP = parts[1];
                    logEntry.Action = parts[2];
                    logEntry.RequestPath = parts[3];
                    logEntry.Details = parts[4];
                    logEntry.UserAgent = parts[5];
                    return true;
                }
            }
            catch
            {
                // Ignore parse errors
            }

            return false;
        }

        public List<string> GetAvailableLogDates()
        {
            try
            {
                return Directory.GetFiles(_logDirectory, "access-*.log")
                    .Select(f => Path.GetFileName(f))
                    .Select(f => f.Replace("access-", "").Replace(".log", ""))
                    .OrderByDescending(d => d)
                    .ToList();
            }
            catch
            {
                return new List<string>();
            }
        }
    }
}


============================================================
FILE: PasswordHashGenerator.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// Utility class to generate password hashes for admin configuration
    /// Run this once to generate hash and salt, then add to appsettings.json
    /// </summary>
    public static class PasswordHashGenerator
    {
        /// <summary>
        /// Generate password hash and salt for a given password
        /// Usage: var result = PasswordHashGenerator.GenerateHash("your_admin_password");
        /// </summary>
        public static (string hash, string salt) GenerateHash(string password)
        {
            return AdminAuthService.CreatePasswordHash(password);
        }

        /// <summary>
        /// Console application to generate admin password hash
        /// Uncomment and run this method to generate your admin credentials
        /// </summary>
        /*
        public static void Main(string[] args)
        {
            Console.WriteLine("Admin Password Hash Generator");
            Console.WriteLine("============================");
            
            Console.Write("Enter admin password: ");
            var password = Console.ReadLine();
            
            if (string.IsNullOrEmpty(password))
            {
                Console.WriteLine("Password cannot be empty!");
                return;
            }
            
            var (hash, salt) = GenerateHash(password);
            
            Console.WriteLine("\nGenerated credentials:");
            Console.WriteLine($"Password Hash: {hash}");
            Console.WriteLine($"Salt: {salt}");
            
            Console.WriteLine("\nAdd these to your appsettings.json:");
            Console.WriteLine("\"AdminConfig\": {");
            Console.WriteLine("  \"Username\": \"admin\",");
            Console.WriteLine($"  \"PasswordHash\": \"{hash}\",");
            Console.WriteLine($"  \"Salt\": \"{salt}\",");
            Console.WriteLine("  \"SecretKey\": \"your_secret_key_for_auth_tokens\"");
            Console.WriteLine("}");
            
            Console.WriteLine("\nPress any key to exit...");
            Console.ReadKey();
        }
        */
    }
}


============================================================
FILE: Program.cs
============================================================
using Microsoft.AspNetCore.Components.Server.Circuits;
using VacantRoomWeb;
using VacantRoomWeb.Components;

var builder = WebApplication.CreateBuilder(args);

// Add Blazor services
builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents();

builder.Services.AddSignalR(options =>
{
    options.MaximumReceiveMessageSize = null;
    options.EnableDetailedErrors = true; // Â¿ÂªÂ·Â¢Â»Â·Â¾Â³Ã†Ã´Ã“ÃƒÃÃªÃÂ¸Â´Ã­ÃÃ³
});

// Register existing services
builder.Services.AddSingleton<ConnectionCounterService>();
builder.Services.AddSingleton<ClientConnectionTracker>();
builder.Services.AddSingleton<IHttpContextAccessor, HttpContextAccessor>();

// Register new security and logging services
builder.Services.AddSingleton<EnhancedLoggingService>();
builder.Services.AddSingleton<IEmailService, EmailService>();
builder.Services.AddSingleton<SecurityService>();
builder.Services.AddSingleton<AdminAuthService>();

// Register updated services with new dependencies
builder.Services.AddSingleton<VacantRoomService>();
builder.Services.AddSingleton<CircuitHandler, ConnectionLoggingCircuitHandler>();

var app = builder.Build();

// Configure the HTTP request pipeline
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error", createScopeForErrors: true);
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

// Add domain routing middleware FIRST
app.UseMiddleware<DomainRoutingMiddleware>();

// Add security middleware AFTER domain routing
app.UseMiddleware<SecurityMiddleware>();

app.UseAntiforgery();

app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode();

app.Run();


============================================================
FILE: SecurityMiddleware.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    public class SecurityMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly SecurityService _securityService;
        private readonly EnhancedLoggingService _logger;

        public SecurityMiddleware(RequestDelegate next, SecurityService securityService, EnhancedLoggingService logger)
        {
            _next = next;
            _securityService = securityService;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = context.Request.Headers.UserAgent.ToString();
            var requestPath = context.Request.Path.ToString();

            // Check if IP is banned
            if (_securityService.IsIPBanned(ip))
            {
                _logger.LogAccess(ip, "ACCESS_DENIED_BANNED", requestPath, userAgent);
                context.Response.StatusCode = 403;
                await context.Response.WriteAsync("Access denied");
                return;
            }

            // Check admin panel lockdown
            if (requestPath.StartsWith("/admin", StringComparison.OrdinalIgnoreCase) && _securityService.IsAdminPanelLocked())
            {
                _logger.LogAccess(ip, "ACCESS_DENIED_LOCKDOWN", requestPath, userAgent);
                context.Response.StatusCode = 503;
                await context.Response.WriteAsync("Admin panel temporarily unavailable");
                return;
            }

            // Rate limiting check
            if (!_securityService.CheckRateLimit(ip, userAgent))
            {
                context.Response.StatusCode = 429;
                await context.Response.WriteAsync("Too many requests");
                return;
            }

            // Log normal access
            _logger.LogAccess(ip, "ACCESS", requestPath, userAgent);

            await _next(context);
        }
    }
}


============================================================
FILE: SecurityService.cs
============================================================
ï»¿using System.Collections.Concurrent;

namespace VacantRoomWeb
{
    public class SecurityEvent
    {
        public DateTime Timestamp { get; set; }
        public string IP { get; set; } = "";
        public string EventType { get; set; } = "";
        public string Details { get; set; } = "";
    }

    public class SecurityService
    {
        private readonly EnhancedLoggingService _logger;
        private readonly IEmailService _emailService;

        // IP tracking for rate limiting
        private readonly ConcurrentDictionary<string, List<DateTime>> _ipRequests = new();
        private readonly ConcurrentDictionary<string, List<DateTime>> _loginAttempts = new();
        private readonly ConcurrentDictionary<string, DateTime> _bannedIPs = new();

        // System-wide security tracking
        private readonly List<DateTime> _recentBreachAttempts = new();
        private DateTime? _adminPanelLockdownUntil = null;
        private DateTime _lastEmailSent = DateTime.MinValue;

        private readonly object _lockObject = new();

        public SecurityService(EnhancedLoggingService logger, IEmailService emailService)
        {
            _logger = logger;
            _emailService = emailService;
        }

        public bool IsIPBanned(string ip)
        {
            if (_bannedIPs.TryGetValue(ip, out var banTime))
            {
                if (DateTime.Now < banTime)
                {
                    return true;
                }
                else
                {
                    _bannedIPs.TryRemove(ip, out _);
                }
            }
            return false;
        }

        public bool IsAdminPanelLocked()
        {
            if (_adminPanelLockdownUntil.HasValue && DateTime.Now < _adminPanelLockdownUntil.Value)
            {
                return true;
            }
            else
            {
                _adminPanelLockdownUntil = null;
                return false;
            }
        }

        public bool CheckRateLimit(string ip, string userAgent = "")
        {
            lock (_lockObject)
            {
                var now = DateTime.Now;
                var oneMinuteAgo = now.AddMinutes(-1);

                // Clean old requests
                _ipRequests.AddOrUpdate(ip, new List<DateTime> { now }, (key, list) =>
                {
                    list.RemoveAll(time => time < oneMinuteAgo);
                    list.Add(now);
                    return list;
                });

                var requestCount = _ipRequests[ip].Count;

                // DDoS detection: 30 requests per minute
                if (requestCount > 30)
                {
                    BanIP(ip, TimeSpan.FromHours(1), "DDoS_DETECTED");
                    _logger.LogAccess(ip, "SECURITY_DDOS_DETECTED", $"Requests in 1min: {requestCount}", userAgent);

                    TriggerEmailAlert("DDoS Attack Detected", $"IP {ip} made {requestCount} requests in 1 minute and has been banned.");

                    return false;
                }

                return true;
            }
        }

        public bool CheckLoginAttempt(string ip, bool successful, string userAgent = "")
        {
            lock (_lockObject)
            {
                var now = DateTime.Now;
                var oneMinuteAgo = now.AddMinutes(-1);
                var fiveMinutesAgo = now.AddMinutes(-5);

                if (successful)
                {
                    // Clear failed attempts on successful login
                    _loginAttempts.TryRemove(ip, out _);
                    _logger.LogAccess(ip, "ADMIN_LOGIN_SUCCESS", "", userAgent);
                    return true;
                }

                // Track failed attempts
                _loginAttempts.AddOrUpdate(ip, new List<DateTime> { now }, (key, list) =>
                {
                    list.RemoveAll(time => time < oneMinuteAgo);
                    list.Add(now);
                    return list;
                });

                var failedCount = _loginAttempts[ip].Count;

                // Brute force detection: 5 failed attempts per minute
                if (failedCount >= 5)
                {
                    BanIP(ip, TimeSpan.FromHours(1), "BRUTE_FORCE_DETECTED");
                    _logger.LogAccess(ip, "SECURITY_BRUTE_FORCE_DETECTED", $"Failed login attempts: {failedCount}", userAgent);

                    // Track for system-wide lockdown
                    _recentBreachAttempts.RemoveAll(time => time < fiveMinutesAgo);
                    _recentBreachAttempts.Add(now);

                    TriggerEmailAlert("Brute Force Attack Detected", $"IP {ip} attempted {failedCount} failed logins and has been banned.");

                    // System lockdown: 10 brute force attempts in 5 minutes
                    if (_recentBreachAttempts.Count >= 10)
                    {
                        _adminPanelLockdownUntil = now.AddMinutes(30);
                        _logger.LogAccess(ip, "SECURITY_ADMIN_LOCKDOWN", "Admin panel locked for 30 minutes due to multiple breach attempts", userAgent);

                        TriggerEmailAlert("CRITICAL: Admin Panel Locked",
                            $"Admin panel has been locked for 30 minutes due to {_recentBreachAttempts.Count} brute force attempts in 5 minutes. Latest attacker IP: {ip}");
                    }

                    return false;
                }

                _logger.LogAccess(ip, "ADMIN_LOGIN_FAILED", $"Attempt {failedCount}/5", userAgent);
                return true;
            }
        }

        private void BanIP(string ip, TimeSpan duration, string reason)
        {
            var banUntil = DateTime.Now.Add(duration);
            _bannedIPs.AddOrUpdate(ip, banUntil, (key, oldTime) => banUntil);

            _logger.LogAccess(ip, "SECURITY_IP_BANNED", $"Reason: {reason}, Duration: {duration.TotalMinutes} minutes");
        }

        private void TriggerEmailAlert(string subject, string message)
        {
            var now = DateTime.Now;

            // Rate limit emails: max 1 every 30 minutes
            if (now.Subtract(_lastEmailSent).TotalMinutes >= 30)
            {
                _lastEmailSent = now;
                _emailService.SendSecurityAlert(subject, message);
            }
        }

        public List<SecurityEvent> GetRecentSecurityEvents(int count = 50)
        {
            var events = new List<SecurityEvent>();
            var recentLogs = _logger.GetRecentLogs(count * 2);

            foreach (var log in recentLogs.Where(l => l.Action.StartsWith("SECURITY_") || l.Action.Contains("LOGIN")))
            {
                events.Add(new SecurityEvent
                {
                    Timestamp = log.Timestamp,
                    IP = log.IP,
                    EventType = log.Action,
                    Details = log.Details
                });
            }

            return events.OrderByDescending(e => e.Timestamp).Take(count).ToList();
        }

        public Dictionary<string, object> GetSecurityStats()
        {
            lock (_lockObject)
            {
                var now = DateTime.Now;
                var oneDayAgo = now.AddDays(-1);

                return new Dictionary<string, object>
                {
                    ["TotalBannedIPs"] = _bannedIPs.Count(kvp => kvp.Value > now),
                    ["AdminPanelLocked"] = IsAdminPanelLocked(),
                    ["LockdownUntil"] = _adminPanelLockdownUntil?.ToString("yyyy-MM-dd HH:mm:ss"),
                    ["RecentBreachAttempts"] = _recentBreachAttempts.Count(t => t > oneDayAgo),
                    ["ActiveIPTracking"] = _ipRequests.Count
                };
            }
        }
    }

    // Email service interface (placeholder for future implementation)
    public interface IEmailService
    {
        void SendSecurityAlert(string subject, string message);
    }

    public class EmailService : IEmailService
    {
        private readonly EnhancedLoggingService _logger;

        public EmailService(EnhancedLoggingService logger)
        {
            _logger = logger;
        }

        public void SendSecurityAlert(string subject, string message)
        {
            // Placeholder implementation - log the email attempt
            _logger.LogAccess("SYSTEM", "EMAIL_ALERT_TRIGGERED", $"Subject: {subject}, Message: {message}");

            // TODO: Implement actual email sending using SMTP
            // This will be implemented in the next phase
        }
    }
}


============================================================
FILE: VacantRoomService.cs
============================================================
ï»¿using ClosedXML.Excel;
using Microsoft.AspNetCore.Components.Server.Circuits;
using System.Collections.Generic;
using System.IO;
using System.Linq;

namespace VacantRoomWeb
{
    public class VacantRoomService
    {
        private readonly ConnectionCounterService _counter;
        private readonly ClientConnectionTracker _ipTracker;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private readonly EnhancedLoggingService _logger;

        public VacantRoomService(
            ConnectionCounterService counter,
            ClientConnectionTracker ipTracker,
            IHttpContextAccessor httpContextAccessor,
            EnhancedLoggingService logger)
        {
            _counter = counter;
            _ipTracker = ipTracker;
            _httpContextAccessor = httpContextAccessor;
            _logger = logger;
        }

        List<string> list = new List<string> { "A101", "A102", "A103", "A104", "A105", "A106",
                                               "A201", "A202", "A203", "A204", "A205", "A206",
                                               "A301", "A302", "A303", "A304", "A305",
                                               "A401", "A402", "A403", "A404", "A405", "A406",
                                               "B101", "B102", "B103", "B104", "B105", "B106", "B107", "B108",
                                               "B201", "B202", "B203", "B204", "B205", "B206", "B207", "B208",
                                               "B301", "B302", "B303", "B304", "B305", "B306", "B307", "B308",
                                               "B401", "B402", "B403", "B404", "B405", "B406", "B407", "B408",
                                               "B501", "B502", "B503", "B504", "B505", "B506", "B507", "B508",
                                               "C101", "C102", "C103", "C104", "C105", "C106", "C107", "C108",
                                               "C200", "C201", "C202", "C203", "C204", "C205", "C206", "C207", "C208",
                                               "C301", "C302", "C303", "C304", "C305", "C306", "C307", "C308",
                                               "C401", "C402", "C403", "C404", "C405", "C406", "C407", "C408",
                                               "C501", "C502", "C503", "C504", "C505", "C506", "C507", "C508",
                                               "D101", "D102", "D103", "D104", "D105", "D106", "D107", "D108",
                                               "D201", "D202", "D203", "D204", "D205", "D206", "D207", "D208",
                                               "D301", "D302", "D303", "D304", "D305", "D306", "D307", "D308",
                                               "D401", "D402", "D403", "D404", "D405", "D406", "D407", "D408",
                                               "D501", "D502", "D503", "D504", "D505", "D506", "D507", "D508",
                                               "E113", "E115", };

        // Dictionary for period time mapping
        private readonly Dictionary<string, string> PeriodTimeMap = new()
        {
            { "1-2èŠ‚", "08:00-09:40" },
            { "01-02èŠ‚", "08:00-09:40" },
            { "3-4èŠ‚", "09:55-11:35" },
            { "03-04èŠ‚", "09:55-11:35" },
            { "5-6èŠ‚", "13:30-15:10" },
            { "05-06èŠ‚", "13:30-15:10" },
            { "7-8èŠ‚", "15:25-17:05" },
            { "07-08èŠ‚", "15:25-17:05" },
            { "9-10èŠ‚", "18:00-19:35" },
            { "09-10èŠ‚", "18:00-19:35" },
            { "9-11èŠ‚", "18:00-20:30" },
            { "09-11èŠ‚", "18:00-20:30" }
        };

        public List<string> GetVacantRooms(string campus, string weekday, string period, string building, string week)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = _httpContextAccessor.HttpContext?.Request.Headers.UserAgent.ToString() ?? "";

            _logger.LogAccess(ip, "QUERY_VACANT_ROOMS", $"{campus.Substring(0, 2)} {weekday} {period} {building}æ¥¼ {week}", userAgent);

            var filePath = Path.Combine(AppContext.BaseDirectory, "Data", "schedule.xlsx");
            if (!File.Exists(filePath))
            {
                _logger.LogAccess(ip, "ERROR_FILE_NOT_FOUND", filePath, userAgent);
                return new List<string>();
            }

            var occupiedRooms = new HashSet<string>();

            using var workbook = new XLWorkbook(filePath);
            var sheet = workbook.Worksheets.First();

            foreach (var row in sheet.RowsUsed().Skip(1))
            {
                var rowCampus = row.Cell(10).GetString();
                var rowTime = row.Cell(14).GetString();
                var rowWeeks = row.Cell(15).GetString();
                var room = row.Cell(16).GetString();

                if (!room.Any()) continue;

                if (rowCampus != campus) continue;
                if (!IsPeriodMatch(rowTime, weekday, period)) continue;
                if (!IsWeekMatch(rowWeeks, week)) continue;

                occupiedRooms.Add(room);
            }

            var allRooms = list;
            var result = allRooms
                .Where(r => !occupiedRooms.Contains(r) &&
                            (building == "æ‰€æœ‰" || r.StartsWith(building)))
                .ToList();

            _logger.LogAccess(ip, "QUERY_RESULT", $"Found {result.Count} vacant rooms", userAgent);
            return result;
        }

        public List<RoomUsage> GetRoomUsage(string campus, string roomNumber, string weekday, string week)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = _httpContextAccessor.HttpContext?.Request.Headers.UserAgent.ToString() ?? "";

            _logger.LogAccess(ip, "QUERY_ROOM_USAGE", $"{campus.Substring(0, 2)} {roomNumber} {weekday} {week}", userAgent);

            var filePath = Path.Combine(AppContext.BaseDirectory, "Data", "schedule.xlsx");
            if (!File.Exists(filePath))
            {
                _logger.LogAccess(ip, "ERROR_FILE_NOT_FOUND", filePath, userAgent);
                return new List<RoomUsage>();
            }

            var roomUsages = new List<RoomUsage>();

            using var workbook = new XLWorkbook(filePath);
            var sheet = workbook.Worksheets.First();

            foreach (var row in sheet.RowsUsed().Skip(1))
            {
                var rowCampus = row.Cell(10).GetString();
                var rowTime = row.Cell(14).GetString();
                var rowWeeks = row.Cell(15).GetString();
                var room = row.Cell(16).GetString();
                var courseName = row.Cell(5).GetString();
                var teacher = row.Cell(12).GetString();

                if (string.IsNullOrEmpty(room)) continue;
                if (rowCampus != campus) continue;
                if (room != roomNumber) continue;
                if (!IsWeekdayMatch(rowTime, weekday)) continue;
                if (!IsWeekMatch(rowWeeks, week)) continue;

                var period = ExtractPeriodFromTime(rowTime);
                var timeRange = GetTimeRangeForPeriod(period);

                roomUsages.Add(new RoomUsage
                {
                    Period = period,
                    TimeRange = timeRange,
                    CourseName = courseName,
                    Teacher = teacher,
                });
            }

            var periodOrder = new Dictionary<string, int>
            {
                { "1-2èŠ‚", 1 }, { "01-02èŠ‚", 1 },
                { "3-4èŠ‚", 2 }, { "03-04èŠ‚", 2 },
                { "5-6èŠ‚", 3 }, { "05-06èŠ‚", 3 },
                { "7-8èŠ‚", 4 }, { "07-08èŠ‚", 4 },
                { "9-10èŠ‚", 5 }, { "09-10èŠ‚", 5 },
                { "9-11èŠ‚", 6 }, { "09-11èŠ‚", 6 },
                { "10-11èŠ‚", 7 }, { "10-12èŠ‚", 8 }
            };

            var result = roomUsages.OrderBy(r => periodOrder.GetValueOrDefault(r.Period, 999)).ToList();
            _logger.LogAccess(ip, "QUERY_RESULT", $"Found {result.Count} room usage records", userAgent);

            return result;
        }

        public List<string> GetRoomsForBuilding(string building)
        {
            if (string.IsNullOrEmpty(building)) return new List<string>();

            return list.Where(r => r.StartsWith(building))
                      .Select(r => r.Substring(1))
                      .Distinct()
                      .OrderBy(r => r)
                      .ToList();
        }

        // Keep all existing helper methods unchanged
        private bool IsWeekdayMatch(string rowTime, string selectedWeekday)
        {
            string ExtractWeekday(string text)
            {
                if (text.StartsWith("å‘¨") && text.Length >= 2)
                    return text.Substring(0, 2);
                return "";
            }

            return ExtractWeekday(rowTime) == ExtractWeekday(selectedWeekday);
        }

        private string ExtractPeriodFromTime(string rowTime)
        {
            var parts = rowTime.Split(' ');
            if (parts.Length > 1)
            {
                var periodPart = parts[1];
                if (periodPart.EndsWith("èŠ‚"))
                {
                    return periodPart;
                }
                else
                {
                    return periodPart + "èŠ‚";
                }
            }
            return "";
        }

        private string GetTimeRangeForPeriod(string period)
        {
            period = period.Replace("èŠ‚", "");
            if (!period.Contains("-"))
            {
                if (int.TryParse(period, out int num))
                {
                    period = $"{num}-{num}";
                }
            }
            period += "èŠ‚";

            return PeriodTimeMap.GetValueOrDefault(period, "æ—¶é—´æœªçŸ¥");
        }

        private bool IsWeekMatch(string rowWeeks, string selectedWeek)
        {
            if (!int.TryParse(selectedWeek.Replace("ç¬¬", "").Replace("å‘¨", ""), out int weekNumber))
                return false;

            rowWeeks = rowWeeks.Replace("å‘¨", "").Replace(" ", "");
            bool isSingle = rowWeeks.EndsWith("å•");
            bool isDouble = rowWeeks.EndsWith("åŒ");
            bool isAll = rowWeeks.EndsWith("å…¨");

            if (isSingle || isDouble || isAll)
                rowWeeks = rowWeeks.Substring(0, rowWeeks.Length - 1);

            var matched = false;

            foreach (var part in rowWeeks.Split(','))
            {
                if (part.Contains('-'))
                {
                    var bounds = part.Split('-');
                    if (bounds.Length == 2 &&
                        int.TryParse(bounds[0], out int start) &&
                        int.TryParse(bounds[1], out int end))
                    {
                        if (weekNumber >= start && weekNumber <= end)
                        {
                            matched = true;
                            break;
                        }
                    }
                }
                else if (int.TryParse(part, out int val))
                {
                    if (val == weekNumber)
                    {
                        matched = true;
                        break;
                    }
                }
            }

            if (!matched) return false;

            if (isSingle && weekNumber % 2 == 0) return false;
            if (isDouble && weekNumber % 2 != 0) return false;

            return true;
        }

        private bool IsPeriodMatch(string rowTime, string selectedWeekday, string selectedPeriod)
        {
            string Normalize(string text) => text.Replace("èŠ‚", "").Replace(" ", "");

            string ExtractWeekday(string text)
            {
                if (text.StartsWith("å‘¨") && text.Length >= 2)
                    return text.Substring(0, 2);
                return "";
            }

            string ExtractRange(string text)
            {
                var norm = Normalize(text);
                var idx = norm.IndexOfAny("ä¸€äºŒä¸‰å››äº”å…­æ—¥".ToCharArray());
                if (idx >= 0 && idx + 1 < norm.Length)
                    return norm.Substring(idx + 1);
                return "";
            }

            bool TryParseRange(string range, out int start, out int end)
            {
                start = end = 0;
                var nums = range.Split('-');
                if (nums.Length == 2 &&
                    int.TryParse(nums[0], out start) &&
                    int.TryParse(nums[1], out end)) return true;
                return false;
            }

            string rowWeekday = ExtractWeekday(rowTime);
            string userWeekday = ExtractWeekday(selectedWeekday);

            if (rowWeekday != userWeekday) return false;

            string rowRange = ExtractRange(rowTime);
            string userRange = Normalize(selectedPeriod);

            if (TryParseRange(rowRange, out int rowStart, out int rowEnd) &&
                TryParseRange(userRange, out int userStart, out int userEnd))
            {
                return userStart >= rowStart && userEnd <= rowEnd;
            }

            return false;
        }
    }

    public class RoomUsage
    {
        public string Period { get; set; } = "";
        public string TimeRange { get; set; } = "";
        public string CourseName { get; set; } = "";
        public string Teacher { get; set; } = "";
    }
}


============================================================
FILE: VacantRoomWeb.csproj
============================================================
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
	  <AspNetCoreHostingModel>OutOfProcess</AspNetCoreHostingModel>
	  <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="ClosedXML" Version="0.105.0" />
  </ItemGroup>

  <ItemGroup>
    <Folder Include="Data\" />
  </ItemGroup>

  <ItemGroup>
    <None Update="Data\schedule.xlsx">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <ProjectExtensions><VisualStudio><UserProperties properties_4launchsettings_1json__JsonSchema="" /></VisualStudio></ProjectExtensions>

</Project>
    


============================================================
FILE: appsettings.Development.json
============================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}



============================================================
FILE: appsettings.json
============================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "AdminConfig": {
    "Username": "admin_origami",
    "PasswordHash": "JZbYNmQ8Yi6IRfEht363YGJgjY5eaB7UsfyggX953KQ=",
    "Salt": "2BfcmATnJ9qH8oMxrOXqn7JFwQ+mbf5QdGwv76nFmjI=",
    "SecretKey": "mflfYqSSkeacMKzgcH4faGv6FcpYEme9ssPwUEVplacVPYTgYwvomwGkftir+lqdvPolUbsilnmX97vcXeyqCA=="
  },
  "EmailConfig": {
    "SmtpServer": "smtp.example.com",
    "Port": 587,
    "Username": "security@origami7023.cn",
    "Password": "your_email_password",
    "FromAddress": "security@origami7023.cn",
    "ToAddress": "admin@origami7023.cn",
    "EnableSsl": true
  }
}


============================================================
FILE: wwwroot\app.css
============================================================
html, body {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

a, .btn-link {
    color: #006bb7;
}

.btn-primary {
    color: #fff;
    background-color: #1b6ec2;
    border-color: #1861ac;
}

.btn:focus, .btn:active:focus, .btn-link.nav-link:focus, .form-control:focus, .form-check-input:focus {
  box-shadow: 0 0 0 0.1rem white, 0 0 0 0.25rem #258cfb;
}

.content {
    padding-top: 1.1rem;
}

h1:focus {
    outline: none;
}

.valid.modified:not([type=checkbox]) {
    outline: 1px solid #26b050;
}

.invalid {
    outline: 1px solid #e50000;
}

.validation-message {
    color: #e50000;
}

.blazor-error-boundary {
    background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTYiIGhlaWdodD0iNDkiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIG92ZXJmbG93PSJoaWRkZW4iPjxkZWZzPjxjbGlwUGF0aCBpZD0iY2xpcDAiPjxyZWN0IHg9IjIzNSIgeT0iNTEiIHdpZHRoPSI1NiIgaGVpZ2h0PSI0OSIvPjwvY2xpcFBhdGg+PC9kZWZzPjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMCkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yMzUgLTUxKSI+PHBhdGggZD0iTTI2My41MDYgNTFDMjY0LjcxNyA1MSAyNjUuODEzIDUxLjQ4MzcgMjY2LjYwNiA1Mi4yNjU4TDI2Ny4wNTIgNTIuNzk4NyAyNjcuNTM5IDUzLjYyODMgMjkwLjE4NSA5Mi4xODMxIDI5MC41NDUgOTIuNzk1IDI5MC42NTYgOTIuOTk2QzI5MC44NzcgOTMuNTEzIDI5MSA5NC4wODE1IDI5MSA5NC42NzgyIDI5MSA5Ny4wNjUxIDI4OS4wMzggOTkgMjg2LjYxNyA5OUwyNDAuMzgzIDk5QzIzNy45NjMgOTkgMjM2IDk3LjA2NTEgMjM2IDk0LjY3ODIgMjM2IDk0LjM3OTkgMjM2LjAzMSA5NC4wODg2IDIzNi4wODkgOTMuODA3MkwyMzYuMzM4IDkzLjAxNjIgMjM2Ljg1OCA5Mi4xMzE0IDI1OS40NzMgNTMuNjI5NCAyNTkuOTYxIDUyLjc5ODUgMjYwLjQwNyA1Mi4yNjU4QzI2MS4yIDUxLjQ4MzcgMjYyLjI5NiA1MSAyNjMuNTA2IDUxWk0yNjMuNTg2IDY2LjAxODNDMjYwLjczNyA2Ni4wMTgzIDI1OS4zMTMgNjcuMTI0NSAyNTkuMzEzIDY5LjMzNyAyNTkuMzEzIDY5LjYxMDIgMjU5LjMzMiA2OS44NjA4IDI1OS4zNzEgNzAuMDg4N0wyNjEuNzk1IDg0LjAxNjEgMjY1LjM4IDg0LjAxNjEgMjY3LjgyMSA2OS43NDc1QzI2Ny44NiA2OS43MzA5IDI2Ny44NzkgNjkuNTg3NyAyNjcuODc5IDY5LjMxNzkgMjY3Ljg3OSA2Ny4xMTgyIDI2Ni40NDggNjYuMDE4MyAyNjMuNTg2IDY2LjAxODNaTTI2My41NzYgODYuMDU0N0MyNjEuMDQ5IDg2LjA1NDcgMjU5Ljc4NiA4Ny4zMDA1IDI1OS43ODYgODkuNzkyMSAyNTkuNzg2IDkyLjI4MzcgMjYxLjA0OSA5My41Mjk1IDI2My41NzYgOTMuNTI5NSAyNjYuMTE2IDkzLjUyOTUgMjY3LjM4NyA5Mi4yODM3IDI2Ny4zODcgODkuNzkyMSAyNjcuMzg3IDg3LjMwMDUgMjY2LjExNiA4Ni4wNTQ3IDI2My41NzYgODYuMDU0N1oiIGZpbGw9IiNGRkU1MDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvZz48L3N2Zz4=) no-repeat 1rem/1.8rem, #b32121;
    padding: 1rem 1rem 1rem 3.7rem;
    color: white;
}

    .blazor-error-boundary::after {
        content: "An error has occurred."
    }

.darker-border-checkbox.form-check-input {
    border-color: #929292;
}

.query-card {
    background-color: #222;
    padding: 20px;
    border-radius: 10px;
    width: 300px;
}

.form-group {
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

    .form-group label {
        color: white;
        width: 80px;
    }

select {
    background-color: #333;
    color: white;
    border: 1px solid #555;
    padding: 5px;
    width: 150px;
}

.btn {
    background-color: #4CAF50;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

    .btn:hover {
        background-color: #45a049;
    }

.red {
    color: #ff6666;
}

.orange {
    color: #f4a261;
}

.gray {
    color: #aaa;
}



============================================================
FILE: wwwroot\css\layout.css
============================================================
ï»¿/* Full height layout */
html, body {
    height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

.page-wrapper {
    height: 100vh !important;
    display: flex !important;
    flex-direction: column !important;
}

.page {
    flex: 1 !important;
    display: flex !important;
    min-height: 0 !important;
}

/* Sidebar styling */
.sidebar {
    width: 250px !important;
    flex-shrink: 0 !important;
}

/* Main content area with sticky footer */
main {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important;
}

.content {
    flex: 1 !important;
    overflow-y: auto !important;
}

/* Sticky footer - always at bottom of main area */
.sticky-footer {
    background-color: #f8f9fa !important;
    border-top: 1px solid #dee2e6 !important;
    padding: 15px !important;
    text-align: center !important;
    color: #6c757d !important;
    font-size: 0.875rem !important;
    white-space: nowrap !important;
    flex-shrink: 0 !important;
}

    .sticky-footer a {
        color: #007bff !important;
        text-decoration: underline !important;
    }

        .sticky-footer a:hover {
            color: #0056b3 !important;
            text-decoration: underline !important;
        }

/* Mobile responsiveness */
@media (max-width: 768px) {
    .sidebar {
        width: 100% !important;
        height: auto !important;
    }

    .page {
        flex-direction: column !important;
    }

    .sticky-footer {
        white-space: normal !important;
        font-size: 0.8rem !important;
        padding: 10px !important;
    }
}



================================================================================
END OF CODE FILES
================================================================================
