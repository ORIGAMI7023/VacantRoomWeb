================================================================================
æ‰“åŒ…æ—¶é—´: 2025å¹´09æœˆ23æ—¥ 09:31
VACANTROOM WEB PROJECT - ALL CODE FILES
================================================================================


============================================================
FILE: AdminAuthService.cs
============================================================
ï»¿using System.Security.Cryptography;
using System.Text;
using Microsoft.JSInterop;

namespace VacantRoomWeb
{
    public class AdminConfig
    {
        public string Username { get; set; } = "";
        public string PasswordHash { get; set; } = "";
        public string Salt { get; set; } = "";
    }

    public class AdminAuthService
    {
        private readonly IConfiguration _configuration;
        private readonly SecurityService _securityService;
        private readonly EnhancedLoggingService _logger;
        private readonly IHttpContextAccessor _httpContextAccessor;

        public AdminAuthService(
            IConfiguration configuration,
            SecurityService securityService,
            EnhancedLoggingService logger,
            IHttpContextAccessor httpContextAccessor)
        {
            _configuration = configuration;
            _securityService = securityService;
            _logger = logger;
            _httpContextAccessor = httpContextAccessor;
        }

        public bool ValidateCredentials(string username, string password)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = _httpContextAccessor.HttpContext?.Request.Headers.UserAgent.ToString() ?? "";

            var adminConfig = _configuration.GetSection("AdminConfig").Get<AdminConfig>();

            if (adminConfig == null || string.IsNullOrEmpty(adminConfig.Username))
            {
                _logger.LogAccess(ip, "ADMIN_CONFIG_ERROR", "Admin configuration not found", userAgent);
                return false;
            }

            bool isValid = adminConfig.Username == username &&
                          VerifyPassword(password, adminConfig.PasswordHash, adminConfig.Salt);

            // Always check with security service to track attempts
            _securityService.CheckLoginAttempt(ip, isValid, userAgent);

            return isValid;
        }

        public async Task SetAuthCookieAsync(string username, IJSRuntime jsRuntime)
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return;

            var cookieValue = CreateAuthToken(username);
            var expires = DateTime.UtcNow.AddDays(7);

            // ä½¿ç”¨ JavaScript è®¾ç½® Cookie
            var secure = context.Request.IsHttps ? "secure; " : "";
            var cookieString = $"AdminAuth={cookieValue}; expires={expires:R}; path=/; {secure}samesite=strict";

            await jsRuntime.InvokeVoidAsync("eval", $"document.cookie = '{cookieString}'");

            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            _logger.LogAccess(ip, "ADMIN_AUTH_COOKIE_SET", username);
        }

        public void SetAuthCookie(string username)
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return;

            try
            {
                var cookieValue = CreateAuthToken(username);
                var options = new CookieOptions
                {
                    HttpOnly = true,
                    Secure = context.Request.IsHttps,
                    SameSite = SameSiteMode.Strict,
                    Expires = DateTime.UtcNow.AddDays(7)
                };

                context.Response.Cookies.Append("AdminAuth", cookieValue, options);

                var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
                _logger.LogAccess(ip, "ADMIN_AUTH_COOKIE_SET", username);
            }
            catch (InvalidOperationException)
            {
                // Response has already started, can't set cookie through HttpContext
                // This will be handled by the caller using JavaScript
                var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
                _logger.LogAccess(ip, "ADMIN_AUTH_COOKIE_SET_FAILED", "Response already started");
                throw;
            }
        }

        public bool IsAuthenticated()
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return false;

            var cookieValue = context.Request.Cookies["AdminAuth"];
            if (string.IsNullOrEmpty(cookieValue)) return false;

            return ValidateAuthToken(cookieValue);
        }

        public void SignOut()
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return;

            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";

            try
            {
                // å°è¯•é€šè¿‡ HttpContext åˆ é™¤ Cookie
                context.Response.Cookies.Delete("AdminAuth");
                _logger.LogAccess(ip, "ADMIN_LOGOUT", "Cookie deleted via HttpContext");
            }
            catch (InvalidOperationException)
            {
                // å“åº”å·²ç»å¼€å§‹ï¼Œæ— æ³•é€šè¿‡ HttpContext åˆ é™¤ Cookie
                // è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¾èµ–å‰ç«¯ JavaScript æ¥åˆ é™¤ Cookie
                _logger.LogAccess(ip, "ADMIN_LOGOUT", "Cookie will be deleted via JavaScript");
            }
        }

        // æ–°å¢ï¼šé€šè¿‡ JavaScript åˆ é™¤ Cookie çš„å¼‚æ­¥æ–¹æ³•
        public async Task SignOutAsync(IJSRuntime jsRuntime)
        {
            var context = _httpContextAccessor.HttpContext;
            if (context == null) return;

            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";

            try
            {
                // é¦–å…ˆå°è¯•é€šè¿‡ HttpContext åˆ é™¤
                context.Response.Cookies.Delete("AdminAuth");
                _logger.LogAccess(ip, "ADMIN_LOGOUT", "Cookie deleted via HttpContext");
            }
            catch (InvalidOperationException)
            {
                // å¦‚æœ HttpContext æ–¹å¼å¤±è´¥ï¼Œä½¿ç”¨ JavaScript åˆ é™¤
                await jsRuntime.InvokeVoidAsync("eval",
                    "document.cookie = 'AdminAuth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; samesite=strict'");
                _logger.LogAccess(ip, "ADMIN_LOGOUT", "Cookie deleted via JavaScript");
            }
        }

        private string CreateAuthToken(string username)
        {
            var timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds().ToString();
            var data = $"{username}:{timestamp}";
            var signature = ComputeHmac(data);
            return Convert.ToBase64String(Encoding.UTF8.GetBytes($"{data}:{signature}"));
        }

        private bool ValidateAuthToken(string token)
        {
            try
            {
                var decoded = Encoding.UTF8.GetString(Convert.FromBase64String(token));
                var parts = decoded.Split(':');

                if (parts.Length != 3) return false;

                var username = parts[0];
                var timestampStr = parts[1];
                var signature = parts[2];

                // Verify signature
                var data = $"{username}:{timestampStr}";
                var expectedSignature = ComputeHmac(data);
                if (signature != expectedSignature) return false;

                // Check expiration (7 days)
                if (long.TryParse(timestampStr, out var timestamp))
                {
                    var tokenTime = DateTimeOffset.FromUnixTimeSeconds(timestamp);
                    if (DateTime.UtcNow.Subtract(tokenTime.DateTime).TotalDays > 7)
                        return false;
                }

                return true;
            }
            catch
            {
                return false;
            }
        }

        private string ComputeHmac(string data)
        {
            var key = _configuration["AdminConfig:SecretKey"] ?? "DefaultSecretKey";
            using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(key));
            var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(data));
            return Convert.ToBase64String(hash);
        }

        private bool VerifyPassword(string password, string storedHash, string salt)
        {
            var hash = ComputePasswordHash(password, salt);
            return hash == storedHash;
        }

        public static string ComputePasswordHash(string password, string salt)
        {
            using var sha256 = SHA256.Create();
            var saltedPassword = salt + password;
            var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(saltedPassword));
            return Convert.ToBase64String(hash);
        }

        public static (string hash, string salt) CreatePasswordHash(string password)
        {
            var salt = GenerateSalt();
            var hash = ComputePasswordHash(password, salt);
            return (hash, salt);
        }

        private static string GenerateSalt()
        {
            var saltBytes = new byte[32];
            using var rng = RandomNumberGenerator.Create();
            rng.GetBytes(saltBytes);
            return Convert.ToBase64String(saltBytes);
        }

        public AdminConfig? GetAdminConfig()
        {
            return _configuration.GetSection("AdminConfig").Get<AdminConfig>();
        }

        public bool ValidatePassword(string password, string storedHash, string salt)
        {
            return VerifyPassword(password, storedHash, salt);
        }
    }
}


============================================================
FILE: ApplicationStartupService.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// è·Ÿè¸ªåº”ç”¨ç¨‹åºå®é™…å¯åŠ¨æ—¶é—´çš„æœåŠ¡
    /// </summary>
    public class ApplicationStartupService
    {
        // ä½¿ç”¨é™æ€å­—æ®µï¼Œä½†é€šè¿‡é™æ€æ„é€ å‡½æ•°ç¡®ä¿åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–
        private static readonly DateTime _applicationStartTime;

        static ApplicationStartupService()
        {
            _applicationStartTime = DateTime.Now;
        }

        public DateTime GetApplicationStartTime()
        {
            return _applicationStartTime;
        }

        public string GetUptime()
        {
            var uptime = DateTime.Now - _applicationStartTime;
            return $"{uptime.Days}d {uptime.Hours}h {uptime.Minutes}m";
        }

        public string GetDetailedUptime()
        {
            var uptime = DateTime.Now - _applicationStartTime;

            if (uptime.TotalDays >= 1)
            {
                return $"{uptime.Days}å¤© {uptime.Hours}å°æ—¶ {uptime.Minutes}åˆ†é’Ÿ";
            }
            else if (uptime.TotalHours >= 1)
            {
                return $"{uptime.Hours}å°æ—¶ {uptime.Minutes}åˆ†é’Ÿ";
            }
            else
            {
                return $"{uptime.Minutes}åˆ†é’Ÿ {uptime.Seconds}ç§’";
            }
        }

        /// <summary>
        /// è·å–åº”ç”¨ç¨‹åºå¯åŠ¨ç›¸å…³ä¿¡æ¯
        /// </summary>
        public Dictionary<string, string> GetStartupInfo()
        {
            var uptime = DateTime.Now - _applicationStartTime;

            return new Dictionary<string, string>
            {
                ["StartTime"] = _applicationStartTime.ToString("yyyy-MM-dd HH:mm:ss"),
                ["Uptime"] = GetDetailedUptime(),
                ["TotalHours"] = uptime.TotalHours.ToString("F1"),
                ["Environment"] = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") ?? "æœªçŸ¥",
                ["MachineName"] = Environment.MachineName,
                ["ProcessorCount"] = Environment.ProcessorCount.ToString(),
                ["WorkingSet"] = $"{Environment.WorkingSet / 1024 / 1024:F0} MB"
            };
        }
    }
}


============================================================
FILE: ClientConnectionTracker.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// ç”¨äºåœ¨ç”¨æˆ·è¿æ¥æ—¶è®°å½• IPï¼Œåœ¨æ–­å¼€æ—¶æŸ¥å‡ºå¯¹åº” IP
    /// </summary>
    public class ClientConnectionTracker
    {
        private readonly Dictionary<string, string> _ipMap = new();
        private readonly object _lock = new();

        public void SetClientIp(string circuitId, string ip)
        {
            lock (_lock)
            {
                _ipMap[circuitId] = ip;
            }
        }

        public string? GetClientIp(string circuitId)
        {
            lock (_lock)
            {
                return _ipMap.TryGetValue(circuitId, out var ip) ? ip : null;
            }
        }

        public void Remove(string circuitId)
        {
            lock (_lock)
            {
                _ipMap.Remove(circuitId);
            }
        }
    }

}



============================================================
FILE: Components\App.razor
============================================================
ï»¿<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="VacantRoomWeb.styles.css" />
    <link href="css/layout.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <HeadOutlet />
</head>

<body>
    <Routes />
    <script src="_framework/blazor.web.js"></script>
</body>

</html>


============================================================
FILE: Components\Layout\MainLayout.razor
============================================================
ï»¿@inherits LayoutComponentBase

<div class="page-wrapper">
    <div class="page">
        <div class="sidebar">
            <NavMenu />
        </div>

        <main>
            <div class="top-row px-4">
                <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
            </div>

            <div class="content px-4">
                @Body
            </div>

            <!-- Sticky Footer - always at bottom of main area -->
            <footer class="sticky-footer">
                Â©@(DateTime.Now.Year) origami7023.cn&nbsp;|&nbsp;
                <a href="https://beian.miit.gov.cn/" target="_blank">
                    æ²ªICPå¤‡2025129900å·-1
                </a>
            </footer>
        </main>
    </div>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">ğŸ—™</a>
</div>


============================================================
FILE: Components\Layout\NavMenu.razor
============================================================
ï»¿<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">VacantRoomWeb</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="">
                <span class="oi oi-list-rich" aria-hidden="true"></span> ç©ºæ•™å®¤æŸ¥è¯¢
            </NavLink>
        </div>
    </nav>
</div>


============================================================
FILE: Components\Pages\AdminDashboard.razor
============================================================
ï»¿@page "/admin"
@rendermode InteractiveServer
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject EnhancedLoggingService LoggingService
@inject ConnectionCounterService ConnectionService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ApplicationStartupService StartupService
@inject IEmailService EmailService
@inject IConfiguration Configuration

<PageTitle>ç®¡ç†åå°</PageTitle>

@if (!IsAuthenticated)
{
    <div class="loading-container">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
    </div>
}
else
{
    <div class="admin-dashboard">
        <div class="dashboard-header">
            <h1>ç®¡ç†åå°</h1>
            <div class="header-actions">
                <span class="user-info">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
                <button @onclick="HandleLogout" class="btn btn-outline-secondary btn-sm">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <h3>@CurrentConnections</h3>
                    <p>æ´»è·ƒè¿æ¥æ•°</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ›¡ï¸</div>
                <div class="stat-content">
                    <h3>@SecurityStats["TotalBannedIPs"]</h3>
                    <p>å·²å°ç¦IP</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-content">
                    <h3>@SecurityStats["RecentBreachAttempts"]</h3>
                    <p>è¿‘æœŸæ”»å‡»æ¬¡æ•°(24å°æ—¶)</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <h3>@LogStats["TodayLogs"]</h3>
                    <p>ä»Šæ—¥æ—¥å¿—æ€»æ•°</p>
                    <small>å†…å­˜: @LogStats["MemoryLogs"] æ¡</small>
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        @if ((bool)SecurityStats["AdminPanelLocked"])
        {
            <div class="alert alert-warning">
                <strong>âš ï¸ ç³»ç»Ÿè­¦å‘Šï¼š</strong> ç®¡ç†é¢æ¿ç›®å‰å¤„äºé”å®šçŠ¶æ€ï¼Œè§£é”æ—¶é—´ï¼š@SecurityStats["LockdownUntil"]
            </div>
        }

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tab-navigation">
            <button @onclick="() => SetActiveTab(0)" class="tab-btn @(ActiveTab == 0 ? "active" : "")">
                ğŸ“Š è®¿é—®æ—¥å¿—
            </button>
            <button @onclick="() => SetActiveTab(1)" class="tab-btn @(ActiveTab == 1 ? "active" : "")">
                ğŸ›¡ï¸ å®‰å…¨äº‹ä»¶
            </button>
            <button @onclick="() => SetActiveTab(2)" class="tab-btn @(ActiveTab == 2 ? "active" : "")">
                âš™ï¸ ç³»ç»Ÿä¿¡æ¯
            </button>
            <button @onclick="() => SetActiveTab(3)" class="tab-btn @(ActiveTab == 3 ? "active" : "")">
                ğŸ—‚ï¸ æ—¥å¿—ç®¡ç†
            </button>
            <button @onclick="() => SetActiveTab(4)" class="tab-btn @(ActiveTab == 4 ? "active" : "")">
                ğŸ“§ é‚®ä»¶ç®¡ç†
            </button>
        </div>

        <!-- æ ‡ç­¾é¡µå†…å®¹ -->
        <div class="tab-content">
            @if (ActiveTab == 0)
            {
                <!-- è®¿é—®æ—¥å¿—æ ‡ç­¾é¡µ -->
                <div class="logs-section">
                    <div class="section-header">
                        <h3>æœ€è¿‘è®¿é—®æ—¥å¿—</h3>
                        <div class="header-buttons">
                            <button @onclick="RefreshLogs" class="btn btn-primary btn-sm">ğŸ”„ åˆ·æ–°</button>
                            <button @onclick="ClearLogs" class="btn btn-warning btn-sm">ğŸ—‘ï¸ æ¸…ç©ºå†…å­˜æ—¥å¿—</button>
                        </div>
                    </div>

                    <div class="logs-table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th class="time-header">æ—¶é—´</th>
                                    <th class="ip-header">IPåœ°å€</th>
                                    <th class="action-header">æ“ä½œç±»å‹</th>
                                    <th class="details-header">è¯¦ç»†ä¿¡æ¯</th>
                                    <th class="ua-header">ç”¨æˆ·ä»£ç†</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in FilteredLogs.Take(50))
                                {
                                    <tr class="@GetLogRowClass(log.Action)">
                                        <td class="time-cell">@log.Timestamp.ToString("MM-dd HH:mm:ss")</td>
                                        <td class="ip-cell" title="ç‚¹å‡»å¤åˆ¶IPåœ°å€">@log.IP</td>
                                        <td class="action-cell" title="@log.Action">@FormatActionType(log.Action)</td>
                                        <td class="details-cell" title="@log.Details">@log.Details</td>
                                        <td class="ua-cell" title="@log.UserAgent">@TruncateUserAgent(log.UserAgent)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else if (ActiveTab == 1)
            {
                <!-- å®‰å…¨äº‹ä»¶æ ‡ç­¾é¡µ -->
                <div class="security-section">
                    <div class="section-header">
                        <h3>å®‰å…¨äº‹ä»¶</h3>
                        <button @onclick="RefreshSecurity" class="btn btn-primary btn-sm">ğŸ”„ åˆ·æ–°</button>
                    </div>

                    <div class="security-events">
                        @foreach (var secEvent in SecurityEvents)
                        {
                            <div class="security-event @GetSecurityEventClass(secEvent.EventType)">
                                <div class="event-header">
                                    <span class="event-type">@secEvent.EventType</span>
                                    <span class="event-time">@secEvent.Timestamp.ToString("MM-dd HH:mm:ss")</span>
                                </div>
                                <div class="event-details">
                                    <strong>IPåœ°å€ï¼š</strong> @secEvent.IP<br />
                                    <strong>è¯¦ç»†ä¿¡æ¯ï¼š</strong> @secEvent.Details
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (ActiveTab == 2)
            {
                <!-- ç³»ç»Ÿä¿¡æ¯æ ‡ç­¾é¡µ -->
                <div class="system-section">
                    <div class="section-header">
                        <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                        <button @onclick="RefreshSystemInfo" class="btn btn-primary btn-sm">ğŸ”„ åˆ·æ–°</button>
                    </div>

                    <div class="info-grid">
                        <div class="info-card">
                            <h4>æœåŠ¡å™¨çŠ¶æ€</h4>
                            <p><strong>å¯åŠ¨æ—¶é—´ï¼š</strong> @StartupService.GetApplicationStartTime().ToString("yyyy-MM-dd HH:mm:ss")</p>
                            <p><strong>è¿è¡Œæ—¶é—´ï¼š</strong> @StartupService.GetDetailedUptime()</p>
                            <p><strong>è¿è¡Œç¯å¢ƒï¼š</strong> @Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")</p>
                            <p><strong>æœåŠ¡å™¨æ—¶é—´ï¼š</strong> @DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</p>
                            <p><strong>æœºå™¨åç§°ï¼š</strong> @Environment.MachineName</p>
                            <p><strong>å†…å­˜ä½¿ç”¨ï¼š</strong> @($"{Environment.WorkingSet / 1024 / 1024:F0} MB")</p>
                        </div>

                        <div class="info-card">
                            <h4>å®‰å…¨çŠ¶æ€</h4>
                            <p><strong>æ´»è·ƒIPè·Ÿè¸ªï¼š</strong> @SecurityStats.GetValueOrDefault("ActiveIPTracking", "æœªçŸ¥")</p>
                            <p><strong>é¢æ¿é”å®šï¼š</strong> @((bool)SecurityStats.GetValueOrDefault("AdminPanelLocked", false) ? "æ˜¯" : "å¦")</p>
                            <p><strong>å¯ç”¨æ—¥å¿—æ—¥æœŸï¼š</strong> @AvailableLogDates.Count ä¸ª</p>
                            <p><strong>å½“å‰è¿æ¥æ•°ï¼š</strong> @CurrentConnections</p>
                            <p><strong>å·²å°ç¦IPï¼š</strong> @SecurityStats.GetValueOrDefault("TotalBannedIPs", "0")</p>
                        </div>

                        <div class="info-card">
                            <h4>æ—¥å¿—ç»Ÿè®¡</h4>
                            <p><strong>ä»Šæ—¥æ—¥å¿—æ€»æ•°ï¼š</strong> @LogStats.GetValueOrDefault("TodayLogs", "æœªçŸ¥")</p>
                            <p><strong>å†…å­˜æ—¥å¿—æ•°ï¼š</strong> @LogStats.GetValueOrDefault("MemoryLogs", "æœªçŸ¥")</p>
                            <p><strong>ä»Šæ—¥å”¯ä¸€IPï¼š</strong> @LogStats.GetValueOrDefault("TodayUniqueIPs", "æœªçŸ¥")</p>
                            <p><strong>ä»Šæ—¥å®‰å…¨äº‹ä»¶ï¼š</strong> @LogStats.GetValueOrDefault("TodaySecurityEvents", "æœªçŸ¥")</p>
                            <p><strong>ä»Šæ—¥ç®¡ç†äº‹ä»¶ï¼š</strong> @LogStats.GetValueOrDefault("TodayAdminEvents", "æœªçŸ¥")</p>
                            <p><strong>æ—¥å¿—æ–‡ä»¶å¤§å°ï¼š</strong> @LogStats.GetValueOrDefault("TodayLogFileSize", "æœªçŸ¥")</p>
                        </div>
                    </div>
                </div>
            }
            else if (ActiveTab == 3)
            {
                <!-- æ—¥å¿—ç®¡ç†æ ‡ç­¾é¡µ -->
                <div class="log-management-section">
                    <h3>æ—¥å¿—ç®¡ç†</h3>

                    <div class="management-actions">
                        <div class="action-group">
                            <h4>æ—¥å¿—è¿‡æ»¤</h4>
                            <div class="filter-controls">
                                <select @bind="LogFilter" class="form-control">
                                    <option value="ALL">æ‰€æœ‰æ—¥å¿—</option>
                                    <option value="SECURITY">å®‰å…¨äº‹ä»¶</option>
                                    <option value="ADMIN">ç®¡ç†æ“ä½œ</option>
                                    <option value="ACCESS">é¡µé¢è®¿é—®</option>
                                    <option value="CONNECTION">è¿æ¥äº‹ä»¶</option>
                                </select>
                                <button @onclick="ApplyFilter" class="btn btn-primary btn-sm">åº”ç”¨è¿‡æ»¤</button>
                            </div>
                        </div>

                        <div class="action-group">
                            <h4>æ—¥å¿—ç»´æŠ¤</h4>
                            <div class="maintenance-controls">
                                <button @onclick="ClearLogs" class="btn btn-warning">æ¸…ç©ºå†…å­˜æ—¥å¿—</button>
                                <button @onclick="CleanupOldLogs" class="btn btn-danger">æ¸…ç†30å¤©å‰æ—¥å¿—æ–‡ä»¶</button>
                                <button @onclick="ExportLogs" class="btn btn-info">å¯¼å‡ºå½“æ—¥æ—¥å¿—</button>
                            </div>
                        </div>

                        <div class="action-group">
                            <h4>æ—¥å¿—æ–‡ä»¶</h4>
                            <div class="log-files">
                                @foreach (var fileInfo in LogFileInfo.Take(10))
                                {
                                    <div class="log-file-item">
                                        <div class="log-file-details">
                                            <span class="log-date">@fileInfo.Date</span>
                                            <span class="log-count">@fileInfo.Count æ¡</span>
                                            <span class="log-size">@fileInfo.Size</span>
                                        </div>
                                        <button @onclick="() => ViewLogFile(fileInfo.Date)" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹</button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (ActiveTab == 4)
            {
                <!-- é‚®ä»¶ç®¡ç†æ ‡ç­¾é¡µ -->
                <div class="email-management-section">
                    <div class="section-header">
                        <h3>é‚®ä»¶é€šçŸ¥ç®¡ç†</h3>
                        <button @onclick="RefreshEmailStatus" class="btn btn-primary btn-sm">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                    </div>

                    <div class="email-stats">
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ“§</div>
                            <div class="stat-content">
                                <h3>@EmailStats["TotalSent"]</h3>
                                <p>é‚®ä»¶å‘é€æ€»æ•°</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">âœ…</div>
                            <div class="stat-content">
                                <h3>@EmailStats["SuccessRate"]%</h3>
                                <p>æˆåŠŸå‘é€ç‡</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">â°</div>
                            <div class="stat-content">
                                <h3>@EmailStats["LastSent"]</h3>
                                <p>æœ€åå‘é€æ—¶é—´</p>
                            </div>
                        </div>
                    </div>

                    <div class="email-actions">
                        <div class="action-group">
                            <h4>é‚®ä»¶æœåŠ¡æµ‹è¯•</h4>
                            <div class="test-controls">
                                <button @onclick="TestEmailService"
                                        disabled="@IsEmailTesting"
                                        class="btn btn-primary">
                                    @if (IsEmailTesting)
                                    {
                                        <span>â³ æµ‹è¯•ä¸­...</span>
                                    }
                                    else
                                    {
                                        <span>ğŸ“§ å‘é€æµ‹è¯•é‚®ä»¶</span>
                                    }
                                </button>
                            </div>

                            @if (!string.IsNullOrEmpty(EmailTestResult))
                            {
                                <div class="test-result @(EmailTestSuccess ? "success" : "error")">
                                    @EmailTestResult
                                </div>
                            }
                        </div>

                        <div class="action-group">
                            <h4>é‚®ä»¶é…ç½®</h4>
                            <div class="config-display">
                                <p><strong>APIåœ°å€ï¼š</strong> @EmailConfig["ApiUrl"]</p>
                                <p><strong>æ”¶ä»¶äººï¼š</strong> @EmailConfig["Recipient"]</p>
                                <p><strong>å†·å´æ—¶é—´ï¼š</strong> @EmailConfig["Cooldown"] åˆ†é’Ÿ</p>
                                <p>
                                    <strong>æœåŠ¡çŠ¶æ€ï¼š</strong>
                                    <span class="@(EmailConfig["ServiceStatus"] == "æ­£å¸¸" ? "status-ok" : "status-error")">
                                        @EmailConfig["ServiceStatus"]
                                    </span>
                                </p>
                            </div>
                        </div>

                        <div class="action-group">
                            <h4>å®‰å…¨è­¦æŠ¥è®¾ç½®</h4>
                            <div class="alert-settings">
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" @bind="EmailSettings.EnableDDoSAlerts" />
                                        DDoSæ”»å‡»è­¦æŠ¥
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" @bind="EmailSettings.EnableBruteForceAlerts" />
                                        æš´åŠ›ç ´è§£è­¦æŠ¥
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" @bind="EmailSettings.EnableSystemLockdownAlerts" />
                                        ç³»ç»Ÿé”å®šè­¦æŠ¥
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" @bind="EmailSettings.EnableIPBanAlerts" />
                                        IPå°ç¦è­¦æŠ¥
                                    </label>
                                </div>

                                <button @onclick="SaveEmailSettings" class="btn btn-success btn-sm">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                            </div>
                        </div>

                        <div class="action-group">
                            <h4>æ‰‹åŠ¨å‘é€é€šçŸ¥</h4>
                            <div class="manual-send">
                                <div class="form-group">
                                    <label>ä¸»é¢˜ï¼š</label>
                                    <input @bind="ManualEmailSubject" class="form-control" placeholder="è¾“å…¥é‚®ä»¶ä¸»é¢˜" />
                                </div>
                                <div class="form-group">
                                    <label>å†…å®¹ï¼š</label>
                                    <textarea @bind="ManualEmailContent" class="form-control" rows="4" placeholder="è¾“å…¥é‚®ä»¶å†…å®¹"></textarea>
                                </div>
                                <button @onclick="SendManualEmail"
                                        disabled="@(string.IsNullOrEmpty(ManualEmailSubject) || IsEmailTesting)"
                                        class="btn btn-info">
                                    ğŸ“¤ å‘é€é€šçŸ¥é‚®ä»¶
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .admin-dashboard {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

        .dashboard-header h1 {
            color: #333;
            margin: 0;
        }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-info {
        color: #666;
        font-weight: 500;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .stat-icon {
        font-size: 2rem;
    }

    .stat-content h3 {
        margin: 0;
        font-size: 1.8rem;
        color: #333;
    }

    .stat-content p {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.9rem;
    }

    .tab-navigation {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 5px 5px 0 0;
        font-weight: 500;
        transition: all 0.3s;
    }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:not(.active):hover {
            background: #f8f9fa;
        }

    .tab-content {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
    }

    /* ä¼˜åŒ–çš„è¡¨æ ¼æ ·å¼ */
    .logs-table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        background: white;
    }

    .logs-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        font-family: 'Consolas', 'Monaco', monospace;
    }

        .logs-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #5a67d8;
            font-size: 0.9rem;
        }

        .logs-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: top;
            word-break: break-word;
        }

        .logs-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .logs-table tr:hover {
            background-color: #e3f2fd;
            transition: background-color 0.2s;
        }

        /* ä¼˜åŒ–åˆ—å®½ */
        .logs-table .time-cell {
            width: 140px;
            min-width: 140px;
            font-family: monospace;
            color: #495057;
            font-weight: 500;
        }

        .logs-table .ip-cell {
            width: 120px;
            min-width: 120px;
            font-family: monospace;
            color: #007bff;
            font-weight: 600;
        }

        .logs-table .action-cell {
            width: 180px;
            min-width: 180px;
            font-weight: 600;
        }

        .logs-table .details-cell {
            width: 300px;
            min-width: 250px;
            color: #6c757d;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .logs-table .ua-cell {
            width: 250px;
            min-width: 200px;
            color: #868e96;
            font-size: 0.75rem;
            line-height: 1.3;
        }

    /* æ“ä½œç±»å‹çš„é¢œè‰²æ ‡è¯† */
    .security-row {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107;
    }

        .security-row .action-cell {
            color: #856404;
            font-weight: bold;
        }

    .error-row {
        background-color: #f8d7da !important;
        border-left: 4px solid #dc3545;
    }

        .error-row .action-cell {
            color: #721c24;
            font-weight: bold;
        }

    .access-row {
        background-color: #d1ecf1 !important;
        border-left: 4px solid #17a2b8;
    }

        .access-row .action-cell {
            color: #0c5460;
            font-weight: bold;
        }

    /* é»˜è®¤è¡Œæ ·å¼ */
    .logs-table tr:not(.security-row):not(.error-row):not(.access-row) {
        border-left: 4px solid #28a745;
    }

        .logs-table tr:not(.security-row):not(.error-row):not(.access-row) .action-cell {
            color: #155724;
            font-weight: bold;
        }

    /* å®‰å…¨äº‹ä»¶æ ·å¼ */
    .security-events {
        max-height: 600px;
        overflow-y: auto;
    }

    .security-event {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
    }

        .security-event.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }

        .security-event.danger {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

    .event-header {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        margin-bottom: 8px;
    }

    /* ç³»ç»Ÿä¿¡æ¯æ ·å¼ */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .info-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

        .info-card h4 {
            margin-top: 0;
            color: #333;
        }

    /* æ—¥å¿—ç®¡ç†æ ·å¼ */
    .management-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .action-group {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

        .action-group h4 {
            margin-top: 0;
            color: #333;
        }

    .filter-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .maintenance-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .log-files {
        max-height: 200px;
        overflow-y: auto;
    }

    .log-file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #dee2e6;
    }

    .log-file-details {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .log-date {
        font-family: monospace;
        font-weight: 600;
        min-width: 80px;
    }

    .log-count {
        font-size: 0.9em;
        color: #6c757d;
        min-width: 60px;
    }

    .log-size {
        font-size: 0.9em;
        color: #6c757d;
        min-width: 60px;
    }

    /* é‚®ä»¶ç®¡ç†æ ·å¼ */
    .email-management-section {
        padding: 20px;
    }

    .email-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .email-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .action-group {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

        .action-group h4 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

    .test-controls {
        margin: 15px 0;
    }

    .test-result {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        font-weight: 500;
    }

        .test-result.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-result.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

    .config-display {
        background: white;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

        .config-display p {
            margin: 8px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

    .status-ok {
        color: #28a745;
        font-weight: bold;
    }

    .status-error {
        color: #dc3545;
        font-weight: bold;
    }

    .alert-settings {
        background: white;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .setting-item {
        margin: 10px 0;
        display: flex;
        align-items: center;
    }

        .setting-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }

        .setting-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

    .manual-send {
        background: white;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .form-group {
        margin-bottom: 15px;
    }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-outline-primary {
        background: transparent;
        color: #667eea;
        border: 1px solid #667eea;
    }

    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }

    .btn-success {
        background: #28a745;
        color: white;
        border: 1px solid #28a745;
    }

        .btn-success:hover:not(:disabled) {
            background: #218838;
            border-color: #1e7e34;
        }

    .btn-sm {
        padding: 5px 10px;
        font-size: 0.875rem;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* è­¦å‘Šæ¡†æ ·å¼ */
    .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }


    {
        grid-template-columns: 1fr;
    }

    .email-stats {
        grid-template-columns: 1fr;
    }

    .action-group {
        padding: 15px;
    }

    }
</style>


@code {
    private bool IsAuthenticated = false;
    private int ActiveTab = 0;
    private int CurrentConnections = 0;
    private List<LogEntry> RecentLogs = new();
    private List<LogEntry> FilteredLogs = new();
    private List<SecurityEvent> SecurityEvents = new();
    private Dictionary<string, object> SecurityStats = new();
    private Dictionary<string, object> LogStats = new();
    private List<string> AvailableLogDates = new();
    private List<(string Date, int Count, string Size)> LogFileInfo = new();
    private DateTime StartTime = DateTime.Now;
    private string LogFilter = "ALL";
    private Timer? _refreshTimer;

    // é‚®ä»¶ç®¡ç†ç›¸å…³å˜é‡
    private Dictionary<string, object> EmailStats = new();
    private Dictionary<string, string> EmailConfig = new();
    private EmailNotificationSettings EmailSettings = new();
    private bool IsEmailTesting = false;
    private string EmailTestResult = "";
    private bool EmailTestSuccess = false;
    private string ManualEmailSubject = "";
    private string ManualEmailContent = "";

    protected override async Task OnInitializedAsync()
    {
        IsAuthenticated = AuthService.IsAuthenticated();

        if (!IsAuthenticated)
        {
            Navigation.NavigateTo("/admin/login");
            return;
        }

        await LoadDashboardData();
        await LoadEmailData();

        // è®¾ç½®å®šæ—¶åˆ·æ–° - æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®
        _refreshTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                LogStats = LoggingService.GetLogStats();
                SecurityStats = SecurityService.GetSecurityStats();
                CurrentConnections = ConnectionService.GetCount();
                await LoadEmailData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    private async Task LoadDashboardData()
    {
        CurrentConnections = ConnectionService.GetCount();
        RecentLogs = LoggingService.GetRecentLogs(100);
        FilteredLogs = RecentLogs;
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        LogStats = LoggingService.GetLogStats();
        AvailableLogDates = LoggingService.GetAvailableLogDates();
        LogFileInfo = LoggingService.GetLogFileInfo();

        StateHasChanged();
    }

    // åŠ è½½é‚®ä»¶ç›¸å…³æ•°æ®
    private async Task LoadEmailData()
    {
        EmailStats = GetEmailStats();
        EmailConfig = GetEmailConfig();
        EmailSettings = GetEmailSettings();
    }

    // è·å–é‚®ä»¶ç»Ÿè®¡ä¿¡æ¯
    private Dictionary<string, object> GetEmailStats()
    {
        var recentLogs = LoggingService.GetRecentLogs(1000);
        var emailLogs = recentLogs.Where(l => l.Action.Contains("EMAIL") || l.Action.Contains("ALERT")).ToList();

        var totalSent = emailLogs.Count;
        var successCount = emailLogs.Count(l => !l.Details.Contains("å¤±è´¥") && !l.Details.Contains("error"));
        var successRate = totalSent > 0 ? (successCount * 100 / totalSent) : 100;

        var lastSent = emailLogs.OrderByDescending(l => l.Timestamp).FirstOrDefault()?.Timestamp.ToString("MM-dd HH:mm") ?? "æœªå‘é€";

        return new Dictionary<string, object>
        {
            ["TotalSent"] = totalSent,
            ["SuccessRate"] = successRate,
            ["LastSent"] = lastSent
        };
    }

    // è·å–é‚®ä»¶é…ç½®ä¿¡æ¯
    private Dictionary<string, string> GetEmailConfig()
    {
        var apiUrl = Configuration["Email:NotifyHubAPI:BaseUrl"] ?? "æœªé…ç½®";
        var recipient = Configuration["Email:DefaultRecipient"] ?? "æœªé…ç½®";

        return new Dictionary<string, string>
        {
            ["ApiUrl"] = apiUrl,
            ["Recipient"] = recipient,
            ["Cooldown"] = "5",
            ["ServiceStatus"] = "æ­£å¸¸"
        };
    }

    // è·å–é‚®ä»¶é€šçŸ¥è®¾ç½®
    private EmailNotificationSettings GetEmailSettings()
    {
        return new EmailNotificationSettings
        {
            EnableDDoSAlerts = true,
            EnableBruteForceAlerts = true,
            EnableSystemLockdownAlerts = true,
            EnableIPBanAlerts = true
        };
    }

    // æµ‹è¯•é‚®ä»¶æœåŠ¡
    private async Task TestEmailService()
    {
        IsEmailTesting = true;
        EmailTestResult = "";
        StateHasChanged();

        try
        {
            var success = await EmailService.TestEmailServiceAsync();

            if (success)
            {
                EmailTestResult = "âœ… é‚®ä»¶æœåŠ¡æµ‹è¯•æˆåŠŸï¼æµ‹è¯•é‚®ä»¶å·²å‘é€åˆ° " + (Configuration["Email:DefaultRecipient"] ?? "æœªçŸ¥é‚®ç®±");
                EmailTestSuccess = true;
            }
            else
            {
                EmailTestResult = "âŒ é‚®ä»¶æœåŠ¡æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œè¿æ¥";
                EmailTestSuccess = false;
            }
        }
        catch (Exception ex)
        {
            EmailTestResult = $"âŒ é‚®ä»¶æœåŠ¡æµ‹è¯•å¼‚å¸¸ï¼š{ex.Message}";
            EmailTestSuccess = false;
        }
        finally
        {
            IsEmailTesting = false;
            StateHasChanged();
        }
    }

    // åˆ·æ–°é‚®ä»¶çŠ¶æ€
    private async Task RefreshEmailStatus()
    {
        await LoadEmailData();
        StateHasChanged();
    }

    // ä¿å­˜é‚®ä»¶è®¾ç½®
    private async Task SaveEmailSettings()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("alert", "é‚®ä»¶è®¾ç½®å·²ä¿å­˜");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ä¿å­˜å¤±è´¥ï¼š{ex.Message}");
        }
    }

    // å‘é€æ‰‹åŠ¨é‚®ä»¶
    private async Task SendManualEmail()
    {
        if (string.IsNullOrEmpty(ManualEmailSubject) || string.IsNullOrEmpty(ManualEmailContent))
        {
            await JSRuntime.InvokeVoidAsync("alert", "è¯·å¡«å†™é‚®ä»¶ä¸»é¢˜å’Œå†…å®¹");
            return;
        }

        IsEmailTesting = true;
        StateHasChanged();

        try
        {
            var success = await EmailService.SendSystemNotificationAsync(ManualEmailSubject, ManualEmailContent);

            if (success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "é‚®ä»¶å‘é€æˆåŠŸï¼");
                ManualEmailSubject = "";
                ManualEmailContent = "";
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"é‚®ä»¶å‘é€å¼‚å¸¸ï¼š{ex.Message}");
        }
        finally
        {
            IsEmailTesting = false;
            StateHasChanged();
        }
    }

    private void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
    }

    private async Task RefreshLogs()
    {
        RecentLogs = LoggingService.GetRecentLogs(100);
        ApplyFilter();
        StateHasChanged();
    }

    private async Task RefreshSecurity()
    {
        SecurityEvents = SecurityService.GetRecentSecurityEvents(30);
        SecurityStats = SecurityService.GetSecurityStats();
        StateHasChanged();
    }

    private async Task RefreshStats()
    {
        LogStats = LoggingService.GetLogStats();
        SecurityStats = SecurityService.GetSecurityStats();
        CurrentConnections = ConnectionService.GetCount();
        StateHasChanged();
    }

    private async Task ClearLogs()
    {
        LoggingService.ClearRecentLogs();
        await RefreshLogs();
    }

    private async Task CleanupOldLogs()
    {
        LoggingService.CleanupOldLogs(30);
        AvailableLogDates = LoggingService.GetAvailableLogDates();
        StateHasChanged();
    }

    private async Task ExportLogs()
    {
        var today = DateTime.Now.ToString("yyyy-MM-dd");
        await JSRuntime.InvokeVoidAsync("alert", $"å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­ï¼Œå°†å¯¼å‡º {today} çš„æ—¥å¿—æ–‡ä»¶");
    }

    private async Task ViewLogFile(string date)
    {
        await JSRuntime.InvokeVoidAsync("alert", $"æŸ¥çœ‹åŠŸèƒ½å¼€å‘ä¸­ï¼Œå°†æ˜¾ç¤º {date} çš„æ—¥å¿—å†…å®¹");
    }

    private void ApplyFilter()
    {
        FilteredLogs = LogFilter switch
        {
            "SECURITY" => RecentLogs.Where(l => l.Action.StartsWith("SECURITY_")).ToList(),
            "ADMIN" => RecentLogs.Where(l => l.Action.Contains("ADMIN")).ToList(),
            "ACCESS" => RecentLogs.Where(l => l.Action == "ACCESS").ToList(),
            "CONNECTION" => RecentLogs.Where(l => l.Action.Contains("CONNECTION")).ToList(),
            _ => RecentLogs
        };
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        try
        {
            await AuthService.SignOutAsync(JSRuntime);
            await JSRuntime.InvokeVoidAsync("location.replace", "/admin/login");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Logout error: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("location.replace", "/admin/login");
        }
    }

    private string GetLogRowClass(string action)
    {
        if (action.StartsWith("SECURITY_")) return "security-row";
        if (action.StartsWith("ERROR_")) return "error-row";
        if (action == "ACCESS") return "access-row";
        return "";
    }

    private string GetSecurityEventClass(string eventType)
    {
        if (eventType.Contains("BRUTE_FORCE") || eventType.Contains("DDOS") || eventType.Contains("BANNED"))
            return "danger";
        return "warning";
    }

    private string TruncateUserAgent(string userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "N/A";
        return userAgent.Length > 30 ? userAgent.Substring(0, 30) + "..." : userAgent;
    }

    private string GetUptime()
    {
        var uptime = DateTime.Now - StartTime;
        return $"{uptime.Days}d {uptime.Hours}h {uptime.Minutes}m";
    }

    private string FormatActionType(string action)
    {
        return action switch
        {
            "ACCESS" => "é¡µé¢è®¿é—®",
            "BLAZOR_CONNECTION_UP" => "è¿æ¥å»ºç«‹",
            "BLAZOR_CONNECTION_DOWN" => "è¿æ¥æ–­å¼€",
            "LOCALHOST_ADMIN_ACCESS" => "æœ¬åœ°ç®¡ç†è®¿é—®",
            "ADMIN_SUBDOMAIN_ACCESS" => "ç®¡ç†åŸŸåè®¿é—®",
            "ADMIN_SUBDOMAIN_REDIRECT" => "ç®¡ç†åŸŸåé‡å®šå‘",
            "ADMIN_PATH_REWRITE" => "è·¯å¾„é‡å†™",
            "ADMIN_ACCESS_BLOCKED" => "ç®¡ç†è®¿é—®è¢«é˜»æ­¢",
            "ACCESS_DENIED_BANNED" => "è®¿é—®è¢«æ‹’ç»(IPå°ç¦)",
            "ACCESS_DENIED_LOCKDOWN" => "è®¿é—®è¢«æ‹’ç»(ç³»ç»Ÿé”å®š)",
            "SECURITY_DDOS_DETECTED" => "æ£€æµ‹åˆ°DDoSæ”»å‡»",
            "SECURITY_BRUTE_FORCE_DETECTED" => "æ£€æµ‹åˆ°æš´åŠ›ç ´è§£",
            "SECURITY_IP_BANNED" => "IPåœ°å€è¢«å°ç¦",
            "SECURITY_ADMIN_LOCKDOWN" => "ç®¡ç†é¢æ¿é”å®š",
            "ADMIN_LOGIN_SUCCESS" => "ç®¡ç†å‘˜ç™»å½•æˆåŠŸ",
            "ADMIN_LOGIN_FAILED" => "ç®¡ç†å‘˜ç™»å½•å¤±è´¥",
            "ADMIN_LOGOUT" => "ç®¡ç†å‘˜é€€å‡ºç™»å½•",
            "ADMIN_AUTH_COOKIE_SET" => "è®¾ç½®è®¤è¯Cookie",
            "EMAIL_ALERT_TRIGGERED" => "é‚®ä»¶è­¦æŠ¥è§¦å‘",
            "QUERY_VACANT_ROOMS" => "æŸ¥è¯¢ç©ºæ•™å®¤",
            "QUERY_ROOM_USAGE" => "æŸ¥è¯¢æ•™å®¤ä½¿ç”¨æƒ…å†µ",
            "QUERY_RESULT" => "æŸ¥è¯¢ç»“æœ",
            "ERROR_FILE_NOT_FOUND" => "æ–‡ä»¶æœªæ‰¾åˆ°é”™è¯¯",
            _ => action
        };
    }

    private async Task RefreshSystemInfo()
    {
        LogStats = LoggingService.GetLogStats();
        SecurityStats = SecurityService.GetSecurityStats();
        CurrentConnections = ConnectionService.GetCount();
        AvailableLogDates = LoggingService.GetAvailableLogDates();
        StateHasChanged();
    }
}


============================================================
FILE: Components\Pages\AdminLogin.razor
============================================================
ï»¿@page "/admin/login"
@rendermode InteractiveServer
@inject AdminAuthService AuthService
@inject SecurityService SecurityService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Admin Login</PageTitle>

<div style="max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc;">
    <h2>Admin Login</h2>

    <div style="margin-bottom: 15px;">
        <label>Username:</label><br />
        <input @bind="Username" @oninput="OnUsernameInput" type="text" style="width: 100%; padding: 8px;" />
    </div>

    <div style="margin-bottom: 15px;">
        <label>Password:</label><br />
        <input @bind="Password" @oninput="OnPasswordInput" type="password" style="width: 100%; padding: 8px;" />
    </div>

    <button @onclick="LoginTest" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; margin: 5px 0;">
        ç™»å½•
    </button>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; margin-top: 15px; max-height: 300px; overflow-y: auto;">
            <pre style="white-space: pre-wrap; font-size: 12px; margin: 0;">@Message</pre>
        </div>
    }
</div>

<style>
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .admin-dashboard {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e1e5e9;
    }

        .dashboard-header h1 {
            color: #333;
            margin: 0;
        }

    /* è¿™é‡Œæ·»åŠ æˆ‘ä¹‹å‰æä¾›çš„æ‰€æœ‰è¡¨æ ¼ä¼˜åŒ–æ ·å¼ */
    .logs-table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        background: white;
    }

    .logs-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        font-family: 'Consolas', 'Monaco', monospace;
    }

        .logs-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #5a67d8;
            font-size: 0.9rem;
        }

</style>

@code {
    private string Username = "";
    private string Password = "";
    private string Message = "";

    protected override async Task OnInitializedAsync()
    {
        // æ£€æŸ¥ç®¡ç†é¢æ¿é”å®šçŠ¶æ€
        if (SecurityService.IsAdminPanelLocked())
        {
            Message = "âš ï¸ ç®¡ç†é¢æ¿å·²é”å®š";
            return;
        }

        // å¦‚æœå·²è®¤è¯ï¼Œè·³è½¬åˆ°ä»ªè¡¨æ¿
        if (AuthService.IsAuthenticated())
        {
            await Task.Delay(100);
            Navigation.NavigateTo("/admin", true);
        }
    }

    private void OnUsernameInput(ChangeEventArgs e)
    {
        Username = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private void OnPasswordInput(ChangeEventArgs e)
    {
        Password = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private async Task LoginTest()
    {
        if (SecurityService.IsAdminPanelLocked())
        {
            Message = "âš ï¸ ç®¡ç†é¢æ¿å·²é”å®š";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrEmpty(Username) || string.IsNullOrEmpty(Password))
        {
            Message = "è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ";
            StateHasChanged();
            return;
        }

        try
        {
            var result = AuthService.ValidateCredentials(Username, Password);

            if (result)
            {
                try
                {
                    await AuthService.SetAuthCookieAsync(Username, JSRuntime);
                    Navigation.NavigateTo("/admin", forceLoad: true);
                }
                catch (Exception cookieEx)
                {
                    Message = $"Cookieè®¾ç½®å¤±è´¥: {cookieEx.Message}";
                    StateHasChanged();
                    return;
                }
            }
            else
            {
                Message = "ç™»å½•å¤±è´¥";
                Password = "";
            }
        }
        catch (Exception ex)
        {
            Message = $"ç™»å½•å¼‚å¸¸: {ex.Message}";
        }

        StateHasChanged();
    }
}


============================================================
FILE: Components\Pages\EmailTest.razor
============================================================
ï»¿@page "/admin/email-test"
@rendermode InteractiveServer
@inject IEmailService EmailService
@inject AdminAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>é‚®ä»¶æœåŠ¡æµ‹è¯•</PageTitle>

@if (!IsAuthenticated)
{
    <div class="loading-container">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
    </div>
}
else
{
    <div class="email-test-container">
        <div class="test-header">
            <h2>ğŸ“§ é‚®ä»¶æœåŠ¡æµ‹è¯•</h2>
            <p>æµ‹è¯• VacantRoomWeb é‚®ä»¶é€šçŸ¥ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        </div>

        <div class="test-section">
            <h3>åŸºç¡€é‚®ä»¶æµ‹è¯•</h3>
            <div class="test-card">
                <div class="test-description">
                    <h4>æœåŠ¡è¿é€šæ€§æµ‹è¯•</h4>
                    <p>æµ‹è¯•ä¸ NotifyHubAPI çš„è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œå‘é€ä¸€å°æµ‹è¯•é‚®ä»¶åˆ°é»˜è®¤æ”¶ä»¶äººã€‚</p>
                </div>
                <div class="test-action">
                    <button @onclick="RunBasicTest"
                            disabled="@IsTesting"
                            class="btn btn-primary">
                        @if (IsTesting && CurrentTest == "basic")
                        {
                            <span>ğŸ”„ æµ‹è¯•ä¸­...</span>
                        }
                        else
                        {
                            <span>ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•</span>
                        }
                    </button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>å®‰å…¨è­¦æŠ¥æµ‹è¯•</h3>
            <div class="test-card">
                <div class="test-description">
                    <h4>å®‰å…¨è­¦æŠ¥é‚®ä»¶</h4>
                    <p>æ¨¡æ‹Ÿå®‰å…¨äº‹ä»¶ï¼Œæµ‹è¯•å®‰å…¨è­¦æŠ¥é‚®ä»¶çš„å‘é€åŠŸèƒ½ã€‚</p>
                </div>
                <div class="test-action">
                    <button @onclick="RunSecurityTest"
                            disabled="@IsTesting"
                            class="btn btn-warning">
                        @if (IsTesting && CurrentTest == "security")
                        {
                            <span>ğŸ”„ æµ‹è¯•ä¸­...</span>
                        }
                        else
                        {
                            <span>âš ï¸ æµ‹è¯•å®‰å…¨è­¦æŠ¥</span>
                        }
                    </button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ç³»ç»Ÿé€šçŸ¥æµ‹è¯•</h3>
            <div class="test-card">
                <div class="test-description">
                    <h4>ç³»ç»Ÿé€šçŸ¥é‚®ä»¶</h4>
                    <p>æµ‹è¯•ç³»ç»Ÿé€šçŸ¥é‚®ä»¶çš„å‘é€åŠŸèƒ½ã€‚</p>
                </div>
                <div class="test-action">
                    <button @onclick="RunSystemNotificationTest"
                            disabled="@IsTesting"
                            class="btn btn-info">
                        @if (IsTesting && CurrentTest == "notification")
                        {
                            <span>ğŸ”„ æµ‹è¯•ä¸­...</span>
                        }
                        else
                        {
                            <span>ğŸ“¢ æµ‹è¯•ç³»ç»Ÿé€šçŸ¥</span>
                        }
                    </button>
                </div>
            </div>
        </div>

        @if (TestResults.Any())
        {
            <div class="results-section">
                <h3>æµ‹è¯•ç»“æœ</h3>
                <div class="results-container">
                    @foreach (var result in TestResults.OrderByDescending(r => r.Timestamp))
                    {
                        <div class="result-item @(result.Success ? "success" : "error")">
                            <div class="result-header">
                                <span class="result-type">@result.TestType</span>
                                <span class="result-time">@result.Timestamp.ToString("HH:mm:ss")</span>
                                <span class="result-status">@(result.Success ? "âœ… æˆåŠŸ" : "âŒ å¤±è´¥")</span>
                            </div>
                            <div class="result-message">
                                @result.Message
                            </div>
                            @if (!string.IsNullOrEmpty(result.Details))
                            {
                                <div class="result-details">
                                    <strong>è¯¦ç»†ä¿¡æ¯ï¼š</strong> @result.Details
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <div class="actions-section">
            <button @onclick="ClearResults" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            <button @onclick="GoBack" class="btn btn-outline-secondary">â† è¿”å›ç®¡ç†åå°</button>
        </div>
    </div>
}

<style>
    .email-test-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .test-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
    }

    .test-section {
        margin-bottom: 25px;
    }

        .test-section h3 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

    .test-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }

    .test-description {
        flex: 1;
    }

        .test-description h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .test-description p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9em;
        }

    .test-action {
        flex-shrink: 0;
    }

    .results-section {
        margin-top: 30px;
    }

    .results-container {
        max-height: 400px;
        overflow-y: auto;
    }

    .result-item {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid;
    }

        .result-item.success {
            background-color: #d4edda;
            border-left-color: #28a745;
        }

        .result-item.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .result-message {
        margin-bottom: 5px;
        font-size: 0.95em;
    }

    .result-details {
        font-size: 0.85em;
        color: #6c757d;
        font-family: monospace;
    }

    .actions-section {
        margin-top: 30px;
        text-align: center;
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    {
        flex-direction: column;
        text-align: center;
    }

    .actions-section {
        flex-direction: column;
        align-items: center;
    }

    }
</style>

@code {
    private bool IsAuthenticated = false;
    private bool IsTesting = false;
    private string CurrentTest = "";
    private List<TestResult> TestResults = new();

    protected override async Task OnInitializedAsync()
    {
        IsAuthenticated = AuthService.IsAuthenticated();

        if (!IsAuthenticated)
        {
            Navigation.NavigateTo("/admin/login");
            return;
        }
    }

    private async Task RunBasicTest()
    {
        IsTesting = true;
        CurrentTest = "basic";
        StateHasChanged();

        try
        {
            var success = await EmailService.TestEmailServiceAsync();

            AddTestResult("åŸºç¡€è¿é€šæ€§æµ‹è¯•", success,
                success ? "é‚®ä»¶æœåŠ¡è¿æ¥æ­£å¸¸ï¼Œæµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸ" : "é‚®ä»¶æœåŠ¡è¿æ¥å¤±è´¥æˆ–å‘é€å¤±è´¥",
                success ? "APIè¿æ¥æ­£å¸¸ï¼Œé‚®ä»¶å·²å‘é€åˆ°é»˜è®¤æ”¶ä»¶äºº" : "è¯·æ£€æŸ¥APIé…ç½®å’Œç½‘ç»œè¿æ¥");
        }
        catch (Exception ex)
        {
            AddTestResult("åŸºç¡€è¿é€šæ€§æµ‹è¯•", false, "æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸", ex.Message);
        }
        finally
        {
            IsTesting = false;
            CurrentTest = "";
            StateHasChanged();
        }
    }

    private async Task RunSecurityTest()
    {
        IsTesting = true;
        CurrentTest = "security";
        StateHasChanged();

        try
        {
            var success = await EmailService.SendSecurityAlertAsync(
                "æµ‹è¯•å®‰å…¨è­¦æŠ¥",
                "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å®‰å…¨è­¦æŠ¥ï¼Œç”¨äºéªŒè¯å®‰å…¨é‚®ä»¶é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚",
                "192.168.1.100");

            AddTestResult("å®‰å…¨è­¦æŠ¥æµ‹è¯•", success,
                success ? "å®‰å…¨è­¦æŠ¥é‚®ä»¶å‘é€æˆåŠŸ" : "å®‰å…¨è­¦æŠ¥é‚®ä»¶å‘é€å¤±è´¥",
                success ? "å®‰å…¨è­¦æŠ¥é‚®ä»¶å·²å‘é€ï¼ŒåŒ…å«å®Œæ•´çš„å®‰å…¨äº‹ä»¶ä¿¡æ¯" : "è¯·æ£€æŸ¥é‚®ä»¶æœåŠ¡é…ç½®");
        }
        catch (Exception ex)
        {
            AddTestResult("å®‰å…¨è­¦æŠ¥æµ‹è¯•", false, "æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸", ex.Message);
        }
        finally
        {
            IsTesting = false;
            CurrentTest = "";
            StateHasChanged();
        }
    }

    private async Task RunSystemNotificationTest()
    {
        IsTesting = true;
        CurrentTest = "notification";
        StateHasChanged();

        try
        {
            var success = await EmailService.SendSystemNotificationAsync(
                "ç³»ç»Ÿé€šçŸ¥æµ‹è¯•",
                "è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥æµ‹è¯•é‚®ä»¶ï¼Œç”¨äºéªŒè¯ç³»ç»Ÿé€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚ç³»ç»Ÿå½“å‰è¿è¡Œæ­£å¸¸ï¼Œæ‰€æœ‰æœåŠ¡éƒ½åœ¨çº¿ã€‚");

            AddTestResult("ç³»ç»Ÿé€šçŸ¥æµ‹è¯•", success,
                success ? "ç³»ç»Ÿé€šçŸ¥é‚®ä»¶å‘é€æˆåŠŸ" : "ç³»ç»Ÿé€šçŸ¥é‚®ä»¶å‘é€å¤±è´¥",
                success ? "ç³»ç»Ÿé€šçŸ¥é‚®ä»¶å·²å‘é€ï¼Œæ ¼å¼æ­£ç¡®" : "è¯·æ£€æŸ¥é‚®ä»¶æœåŠ¡é…ç½®");
        }
        catch (Exception ex)
        {
            AddTestResult("ç³»ç»Ÿé€šçŸ¥æµ‹è¯•", false, "æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸", ex.Message);
        }
        finally
        {
            IsTesting = false;
            CurrentTest = "";
            StateHasChanged();
        }
    }

    private void AddTestResult(string testType, bool success, string message, string details = "")
    {
        TestResults.Add(new TestResult
        {
            TestType = testType,
            Success = success,
            Message = message,
            Details = details,
            Timestamp = DateTime.Now
        });

        // åªä¿ç•™æœ€è¿‘10ä¸ªæµ‹è¯•ç»“æœ
        if (TestResults.Count > 10)
        {
            TestResults = TestResults.OrderByDescending(r => r.Timestamp).Take(10).ToList();
        }
    }

    private void ClearResults()
    {
        TestResults.Clear();
        StateHasChanged();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/admin");
    }

    public class TestResult
    {
        public string TestType { get; set; } = "";
        public bool Success { get; set; }
        public string Message { get; set; } = "";
        public string Details { get; set; } = "";
        public DateTime Timestamp { get; set; }
    }
}


============================================================
FILE: Components\Pages\Error.razor
============================================================
ï»¿@page "/Error"
@using System.Diagnostics

<PageTitle>Error</PageTitle>

<h1 class="text-danger">Error.</h1>
<h2 class="text-danger">An error occurred while processing your request.</h2>

@if (ShowRequestId)
{
    <p>
        <strong>Request ID:</strong> <code>@RequestId</code>
    </p>
}

<h3>Development Mode</h3>
<p>
    Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
</p>
<p>
    <strong>The Development environment shouldn't be enabled for deployed applications.</strong>
    It can result in displaying sensitive information from exceptions to end users.
    For local debugging, enable the <strong>Development</strong> environment by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
    and restarting the app.
</p>

@code{
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private string? RequestId { get; set; }
    private bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

    protected override void OnInitialized() =>
        RequestId = Activity.Current?.Id ?? HttpContext?.TraceIdentifier;
}



============================================================
FILE: Components\Pages\VacantRoom.razor
============================================================
ï»¿@page "/"
@rendermode InteractiveServer
@inject VacantRoomService VacantService

<h3 style="margin-bottom: 1rem;">æ•™å®¤æŸ¥è¯¢ç³»ç»Ÿ</h3>
<p style="font-size: 1.1rem; color: gray;">@TodayText</p>

<!-- Tab Navigation -->
<div style="margin-bottom: 2rem;">
    <button @onclick="() => SetActiveTab(0)"
            style="@GetTabStyle(0)">
        ç©ºæ•™å®¤æŸ¥è¯¢
    </button>
    <button @onclick="() => SetActiveTab(1)"
            style="@GetTabStyle(1)">
        æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢
    </button>
</div>

<div style="max-width: 500px;">

    @if (ActiveTab == 0)
    {
        <!-- ç©ºæ•™å®¤æŸ¥è¯¢ -->
        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ ¡åŒºï¼š</label>
            <select @bind="Campus" style="width: 200px;">
                <option value="å¥‰è´¤æ ¡åŒº">å¥‰è´¤</option>
                <option value="å¾æ±‡æ ¡åŒº">å¾æ±‡</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ˜ŸæœŸï¼š</label>
            <select @bind="Weekday" style="width: 200px;">
                <option>å‘¨ä¸€</option>
                <option>å‘¨äºŒ</option>
                <option>å‘¨ä¸‰</option>
                <option>å‘¨å››</option>
                <option>å‘¨äº”</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">èŠ‚æ¬¡ï¼š</label>
            <select @bind="Period" style="width: 200px;">
                <option>1-2èŠ‚</option>
                <option>3-4èŠ‚</option>
                <option>5-6èŠ‚</option>
                <option>7-8èŠ‚</option>
                <option>9-10èŠ‚</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å­¦æ¥¼ï¼š</label>
            <select @bind="Building" style="width: 200px;">
                <option>æ‰€æœ‰</option>
                <option>A</option>
                <option>B</option>
                <option>C</option>
                <option>D</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">ç¬¬å‡ å‘¨ï¼š</label>
            <select @bind="Week" style="width: 200px;">
                @for (int i = 1; i <= 18; i++)
                {
                    <option value="@($"ç¬¬{i}å‘¨")">ç¬¬ @i å‘¨</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <button @onclick="QueryVacantRooms" style="padding: 8px 16px; font-weight: bold; background-color: #007bff; color: white; border: none; border-radius: 4px;">
                æŸ¥è¯¢ç©ºæ•™å®¤
            </button>
        </div>

        <hr />

        <p style="color: red;">[Debug]å½“å‰é€‰ä¸­ï¼š @Campus, @Weekday, @Period, @Building, @Week</p>

        @if (VacantResult != null)
        {
            <p style="color: orange;">[Debug]å…±æŸ¥è¯¢åˆ° @VacantResult.Count ä¸ªç©ºæ•™å®¤</p>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 4px;">
                <ul style="margin: 0; padding-left: 20px;">
                    @foreach (var room in VacantResult)
                    {
                        <li>@room</li>
                    }
                </ul>
            </div>
        }
        else
        {
            <p style="color: gray;">è¯·å¡«å†™æ¡ä»¶åç‚¹å‡»æŸ¥è¯¢</p>
        }
    }
    else
    {
        <!-- æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢ -->
        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ ¡åŒºï¼š</label>
            <select @bind="RoomCampus" style="width: 200px;">
                <option value="å¥‰è´¤æ ¡åŒº">å¥‰è´¤</option>
                <option value="å¾æ±‡æ ¡åŒº">å¾æ±‡</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å­¦æ¥¼ï¼š</label>
            <select value="@RoomBuilding" @onchange="OnBuildingChanged" style="width: 200px;">
                <option value="">è¯·é€‰æ‹©æ•™å­¦æ¥¼</option>
                <option value="A">Aæ¥¼</option>
                <option value="B">Bæ¥¼</option>
                <option value="C">Cæ¥¼</option>
                <option value="D">Dæ¥¼</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å®¤å·ï¼š</label>
            <select @bind="RoomNumber" style="width: 200px;" disabled="@string.IsNullOrEmpty(RoomBuilding)">
                @if (string.IsNullOrEmpty(RoomBuilding))
                {
                    <option value="">è¯·å…ˆé€‰æ‹©æ•™å­¦æ¥¼</option>
                }
                else
                {
                    <option value="">è¯·é€‰æ‹©æ•™å®¤</option>
                    @foreach (var room in GetRoomsForBuilding(RoomBuilding))
                    {
                        <option value="@room">@room</option>
                    }
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ˜ŸæœŸï¼š</label>
            <select @bind="RoomWeekday" style="width: 200px;">
                <option>å‘¨ä¸€</option>
                <option>å‘¨äºŒ</option>
                <option>å‘¨ä¸‰</option>
                <option>å‘¨å››</option>
                <option>å‘¨äº”</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">ç¬¬å‡ å‘¨ï¼š</label>
            <select @bind="RoomWeek" style="width: 200px;">
                @for (int i = 1; i <= 18; i++)
                {
                    <option value="@($"ç¬¬{i}å‘¨")">ç¬¬ @i å‘¨</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <button @onclick="QueryRoomUsage"
                    disabled="@string.IsNullOrEmpty(RoomNumber)"
                    style="padding: 8px 16px; font-weight: bold; background-color: #28a745; color: white; border: none; border-radius: 4px; opacity: @(string.IsNullOrEmpty(RoomNumber) ? "0.5" : "1");">
                æŸ¥è¯¢æ•™å®¤ä½¿ç”¨æƒ…å†µ
            </button>
        </div>

        <hr />

        <p style="color: red;">[Debug]å½“å‰é€‰ä¸­ï¼š @RoomCampus, @RoomBuilding @RoomNumber, @RoomWeekday, @RoomWeek</p>

        @if (UsageResult != null)
        {
            <div style="border: 1px solid #ccc; border-radius: 4px; padding: 15px; background-color: #f8f9fa;">
                <h4 style="margin-top: 0; color: #495057;">@RoomBuilding@RoomNumber æ•™å®¤ä½¿ç”¨æƒ…å†µ</h4>
                <p style="color: #6c757d; margin-bottom: 15px;">@RoomCampus Â· @RoomWeekday Â· @RoomWeek</p>

                @if (UsageResult.Count == 0)
                {
                    <p style="color: green; font-weight: bold;">âœ… è¯¥æ•™å®¤å½“å¤©å…¨å¤©ç©ºé—²</p>
                }
                else
                {
                    <div style="display: grid; gap: 8px;">
                        @foreach (var usage in UsageResult)
                        {
                            <div style="background-color: white; padding: 12px; border-radius: 4px; border-left: 4px solid #dc3545;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: #dc3545;">@usage.Period</span>
                                    <span style="font-size: 0.9em; color: #6c757d;">@usage.TimeRange</span>
                                </div>
                                <div style="margin-top: 4px; color: #495057;">
                                    <strong>è¯¾ç¨‹ï¼š</strong>@usage.CourseName
                                </div>
                                @if (!string.IsNullOrEmpty(usage.Teacher))
                                {
                                    <div style="font-size: 0.9em; color: #6c757d;">
                                        <strong>æ•™å¸ˆï¼š</strong>@usage.Teacher
                                    </div>
                                }
                                
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <p style="color: gray;">è¯·é€‰æ‹©æ•™å®¤åç‚¹å‡»æŸ¥è¯¢</p>
        }
    }

</div>


@code {
    // Tab management
    int ActiveTab = 0;

    // ç©ºæ•™å®¤æŸ¥è¯¢ç›¸å…³å˜é‡
    string Campus = "å¥‰è´¤æ ¡åŒº";
    string Weekday = "";
    string Period = "1-2èŠ‚";
    string Building = "æ‰€æœ‰";
    string Week = "ç¬¬1å‘¨";
    List<string> VacantResult;

    // æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢ç›¸å…³å˜é‡
    string RoomCampus = "å¥‰è´¤æ ¡åŒº";
    string RoomBuilding = "";
    string RoomNumber = "";
    string RoomWeekday = "";
    string RoomWeek = "ç¬¬1å‘¨";
    List<VacantRoomWeb.RoomUsage> UsageResult;

    string TodayText;

    // RoomUsage class is now in VacantRoomService.cs

    void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
        // åˆ‡æ¢æ ‡ç­¾æ—¶æ¸…ç©ºç»“æœ
        if (tabIndex == 0)
        {
            UsageResult = null;
        }
        else
        {
            VacantResult = null;
        }
    }

    string GetTabStyle(int tabIndex)
    {
        var baseStyle = "padding: 10px 20px; margin-right: 5px; border: 1px solid #ccc; border-radius: 4px 4px 0 0; cursor: pointer; background-color: ";
        return baseStyle + (ActiveTab == tabIndex ? "#007bff; color: white;" : "#f8f9fa; color: #495057;");
    }

    // â€”â€” èŠ‚æ¬¡æ—¶é—´è¡¨ï¼ˆä»…ç”¨äºè‡ªåŠ¨é€‰æ‹©ï¼‰â€”â€”
    List<(TimeSpan Start, TimeSpan End, string Label)> PeriodSlots = new()
    {
        (new TimeSpan(8, 00, 00), new TimeSpan(9, 40, 00), "1-2èŠ‚"),
        (new TimeSpan(9, 55, 00), new TimeSpan(11, 35, 00), "3-4èŠ‚"),
        (new TimeSpan(13, 30, 00), new TimeSpan(15, 10, 00), "5-6èŠ‚"),
        (new TimeSpan(15, 25, 00), new TimeSpan(17, 05, 00), "7-8èŠ‚"),
        (new TimeSpan(18, 30, 00), new TimeSpan(20, 10, 00), "9-10èŠ‚"),
    };

    void SetDefaultPeriodByNow()
    {
        DateTime now = DateTime.Now;
        TimeSpan t = now.TimeOfDay;

        // Check each time slot to see if current time falls within it
        for (int i = 0; i < PeriodSlots.Count; i++)
        {
            (TimeSpan Start, TimeSpan End, string Label) slot = PeriodSlots[i];

            // If current time is within this period, select it
            if (t >= slot.Start && t <= slot.End)
            {
                Period = slot.Label;  // Select current period, not next
                return;
            }
        }

        // If before first period (before 8:00), default to first period
        if (t < PeriodSlots[0].Start)
        {
            Period = PeriodSlots[0].Label; // "1-2èŠ‚"
            return;
        }

        // If between periods or after all periods, find the next upcoming period
        for (int i = 0; i < PeriodSlots.Count - 1; i++)
        {
            if (t > PeriodSlots[i].End && t < PeriodSlots[i + 1].Start)
            {
                Period = PeriodSlots[i + 1].Label; // Next period
                return;
            }
        }

        // If after all periods (after 20:10), default to first period of next day
        Period = "1-2èŠ‚";
    }

    void QueryVacantRooms()
    {
        VacantResult = VacantService.GetVacantRooms(Campus, Weekday, Period, Building, Week);
    }

    void QueryRoomUsage()
    {
        if (string.IsNullOrEmpty(RoomNumber)) return;

        // è°ƒç”¨æœåŠ¡è·å–æ•™å®¤ä½¿ç”¨æƒ…å†µ
        UsageResult = VacantService.GetRoomUsage(RoomCampus, RoomBuilding + RoomNumber, RoomWeekday, RoomWeek);
    }

    void OnBuildingChanged(ChangeEventArgs e)
    {
        RoomBuilding = e.Value?.ToString() ?? "";
        RoomNumber = ""; // æ¸…ç©ºæ•™å®¤å·é€‰æ‹©
    }

    List<string> GetRoomsForBuilding(string building)
    {
        // ä½¿ç”¨æœåŠ¡è·å–å®é™…çš„æ•™å®¤åˆ—è¡¨
        return VacantService.GetRoomsForBuilding(building);
    }

    protected override void OnInitialized()
    {
        var today = DateTime.Today.DayOfWeek;
        TodayText = DateTime.Today.ToString("D");

        string todayWeekday = today switch
        {
            DayOfWeek.Monday => "å‘¨ä¸€",
            DayOfWeek.Tuesday => "å‘¨äºŒ",
            DayOfWeek.Wednesday => "å‘¨ä¸‰",
            DayOfWeek.Thursday => "å‘¨å››",
            DayOfWeek.Friday => "å‘¨äº”",
            _ => "å‘¨ä¸€"
        };

        Weekday = todayWeekday;
        RoomWeekday = todayWeekday;

        DateTime week14Start = new DateTime(2025, 9, 8);
        int passedDays = (DateTime.Today - week14Start).Days;
        int weekOffset = passedDays / 7;
        int currentWeekNumber = 1 + weekOffset;

        if (currentWeekNumber < 1) currentWeekNumber = 1;
        if (currentWeekNumber > 18) currentWeekNumber = 18;

        Week = $"ç¬¬{currentWeekNumber}å‘¨";
        RoomWeek = $"ç¬¬{currentWeekNumber}å‘¨";

        SetDefaultPeriodByNow();
    }
}


============================================================
FILE: Components\Routes.razor
============================================================
ï»¿<Router AppAssembly="typeof(Program).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)" />
        <FocusOnNavigate RouteData="routeData" Selector="h1" />
    </Found>
</Router>



============================================================
FILE: Components\_Imports.razor
============================================================
ï»¿@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@using VacantRoomWeb
@using VacantRoomWeb.Components
@using System.ComponentModel.DataAnnotations


============================================================
FILE: ConnectionCounterService.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// ç»´æŠ¤å½“å‰åœ¨çº¿è¿æ¥æ•°
    /// </summary>
    public class ConnectionCounterService
    {
        private int _count = 0;

        public int Increment()
        {
            return Interlocked.Increment(ref _count);
        }

        public int Decrement()
        {
            return Interlocked.Decrement(ref _count);
        }

        public int GetCount()
        {
            return _count;
        }
    }

}



============================================================
FILE: ConnectionLoggingCircuitHandler.cs
============================================================
ï»¿using Microsoft.AspNetCore.Components.Server.Circuits;

namespace VacantRoomWeb
{
    public class ConnectionLoggingCircuitHandler : CircuitHandler
    {
        private readonly ConnectionCounterService _counter;
        private readonly ClientConnectionTracker _ipTracker;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private readonly EnhancedLoggingService _logger;

        // ç”¨äºè·Ÿè¸ªæ¯ä¸ªIPçš„è¿æ¥æƒ…å†µï¼Œé¿å…é‡å¤è®°å½•
        private static readonly Dictionary<string, DateTime> _lastLoggedConnection = new();
        private static readonly object _logLock = new();

        public ConnectionLoggingCircuitHandler(
            ConnectionCounterService counter,
            ClientConnectionTracker ipTracker,
            IHttpContextAccessor httpContextAccessor,
            EnhancedLoggingService logger)
        {
            _counter = counter;
            _ipTracker = ipTracker;
            _httpContextAccessor = httpContextAccessor;
            _logger = logger;
        }

        public override Task OnConnectionUpAsync(Circuit circuit, CancellationToken cancellationToken)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = _httpContextAccessor.HttpContext?.Request.Headers.UserAgent.ToString() ?? "";

            _ipTracker.SetClientIp(circuit.Id, ip);

            var count = _counter.Increment();

            // æ™ºèƒ½è®°å½•ï¼šåŒä¸€IPåœ¨30ç§’å†…çš„å¤šæ¬¡è¿æ¥åªè®°å½•ä¸€æ¬¡
            lock (_logLock)
            {
                var now = DateTime.Now;
                var shouldLog = false;

                if (!_lastLoggedConnection.ContainsKey(ip))
                {
                    shouldLog = true;
                }
                else if (now.Subtract(_lastLoggedConnection[ip]).TotalSeconds > 30)
                {
                    shouldLog = true;
                }

                if (shouldLog)
                {
                    _lastLoggedConnection[ip] = now;
                    _logger.LogAccess(ip, "BLAZOR_CONNECTION_UP", $"Active connections: {count}", TruncateUserAgent(userAgent));

                    // æ¸…ç†æ—§çš„è®°å½•ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
                    CleanupOldConnections();
                }
            }

            return Task.CompletedTask;
        }

        public override Task OnConnectionDownAsync(Circuit circuit, CancellationToken cancellationToken)
        {
            var ip = _ipTracker.GetClientIp(circuit.Id);

            if (ip != null)
            {
                _ipTracker.Remove(circuit.Id);
                var count = _counter.Decrement();

                // è¿æ¥æ–­å¼€æ—¶ä¹Ÿé‡‡ç”¨ç›¸åŒçš„ç­–ç•¥ï¼Œé¿å…é‡å¤è®°å½•
                lock (_logLock)
                {
                    var now = DateTime.Now;
                    var shouldLog = false;

                    if (_lastLoggedConnection.ContainsKey(ip))
                    {
                        if (now.Subtract(_lastLoggedConnection[ip]).TotalSeconds > 10) // æ–­å¼€è¿æ¥çš„é—´éš”æ›´çŸ­
                        {
                            shouldLog = true;
                            _lastLoggedConnection[ip] = now;
                        }
                    }
                    else
                    {
                        shouldLog = true;
                        _lastLoggedConnection[ip] = now;
                    }

                    if (shouldLog)
                    {
                        _logger.LogAccess(ip, "BLAZOR_CONNECTION_DOWN", $"Active connections: {count}");
                    }
                }
            }

            return Task.CompletedTask;
        }

        private void CleanupOldConnections()
        {
            var cutoff = DateTime.Now.AddMinutes(-5);
            var keysToRemove = _lastLoggedConnection
                .Where(kvp => kvp.Value < cutoff)
                .Select(kvp => kvp.Key)
                .ToList();

            foreach (var key in keysToRemove)
            {
                _lastLoggedConnection.Remove(key);
            }
        }

        private string TruncateUserAgent(string userAgent)
        {
            if (string.IsNullOrEmpty(userAgent)) return "";
            return userAgent.Length > 50 ? userAgent.Substring(0, 50) + "..." : userAgent;
        }
    }
}


============================================================
FILE: DomainRoutingMiddleware.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    public class DomainRoutingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly EnhancedLoggingService _logger;

        public DomainRoutingMiddleware(RequestDelegate next, EnhancedLoggingService logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var host = context.Request.Host.Host.ToLowerInvariant();
            var path = context.Request.Path.ToString();
            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";

            // Allow localhost admin access in development
            if (host.Contains("localhost") && path.StartsWith("/admin"))
            {
                // åªè®°å½•å…³é”®çš„æœ¬åœ°ç®¡ç†è®¿é—®ï¼Œé¿å…é‡å¤
                if (IsKeyAdminPath(path))
                {
                    _logger.LogAccess(ip, "LOCALHOST_ADMIN_ACCESS", $"Host: {host}, Path: {path}");
                }
                await _next(context);
                return;
            }

            // Handle admin subdomain
            if (host.StartsWith("admin."))
            {
                // admin æ ¹è·³è½¬åˆ°ç™»å½•
                if (path == "/" || string.IsNullOrEmpty(path))
                {
                    _logger.LogAccess(ip, "ADMIN_SUBDOMAIN_REDIRECT", $"Host: {host} -> /admin/login");
                    context.Response.Redirect("/admin/login");
                    return;
                }

                // ä¸è¦é‡å†™è¿™äº›ç³»ç»Ÿè·¯å¾„
                bool isSystemPath =
                    path.StartsWith("/_framework", StringComparison.OrdinalIgnoreCase) ||
                    path.StartsWith("/_blazor", StringComparison.OrdinalIgnoreCase) ||
                    path.StartsWith("/_content", StringComparison.OrdinalIgnoreCase) ||
                    path.Equals("/favicon.ico", StringComparison.OrdinalIgnoreCase) ||
                    path.Equals("/robots.txt", StringComparison.OrdinalIgnoreCase);

                // ä»…å½“æ—¢ä¸æ˜¯ /admin å¼€å¤´ã€ä¹Ÿä¸æ˜¯ç³»ç»Ÿè·¯å¾„æ—¶ï¼Œæ‰åŠ å‰ç¼€
                if (!path.StartsWith("/admin", StringComparison.OrdinalIgnoreCase) && !isSystemPath)
                {
                    var newPath = "/admin" + path;
                    context.Request.Path = newPath;

                    // åªè®°å½•é‡è¦çš„è·¯å¾„é‡å†™
                    if (IsKeyAdminPath(newPath))
                    {
                        _logger.LogAccess(ip, "ADMIN_PATH_REWRITE", $"{path} -> {newPath}");
                    }
                }
            }

            await _next(context);
        }

        private bool IsKeyAdminPath(string path)
        {
            // åªè®°å½•çœŸæ­£å…³é”®çš„ç®¡ç†è·¯å¾„
            var keyPaths = new[]
            {
                "/admin",
                "/admin/",
                "/admin/login",
                "/admin/dashboard"
            };

            return keyPaths.Any(keyPath =>
                path.Equals(keyPath, StringComparison.OrdinalIgnoreCase));
        }
    }
}


============================================================
FILE: EmailNotificationSettings.cs
============================================================
ï»¿// EmailNotificationSettings.cs
namespace VacantRoomWeb
{
    public class EmailNotificationSettings
    {
        public bool EnableDDoSAlerts { get; set; }
        public bool EnableBruteForceAlerts { get; set; }
        public bool EnableSystemLockdownAlerts { get; set; }
        public bool EnableIPBanAlerts { get; set; }
    }
}


============================================================
FILE: EnhancedLoggingService.cs
============================================================
ï»¿using System.Collections.Concurrent;

namespace VacantRoomWeb
{
    public class LogEntry
    {
        public DateTime Timestamp { get; set; }
        public string IP { get; set; } = "";
        public string Action { get; set; } = "";
        public string Details { get; set; } = "";
        public string UserAgent { get; set; } = "";
        public string RequestPath { get; set; } = "";
    }

    public class EnhancedLoggingService
    {
        private readonly string _logDirectory;
        private readonly ConcurrentQueue<LogEntry> _recentLogs = new();
        private readonly object _fileLock = new();
        private const int MaxRecentLogs = 500;

        public EnhancedLoggingService()
        {
            _logDirectory = Path.Combine(AppContext.BaseDirectory, "Logs");
            Directory.CreateDirectory(_logDirectory);
        }

        public void LogAccess(string ip, string action, string details = "", string userAgent = "", string requestPath = "")
        {
            var logEntry = new LogEntry
            {
                Timestamp = DateTime.Now,
                IP = ip,
                Action = action,
                Details = details,
                UserAgent = userAgent,
                RequestPath = requestPath
            };

            // Add to memory queue
            _recentLogs.Enqueue(logEntry);

            // Keep only recent logs in memory
            while (_recentLogs.Count > MaxRecentLogs)
            {
                _recentLogs.TryDequeue(out _);
            }

            // Write to file (no console output for IIS)
            WriteToFile(logEntry);
        }

        private void WriteToFile(LogEntry entry)
        {
            try
            {
                var fileName = $"access-{DateTime.Now:yyyy-MM-dd}.log";
                var filePath = Path.Combine(_logDirectory, fileName);

                var logLine = $"[{entry.Timestamp:yyyy-MM-dd HH:mm:ss}] IP:{entry.IP} ACTION:{entry.Action} PATH:{entry.RequestPath} DETAILS:{entry.Details} UA:{entry.UserAgent}";

                lock (_fileLock)
                {
                    File.AppendAllText(filePath, logLine + Environment.NewLine);
                }
            }
            catch
            {
                // Silently fail in production environment
            }
        }

        public List<LogEntry> GetRecentLogs(int count = 100)
        {
            return _recentLogs.TakeLast(count).ToList();
        }

        public List<LogEntry> GetLogsByDate(DateTime date)
        {
            var fileName = $"access-{date:yyyy-MM-dd}.log";
            var filePath = Path.Combine(_logDirectory, fileName);

            if (!File.Exists(filePath))
                return new List<LogEntry>();

            try
            {
                // å¼ºåˆ¶åˆ·æ–°æ–‡ä»¶ç¼“å­˜ï¼Œç¡®ä¿è¯»å–æœ€æ–°å†…å®¹
                var lines = File.ReadAllLines(filePath);
                var logs = new List<LogEntry>();

                foreach (var line in lines)
                {
                    if (TryParseLogLine(line, out var logEntry))
                    {
                        logs.Add(logEntry);
                    }
                }

                return logs;
            }
            catch
            {
                return new List<LogEntry>();
            }
        }

        // æ–°å¢ï¼šå¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡çš„æ–¹æ³•ï¼Œç¡®ä¿è·å–æœ€æ–°æ•°æ®
        public void FlushLogs()
        {
            // è¿™ä¸ªæ–¹æ³•ç¡®ä¿æ‰€æœ‰pendingçš„æ—¥å¿—éƒ½è¢«å†™å…¥
            lock (_fileLock)
            {
                // å¼ºåˆ¶åˆ·æ–°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜
            }
        }

        private bool TryParseLogLine(string line, out LogEntry logEntry)
        {
            logEntry = new LogEntry();

            try
            {
                // ä¿®å¤è§£æé€»è¾‘ï¼šæ—¥å¿—æ ¼å¼æ˜¯ [æ—¶é—´] IP:xxx ACTION:xxx PATH:xxx DETAILS:xxx UA:xxx
                if (!line.StartsWith("[")) return false;

                var timestampEnd = line.IndexOf(']');
                if (timestampEnd == -1) return false;

                var timestampStr = line.Substring(1, timestampEnd - 1);
                logEntry.Timestamp = DateTime.Parse(timestampStr);

                var remainingLine = line.Substring(timestampEnd + 1).Trim();

                // ä½¿ç”¨æ­£ç¡®çš„åˆ†éš”ç¬¦è§£æ
                var parts = remainingLine.Split(new[] { " IP:", " ACTION:", " PATH:", " DETAILS:", " UA:" }, StringSplitOptions.None);

                if (parts.Length >= 5)
                {
                    logEntry.IP = parts[1];
                    logEntry.Action = parts[2];
                    logEntry.RequestPath = parts[3];
                    logEntry.Details = parts[4];

                    // UAå¯èƒ½ä¸ºç©ºæˆ–è€…ä¸å­˜åœ¨
                    if (parts.Length > 5)
                    {
                        logEntry.UserAgent = parts[5];
                    }

                    return true;
                }
            }
            catch (Exception ex)
            {
                // è°ƒè¯•ï¼šè®°å½•è§£æå¤±è´¥çš„è¡Œ
                // è¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥è¢«ç§»é™¤
            }

            return false;
        }

        public List<string> GetAvailableLogDates()
        {
            try
            {
                return Directory.GetFiles(_logDirectory, "access-*.log")
                    .Select(f => Path.GetFileName(f))
                    .Select(f => f.Replace("access-", "").Replace(".log", ""))
                    .OrderByDescending(d => d)
                    .ToList();
            }
            catch
            {
                return new List<string>();
            }
        }

        // æ¸…ç†å†…å­˜æ—¥å¿—
        public void ClearRecentLogs()
        {
            while (_recentLogs.TryDequeue(out _)) { }
        }

        // ç®€åŒ–çš„æ—¥å¿—ç»Ÿè®¡æ–¹æ³• - ç›´æ¥ä½¿ç”¨å†…å­˜æ•°æ®
        public Dictionary<string, object> GetLogStats()
        {
            var memoryLogs = _recentLogs.ToList();
            var today = DateTime.Today;

            // ç›´æ¥ä½¿ç”¨å†…å­˜ä¸­ä»Šå¤©çš„æ—¥å¿—æ•°æ®ï¼Œé¿å…æ–‡ä»¶è§£æé—®é¢˜
            var todayFromMemory = memoryLogs.Where(l => l.Timestamp.Date == today).ToList();

            var stats = new Dictionary<string, object>();

            // å†…å­˜æ—¥å¿—ç»Ÿè®¡
            var memoryActionGroups = memoryLogs.GroupBy(l => l.Action).ToDictionary(g => g.Key, g => g.Count());
            var memoryIpCount = memoryLogs.Select(l => l.IP).Distinct().Count();

            stats["MemoryLogs"] = memoryLogs.Count;
            stats["MemoryUniqueIPs"] = memoryIpCount;
            stats["MemorySecurityEvents"] = memoryActionGroups.Where(kvp => kvp.Key.StartsWith("SECURITY_")).Sum(kvp => kvp.Value);
            stats["MemoryAdminEvents"] = memoryActionGroups.Where(kvp => kvp.Key.Contains("ADMIN")).Sum(kvp => kvp.Value);

            // ä»Šæ—¥ç»Ÿè®¡ - ä½¿ç”¨å†…å­˜æ•°æ®
            var todayActionGroups = todayFromMemory.GroupBy(l => l.Action).ToDictionary(g => g.Key, g => g.Count());
            var todayIpCount = todayFromMemory.Select(l => l.IP).Distinct().Count();

            stats["TodayLogs"] = todayFromMemory.Count;
            stats["TodayUniqueIPs"] = todayIpCount;
            stats["TodaySecurityEvents"] = todayActionGroups.Where(kvp => kvp.Key.StartsWith("SECURITY_")).Sum(kvp => kvp.Value);
            stats["TodayAdminEvents"] = todayActionGroups.Where(kvp => kvp.Key.Contains("ADMIN")).Sum(kvp => kvp.Value);

            // æ–‡ä»¶ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            var todayFileName = $"access-{today:yyyy-MM-dd}.log";
            var todayFilePath = Path.Combine(_logDirectory, todayFileName);

            if (File.Exists(todayFilePath))
            {
                var fileInfo = new FileInfo(todayFilePath);
                stats["TodayLogFileSize"] = $"{fileInfo.Length / 1024.0:F1} KB";
            }
            else
            {
                stats["TodayLogFileSize"] = "0 KB";
            }

            // ç®€åŒ–çš„è°ƒè¯•ä¿¡æ¯
            stats["DebugInfo"] = $"å†…å­˜æ€»æ•°: {memoryLogs.Count}, ä»Šæ—¥å†…å­˜: {todayFromMemory.Count}";
            stats["DebugLogDirectory"] = _logDirectory;
            stats["DebugCurrentTime"] = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            stats["DebugTodayDate"] = today.ToString("yyyy-MM-dd");

            return stats;
        }

        // è·å–å½“æ—¥æ—¥å¿—æ–‡ä»¶çš„è¡Œæ•°ï¼ˆå¿«é€Ÿæ–¹æ³•ï¼‰
        public int GetTodayLogCount()
        {
            var fileName = $"access-{DateTime.Today:yyyy-MM-dd}.log";
            var filePath = Path.Combine(_logDirectory, fileName);

            if (!File.Exists(filePath))
                return 0;

            try
            {
                return File.ReadAllLines(filePath).Length;
            }
            catch
            {
                return 0;
            }
        }

        // åˆ é™¤æ—§æ—¥å¿—æ–‡ä»¶
        public void CleanupOldLogs(int daysToKeep = 30)
        {
            try
            {
                var cutoffDate = DateTime.Now.AddDays(-daysToKeep);
                var logFiles = Directory.GetFiles(_logDirectory, "access-*.log");

                foreach (var file in logFiles)
                {
                    var fileName = Path.GetFileNameWithoutExtension(file);
                    var dateStr = fileName.Replace("access-", "");

                    if (DateTime.TryParseExact(dateStr, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out var fileDate))
                    {
                        if (fileDate < cutoffDate)
                        {
                            File.Delete(file);
                        }
                    }
                }
            }
            catch
            {
                // Silently fail
            }
        }

        // è·å–æ—¥å¿—æ–‡ä»¶ä¿¡æ¯
        public List<(string Date, int Count, string Size)> GetLogFileInfo()
        {
            var result = new List<(string Date, int Count, string Size)>();

            try
            {
                var logFiles = Directory.GetFiles(_logDirectory, "access-*.log");

                foreach (var file in logFiles)
                {
                    var fileName = Path.GetFileNameWithoutExtension(file);
                    var dateStr = fileName.Replace("access-", "");

                    if (DateTime.TryParseExact(dateStr, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out var fileDate))
                    {
                        var fileInfo = new FileInfo(file);
                        var lineCount = File.ReadAllLines(file).Length;
                        var size = $"{fileInfo.Length / 1024.0:F1} KB";

                        result.Add((dateStr, lineCount, size));
                    }
                }

                return result.OrderByDescending(r => r.Date).ToList();
            }
            catch
            {
                return result;
            }
        }

        // æ–°å¢ï¼šå¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡çš„æ–¹æ³•
        public void ForceRefreshStats()
        {
            // è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥è§¦å‘ç»Ÿè®¡æ›´æ–°
            // ç›®å‰ä¸»è¦æ˜¯ä¸ºäº†è°ƒè¯•ä½¿ç”¨
        }
    }
}


============================================================
FILE: NotificationService.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    public class NotificationService
    {
        public event Action? LogsUpdated;

        public void NotifyLogsUpdated()
        {
            LogsUpdated?.Invoke();
        }
    }
}


============================================================
FILE: PasswordHashGenerator.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// Utility class to generate password hashes for admin configuration
    /// Run this once to generate hash and salt, then add to appsettings.json
    /// </summary>
    public static class PasswordHashGenerator
    {
        /// <summary>
        /// Generate password hash and salt for a given password
        /// Usage: var result = PasswordHashGenerator.GenerateHash("your_admin_password");
        /// </summary>
        public static (string hash, string salt) GenerateHash(string password)
        {
            return AdminAuthService.CreatePasswordHash(password);
        }

        /// <summary>
        /// Console application to generate admin password hash
        /// Uncomment and run this method to generate your admin credentials
        /// </summary>
        /*
        public static void Main(string[] args)
        {
            Console.WriteLine("Admin Password Hash Generator");
            Console.WriteLine("============================");
            
            Console.Write("Enter admin password: ");
            var password = Console.ReadLine();
            
            if (string.IsNullOrEmpty(password))
            {
                Console.WriteLine("Password cannot be empty!");
                return;
            }
            
            var (hash, salt) = GenerateHash(password);
            
            Console.WriteLine("\nGenerated credentials:");
            Console.WriteLine($"Password Hash: {hash}");
            Console.WriteLine($"Salt: {salt}");
            
            Console.WriteLine("\nAdd these to your appsettings.json:");
            Console.WriteLine("\"AdminConfig\": {");
            Console.WriteLine("  \"Username\": \"admin\",");
            Console.WriteLine($"  \"PasswordHash\": \"{hash}\",");
            Console.WriteLine($"  \"Salt\": \"{salt}\",");
            Console.WriteLine("  \"SecretKey\": \"your_secret_key_for_auth_tokens\"");
            Console.WriteLine("}");
            
            Console.WriteLine("\nPress any key to exit...");
            Console.ReadKey();
        }
        */
    }
}


============================================================
FILE: Program.cs
============================================================
using Microsoft.AspNetCore.Components.Server.Circuits;
using VacantRoomWeb;
using VacantRoomWeb.Components;

var builder = WebApplication.CreateBuilder(args);

// Add Blazor services
builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents();

builder.Services.AddSignalR(options =>
{
    options.MaximumReceiveMessageSize = null;
    options.EnableDetailedErrors = true;
});

// Register HttpClient for EmailService
builder.Services.AddHttpClient<IEmailService, EmailService>();

// Register existing services
builder.Services.AddSingleton<ConnectionCounterService>();
builder.Services.AddSingleton<ClientConnectionTracker>();
builder.Services.AddSingleton<IHttpContextAccessor, HttpContextAccessor>();

// Register new security and logging services
builder.Services.AddSingleton<EnhancedLoggingService>();
builder.Services.AddSingleton<SecurityService>();
builder.Services.AddSingleton<AdminAuthService>();
builder.Services.AddSingleton<ApplicationStartupService>();

// Register notification service for component communication
builder.Services.AddSingleton<NotificationService>();

// Register updated services with new dependencies
builder.Services.AddSingleton<VacantRoomService>();
builder.Services.AddSingleton<CircuitHandler, ConnectionLoggingCircuitHandler>();

var app = builder.Build();

// Configure the HTTP request pipeline
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error", createScopeForErrors: true);
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

// Add domain routing middleware FIRST
app.UseMiddleware<DomainRoutingMiddleware>();

// Add security middleware AFTER domain routing
app.UseMiddleware<SecurityMiddleware>();

app.UseAntiforgery();

app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode();

app.Run();


============================================================
FILE: SecurityMiddleware.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    public class SecurityMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly SecurityService _securityService;
        private readonly EnhancedLoggingService _logger;

        public SecurityMiddleware(RequestDelegate next, SecurityService securityService, EnhancedLoggingService logger)
        {
            _next = next;
            _securityService = securityService;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var ip = context.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = context.Request.Headers.UserAgent.ToString();
            var requestPath = context.Request.Path.ToString();

            // Check if IP is banned
            if (_securityService.IsIPBanned(ip))
            {
                _logger.LogAccess(ip, "ACCESS_DENIED_BANNED", requestPath, userAgent);
                context.Response.StatusCode = 403;
                await context.Response.WriteAsync("Access denied");
                return;
            }

            // Check admin panel lockdown
            if (requestPath.StartsWith("/admin", StringComparison.OrdinalIgnoreCase) && _securityService.IsAdminPanelLocked())
            {
                _logger.LogAccess(ip, "ACCESS_DENIED_LOCKDOWN", requestPath, userAgent);
                context.Response.StatusCode = 503;
                await context.Response.WriteAsync("Admin panel temporarily unavailable");
                return;
            }

            // Rate limiting check
            if (!_securityService.CheckRateLimit(ip, userAgent))
            {
                context.Response.StatusCode = 429;
                await context.Response.WriteAsync("Too many requests");
                return;
            }

            // è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªè®°å½•çœŸæ­£é‡è¦çš„é¡µé¢è®¿é—®
            if (ShouldLogRequest(requestPath))
            {
                _logger.LogAccess(ip, "ACCESS", requestPath, userAgent);
            }

            await _next(context);
        }

        private bool ShouldLogRequest(string path)
        {
            // ä¸è®°å½•çš„è·¯å¾„
            var skipPatterns = new[]
            {
                "/_framework/",
                "/_blazor/",
                "/_content/",
                "/css/",
                "/js/",
                "/lib/",
                "/bootstrap/",
                "/favicon.ico",
                "/robots.txt",
                ".css",
                ".js",
                ".map",
                ".woff",
                ".woff2",
                ".ttf",
                ".eot",
                ".svg",
                ".png",
                ".jpg",
                ".jpeg",
                ".gif",
                ".ico"
            };

            foreach (var pattern in skipPatterns)
            {
                if (path.Contains(pattern, StringComparison.OrdinalIgnoreCase))
                {
                    return false;
                }
            }

            // åªè®°å½•ä¸»è¦é¡µé¢è®¿é—®ï¼Œä¸è®°å½• Blazor å†…éƒ¨è·¯å¾„
            var importantPaths = new[]
            {
                "/",
                "/admin",
                "/admin/login",
                "/admin/dashboard"
            };

            // ç²¾ç¡®åŒ¹é…é‡è¦è·¯å¾„ï¼Œæˆ–è€…æ˜¯æ ¹è·¯å¾„
            return importantPaths.Any(important =>
                path.Equals(important, StringComparison.OrdinalIgnoreCase) ||
                path.Equals(important + "/", StringComparison.OrdinalIgnoreCase));
        }
    }
}


============================================================
FILE: SecurityService.cs
============================================================
ï»¿// SecurityService.cs - æ›´æ–°éƒ¨åˆ†
using System.Collections.Concurrent;

namespace VacantRoomWeb
{
    public class SecurityEvent
    {
        public DateTime Timestamp { get; set; }
        public string IP { get; set; } = "";
        public string EventType { get; set; } = "";
        public string Details { get; set; } = "";
    }

    public class SecurityService
    {
        private readonly EnhancedLoggingService _logger;
        private readonly IEmailService _emailService;

        // IP tracking for rate limiting
        private readonly ConcurrentDictionary<string, List<DateTime>> _ipRequests = new();
        private readonly ConcurrentDictionary<string, List<DateTime>> _loginAttempts = new();
        private readonly ConcurrentDictionary<string, DateTime> _bannedIPs = new();

        // System-wide security tracking
        private readonly List<DateTime> _recentBreachAttempts = new();
        private DateTime? _adminPanelLockdownUntil = null;
        private DateTime _lastEmailSent = DateTime.MinValue;

        private readonly object _lockObject = new();

        public SecurityService(EnhancedLoggingService logger, IEmailService emailService)
        {
            _logger = logger;
            _emailService = emailService;
        }

        public bool IsIPBanned(string ip)
        {
            if (_bannedIPs.TryGetValue(ip, out var banTime))
            {
                if (DateTime.Now < banTime)
                {
                    return true;
                }
                else
                {
                    _bannedIPs.TryRemove(ip, out _);
                }
            }
            return false;
        }

        public bool IsAdminPanelLocked()
        {
            if (_adminPanelLockdownUntil.HasValue && DateTime.Now < _adminPanelLockdownUntil.Value)
            {
                return true;
            }
            else
            {
                _adminPanelLockdownUntil = null;
                return false;
            }
        }

        public bool CheckRateLimit(string ip, string userAgent = "")
        {
            lock (_lockObject)
            {
                var now = DateTime.Now;
                var oneMinuteAgo = now.AddMinutes(-1);

                // Clean old requests
                _ipRequests.AddOrUpdate(ip, new List<DateTime> { now }, (key, list) =>
                {
                    list.RemoveAll(time => time < oneMinuteAgo);
                    list.Add(now);
                    return list;
                });

                var requestCount = _ipRequests[ip].Count;

                // ä¼˜åŒ–çš„DDoSæ£€æµ‹ï¼šæ›´å®½æ¾çš„é˜ˆå€¼
                // è€ƒè™‘åˆ°Blazoråº”ç”¨çš„ç‰¹ç‚¹ï¼Œæé«˜åˆ°120æ¬¡/åˆ†é’Ÿ
                if (requestCount > 120)
                {
                    BanIP(ip, TimeSpan.FromMinutes(15), "DDoS_DETECTED"); // å‡å°‘åˆ°15åˆ†é’Ÿ
                    _logger.LogAccess(ip, "SECURITY_DDOS_DETECTED", $"Requests in 1min: {requestCount}", userAgent);

                    // å¼‚æ­¥å‘é€é‚®ä»¶è­¦æŠ¥
                    _ = Task.Run(async () =>
                    {
                        await TriggerEmailAlertAsync("DDoS Attack Detected",
                            $"IP {ip} made {requestCount} requests in 1 minute and has been banned for 15 minutes.", ip);
                    });

                    return false;
                }

                // è­¦å‘Šé˜ˆå€¼ï¼š80æ¬¡/åˆ†é’Ÿæ—¶è®°å½•ä½†ä¸å°ç¦
                if (requestCount > 80)
                {
                    _logger.LogAccess(ip, "SECURITY_HIGH_REQUEST_RATE", $"High request rate: {requestCount}/min", userAgent);
                }

                return true;
            }
        }

        public bool CheckLoginAttempt(string ip, bool successful, string userAgent = "")
        {
            lock (_lockObject)
            {
                var now = DateTime.Now;
                var fiveMinutesAgo = now.AddMinutes(-5); // æ‰©å±•åˆ°5åˆ†é’Ÿçª—å£
                var tenMinutesAgo = now.AddMinutes(-10);

                if (successful)
                {
                    // Clear failed attempts on successful login
                    _loginAttempts.TryRemove(ip, out _);
                    _logger.LogAccess(ip, "ADMIN_LOGIN_SUCCESS", "", userAgent);
                    return true;
                }

                // Track failed attempts (ä½¿ç”¨5åˆ†é’Ÿçª—å£è€Œä¸æ˜¯1åˆ†é’Ÿ)
                _loginAttempts.AddOrUpdate(ip, new List<DateTime> { now }, (key, list) =>
                {
                    list.RemoveAll(time => time < fiveMinutesAgo);
                    list.Add(now);
                    return list;
                });

                var failedCount = _loginAttempts[ip].Count;

                // ä¼˜åŒ–çš„æš´åŠ›ç ´è§£æ£€æµ‹ï¼š5åˆ†é’Ÿå†…8æ¬¡å¤±è´¥æ‰å°ç¦
                if (failedCount >= 8)
                {
                    BanIP(ip, TimeSpan.FromMinutes(30), "BRUTE_FORCE_DETECTED"); // å‡å°‘åˆ°30åˆ†é’Ÿ
                    _logger.LogAccess(ip, "SECURITY_BRUTE_FORCE_DETECTED", $"Failed login attempts: {failedCount} in 5min", userAgent);

                    // Track for system-wide lockdown
                    _recentBreachAttempts.RemoveAll(time => time < tenMinutesAgo);
                    _recentBreachAttempts.Add(now);

                    // å¼‚æ­¥å‘é€é‚®ä»¶è­¦æŠ¥
                    _ = Task.Run(async () =>
                    {
                        await TriggerEmailAlertAsync("Brute Force Attack Detected",
                            $"IP {ip} attempted {failedCount} failed logins in 5 minutes and has been banned for 30 minutes.", ip);
                    });

                    // ç³»ç»Ÿé”å®šï¼š10åˆ†é’Ÿå†…5ä¸ªä¸åŒIPçš„æš´åŠ›ç ´è§£
                    var recentUniqueAttackers = _loginAttempts
                        .Where(kvp => kvp.Value.Any(time => time > tenMinutesAgo))
                        .Count();

                    if (recentUniqueAttackers >= 5)
                    {
                        _adminPanelLockdownUntil = now.AddMinutes(15); // å‡å°‘åˆ°15åˆ†é’Ÿ
                        _logger.LogAccess(ip, "SECURITY_ADMIN_LOCKDOWN", $"Admin panel locked for 15 minutes due to {recentUniqueAttackers} attackers", userAgent);

                        // å¼‚æ­¥å‘é€ç³»ç»Ÿé”å®šè­¦æŠ¥
                        _ = Task.Run(async () =>
                        {
                            await TriggerEmailAlertAsync("CRITICAL: Admin Panel Locked",
                                $"Admin panel has been locked for 15 minutes due to {recentUniqueAttackers} different IPs attempting brute force attacks. Latest attacker: {ip}", ip);
                        });
                    }

                    return false;
                }

                // è­¦å‘Šé˜ˆå€¼ï¼š5åˆ†é’Ÿå†…5æ¬¡å¤±è´¥æ—¶è®°å½•è­¦å‘Š
                if (failedCount >= 5)
                {
                    _logger.LogAccess(ip, "SECURITY_LOGIN_WARNING", $"Multiple failed attempts: {failedCount}/8 in 5min", userAgent);
                }

                _logger.LogAccess(ip, "ADMIN_LOGIN_FAILED", $"Attempt {failedCount}/8 in 5min", userAgent);
                return true;
            }
        }

        private void BanIP(string ip, TimeSpan duration, string reason)
        {
            var banUntil = DateTime.Now.Add(duration);
            _bannedIPs.AddOrUpdate(ip, banUntil, (key, oldTime) => banUntil);

            _logger.LogAccess(ip, "SECURITY_IP_BANNED", $"Reason: {reason}, Duration: {duration.TotalMinutes} minutes");
        }

        // æ›´æ–°ä¸ºå¼‚æ­¥é‚®ä»¶è­¦æŠ¥æ–¹æ³•
        private async Task TriggerEmailAlertAsync(string subject, string message, string ipAddress = null)
        {
            var now = DateTime.Now;

            // Rate limit emails: max 1 every 15 minutes
            if (now.Subtract(_lastEmailSent).TotalMinutes >= 15)
            {
                _lastEmailSent = now;

                try
                {
                    await _emailService.SendSecurityAlertAsync(subject, message, ipAddress);
                }
                catch (Exception ex)
                {
                    _logger.LogAccess("SYSTEM", "EMAIL_ALERT_FAILED", $"Failed to send email: {ex.Message}");
                }
            }
        }

        // ä¿æŒåŸæœ‰åŒæ­¥æ–¹æ³•ä»¥ä¿è¯å…¼å®¹æ€§
        private void TriggerEmailAlert(string subject, string message)
        {
            var now = DateTime.Now;

            // Rate limit emails: max 1 every 15 minutes (æ›´é¢‘ç¹çš„é€šçŸ¥)
            if (now.Subtract(_lastEmailSent).TotalMinutes >= 15)
            {
                _lastEmailSent = now;
                _emailService.SendSecurityAlert(subject, message);
            }
        }

        public List<SecurityEvent> GetRecentSecurityEvents(int count = 50)
        {
            var events = new List<SecurityEvent>();
            var recentLogs = _logger.GetRecentLogs(count * 2);

            foreach (var log in recentLogs.Where(l => l.Action.StartsWith("SECURITY_") || l.Action.Contains("LOGIN")))
            {
                events.Add(new SecurityEvent
                {
                    Timestamp = log.Timestamp,
                    IP = log.IP,
                    EventType = log.Action,
                    Details = log.Details
                });
            }

            return events.OrderByDescending(e => e.Timestamp).Take(count).ToList();
        }

        public Dictionary<string, object> GetSecurityStats()
        {
            lock (_lockObject)
            {
                var now = DateTime.Now;
                var oneDayAgo = now.AddDays(-1);

                return new Dictionary<string, object>
                {
                    ["TotalBannedIPs"] = _bannedIPs.Count(kvp => kvp.Value > now),
                    ["AdminPanelLocked"] = IsAdminPanelLocked(),
                    ["LockdownUntil"] = _adminPanelLockdownUntil?.ToString("yyyy-MM-dd HH:mm:ss") ?? "æœªé”å®š",
                    ["RecentBreachAttempts"] = _recentBreachAttempts.Count(t => t > oneDayAgo),
                    ["ActiveIPTracking"] = _ipRequests.Count
                };
            }
        }

        // æ–°å¢ï¼šæ‰‹åŠ¨è§£å°IPçš„æ–¹æ³•
        public bool UnbanIP(string ip)
        {
            return _bannedIPs.TryRemove(ip, out _);
        }

        // æ–°å¢ï¼šè·å–å½“å‰è¢«å°ç¦çš„IPåˆ—è¡¨
        public List<(string IP, DateTime BanUntil, TimeSpan Remaining)> GetBannedIPs()
        {
            var now = DateTime.Now;
            return _bannedIPs
                .Where(kvp => kvp.Value > now)
                .Select(kvp => (kvp.Key, kvp.Value, kvp.Value - now))
                .OrderBy(item => item.Item2)
                .ToList();
        }

        // æ–°å¢ï¼šæ¸…é™¤è¿‡æœŸçš„å°ç¦è®°å½•
        public void CleanupExpiredBans()
        {
            var now = DateTime.Now;
            var expiredIPs = _bannedIPs
                .Where(kvp => kvp.Value <= now)
                .Select(kvp => kvp.Key)
                .ToList();

            foreach (var ip in expiredIPs)
            {
                _bannedIPs.TryRemove(ip, out _);
            }
        }
    }
}


============================================================
FILE: VacantRoomService.cs
============================================================
ï»¿using ClosedXML.Excel;
using Microsoft.AspNetCore.Components.Server.Circuits;
using System.Collections.Generic;
using System.IO;
using System.Linq;

namespace VacantRoomWeb
{
    public class VacantRoomService
    {
        private readonly ConnectionCounterService _counter;
        private readonly ClientConnectionTracker _ipTracker;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private readonly EnhancedLoggingService _logger;
        private readonly IConfiguration _configuration;
        private readonly NotificationService _notificationService;

        // ç”¨äºæ§åˆ¶ç”¨æˆ·æŸ¥è¯¢é¢‘ç‡ï¼Œé¿å…æ—¥å¿—è†¨èƒ€
        private readonly Dictionary<string, DateTime> _lastQueryTime = new();
        private readonly Dictionary<string, int> _queryCount = new();
        private readonly object _queryLock = new();

        public VacantRoomService(
            ConnectionCounterService counter,
            ClientConnectionTracker ipTracker,
            IHttpContextAccessor httpContextAccessor,
            EnhancedLoggingService logger,
            IConfiguration configuration,
            NotificationService notificationService)
        {
            _counter = counter;
            _ipTracker = ipTracker;
            _httpContextAccessor = httpContextAccessor;
            _logger = logger;
            _configuration = configuration;
            _notificationService = notificationService;
        }

        List<string> list = new List<string> { "A101", "A102", "A103", "A104", "A105", "A106",
                                               "A201", "A202", "A203", "A204", "A205", "A206",
                                               "A301", "A302", "A303", "A304", "A305",
                                               "A401", "A402", "A403", "A404", "A405", "A406",
                                               "B101", "B102", "B103", "B104", "B105", "B106", "B107", "B108",
                                               "B201", "B202", "B203", "B204", "B205", "B206", "B207", "B208",
                                               "B301", "B302", "B303", "B304", "B305", "B306", "B307", "B308",
                                               "B401", "B402", "B403", "B404", "B405", "B406", "B407", "B408",
                                               "B501", "B502", "B503", "B504", "B505", "B506", "B507", "B508",
                                               "C101", "C102", "C103", "C104", "C105", "C106", "C107", "C108",
                                               "C200", "C201", "C202", "C203", "C204", "C205", "C206", "C207", "C208",
                                               "C301", "C302", "C303", "C304", "C305", "C306", "C307", "C308",
                                               "C401", "C402", "C403", "C404", "C405", "C406", "C407", "C408",
                                               "C501", "C502", "C503", "C504", "C505", "C506", "C507", "C508",
                                               "D101", "D102", "D103", "D104", "D105", "D106", "D107", "D108",
                                               "D201", "D202", "D203", "D204", "D205", "D206", "D207", "D208",
                                               "D301", "D302", "D303", "D304", "D305", "D306", "D307", "D308",
                                               "D401", "D402", "D403", "D404", "D405", "D406", "D407", "D408",
                                               "D501", "D502", "D503", "D504", "D505", "D506", "D507", "D508",
                                               "E113", "E115", };

        // Dictionary for period time mapping
        private readonly Dictionary<string, string> PeriodTimeMap = new()
        {
            { "1-2èŠ‚", "08:00-09:40" },
            { "01-02èŠ‚", "08:00-09:40" },
            { "3-4èŠ‚", "09:55-11:35" },
            { "03-04èŠ‚", "09:55-11:35" },
            { "5-6èŠ‚", "13:30-15:10" },
            { "05-06èŠ‚", "13:30-15:10" },
            { "7-8èŠ‚", "15:25-17:05" },
            { "07-08èŠ‚", "15:25-17:05" },
            { "9-10èŠ‚", "18:00-19:35" },
            { "09-10èŠ‚", "18:00-19:35" },
            { "9-11èŠ‚", "18:00-20:30" },
            { "09-11èŠ‚", "18:00-20:30" }
        };

        public List<string> GetVacantRooms(string campus, string weekday, string period, string building, string week)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = _httpContextAccessor.HttpContext?.Request.Headers.UserAgent.ToString() ?? "";

            // æ™ºèƒ½æ—¥å¿—è®°å½•ï¼šé¿å…é‡å¤è®°å½•ç›¸åŒç”¨æˆ·çš„é¢‘ç¹æŸ¥è¯¢
            bool shouldLog = ShouldLogUserQuery(ip, "VACANT_ROOMS");

            if (shouldLog)
            {
                // ç®€åŒ–æ—¥å¿—ä¿¡æ¯ï¼Œå»é™¤æ•æ„Ÿç»†èŠ‚
                var logDetails = $"{campus.Substring(0, 2)} {weekday} {period} {building}æ¥¼ {week}";
                _logger.LogAccess(ip, "QUERY_VACANT_ROOMS", logDetails, TruncateUserAgent(userAgent));

                // é€šçŸ¥ç®¡ç†åå°æœ‰æ–°çš„æ—¥å¿—
                _notificationService.NotifyLogsUpdated();
            }

            var filePath = Path.Combine(AppContext.BaseDirectory, "Data", "schedule.xlsx");
            if (!File.Exists(filePath))
            {
                // é”™è¯¯æƒ…å†µå¿…é¡»è®°å½•
                _logger.LogAccess(ip, "ERROR_FILE_NOT_FOUND", filePath, userAgent);
                _notificationService.NotifyLogsUpdated();
                return new List<string>();
            }

            var occupiedRooms = new HashSet<string>();

            try
            {
                using var workbook = new XLWorkbook(filePath);
                var sheet = workbook.Worksheets.First();

                foreach (var row in sheet.RowsUsed().Skip(1))
                {
                    var rowCampus = row.Cell(10).GetString();
                    var rowTime = row.Cell(14).GetString();
                    var rowWeeks = row.Cell(15).GetString();
                    var room = row.Cell(16).GetString();

                    if (!room.Any()) continue;

                    if (rowCampus != campus) continue;
                    if (!IsPeriodMatch(rowTime, weekday, period)) continue;
                    if (!IsWeekMatch(rowWeeks, week)) continue;

                    occupiedRooms.Add(room);
                }

                var allRooms = list;
                var result = allRooms
                    .Where(r => !occupiedRooms.Contains(r) &&
                                (building == "æ‰€æœ‰" || r.StartsWith(building)))
                    .ToList();

                // åªåœ¨éœ€è¦æ—¶è®°å½•æŸ¥è¯¢ç»“æœ
                if (shouldLog)
                {
                    _logger.LogAccess(ip, "QUERY_RESULT", $"Found {result.Count} vacant rooms", "");
                    _notificationService.NotifyLogsUpdated();
                }

                return result;
            }
            catch (Exception ex)
            {
                // å¼‚å¸¸å¿…é¡»è®°å½•
                _logger.LogAccess(ip, "ERROR_QUERY_EXCEPTION", $"Exception: {ex.Message}", userAgent);
                _notificationService.NotifyLogsUpdated();
                return new List<string>();
            }
        }

        public List<RoomUsage> GetRoomUsage(string campus, string roomNumber, string weekday, string week)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "Unknown";
            var userAgent = _httpContextAccessor.HttpContext?.Request.Headers.UserAgent.ToString() ?? "";

            bool shouldLog = ShouldLogUserQuery(ip, "ROOM_USAGE");

            if (shouldLog)
            {
                var logDetails = $"{campus.Substring(0, 2)} {roomNumber} {weekday} {week}";
                _logger.LogAccess(ip, "QUERY_ROOM_USAGE", logDetails, TruncateUserAgent(userAgent));
                _notificationService.NotifyLogsUpdated();
            }

            var filePath = Path.Combine(AppContext.BaseDirectory, "Data", "schedule.xlsx");
            if (!File.Exists(filePath))
            {
                _logger.LogAccess(ip, "ERROR_FILE_NOT_FOUND", filePath, userAgent);
                _notificationService.NotifyLogsUpdated();
                return new List<RoomUsage>();
            }

            var roomUsages = new List<RoomUsage>();

            try
            {
                using var workbook = new XLWorkbook(filePath);
                var sheet = workbook.Worksheets.First();

                foreach (var row in sheet.RowsUsed().Skip(1))
                {
                    var rowCampus = row.Cell(10).GetString();
                    var rowTime = row.Cell(14).GetString();
                    var rowWeeks = row.Cell(15).GetString();
                    var room = row.Cell(16).GetString();
                    var courseName = row.Cell(5).GetString();
                    var teacher = row.Cell(12).GetString();

                    if (string.IsNullOrEmpty(room)) continue;
                    if (rowCampus != campus) continue;
                    if (room != roomNumber) continue;
                    if (!IsWeekdayMatch(rowTime, weekday)) continue;
                    if (!IsWeekMatch(rowWeeks, week)) continue;

                    var period = ExtractPeriodFromTime(rowTime);
                    var timeRange = GetTimeRangeForPeriod(period);

                    roomUsages.Add(new RoomUsage
                    {
                        Period = period,
                        TimeRange = timeRange,
                        CourseName = courseName,
                        Teacher = teacher,
                    });
                }

                var periodOrder = new Dictionary<string, int>
                {
                    { "1-2èŠ‚", 1 }, { "01-02èŠ‚", 1 },
                    { "3-4èŠ‚", 2 }, { "03-04èŠ‚", 2 },
                    { "5-6èŠ‚", 3 }, { "05-06èŠ‚", 3 },
                    { "7-8èŠ‚", 4 }, { "07-08èŠ‚", 4 },
                    { "9-10èŠ‚", 5 }, { "09-10èŠ‚", 5 },
                    { "9-11èŠ‚", 6 }, { "09-11èŠ‚", 6 },
                    { "10-11èŠ‚", 7 }, { "10-12èŠ‚", 8 }
                };

                var result = roomUsages.OrderBy(r => periodOrder.GetValueOrDefault(r.Period, 999)).ToList();

                if (shouldLog)
                {
                    _logger.LogAccess(ip, "QUERY_RESULT", $"Found {result.Count} room usage records", "");
                    _notificationService.NotifyLogsUpdated();
                }

                return result;
            }
            catch (Exception ex)
            {
                _logger.LogAccess(ip, "ERROR_QUERY_EXCEPTION", $"Exception: {ex.Message}", userAgent);
                _notificationService.NotifyLogsUpdated();
                return new List<RoomUsage>();
            }
        }

        // æ™ºèƒ½æŸ¥è¯¢æ—¥å¿—è®°å½•ç­–ç•¥
        private bool ShouldLogUserQuery(string ip, string queryType)
        {
            lock (_queryLock)
            {
                var now = DateTime.Now;
                var key = $"{ip}_{queryType}";

                // æ¸…ç†è¿‡æœŸè®°å½•
                CleanupOldQueryRecords();

                // æ›´æ–°æŸ¥è¯¢è®¡æ•°
                _queryCount[key] = _queryCount.GetValueOrDefault(key, 0) + 1;
                _lastQueryTime[key] = now;

                // æ£€æŸ¥æ˜¯å¦éœ€è¦è®°å½•é«˜é¢‘è­¦å‘Š
                if (_queryCount[key] > 50) // æé«˜é˜ˆå€¼ï¼Œ5åˆ†é’Ÿå†…è¶…è¿‡50æ¬¡æ‰è­¦å‘Š
                {
                    _logger.LogAccess(ip, "QUERY_HIGH_FREQUENCY", $"High frequency queries: {_queryCount[key]} in 5min", "");
                    _queryCount[key] = 0; // é‡ç½®è®¡æ•°é¿å…é‡å¤è­¦å‘Š
                }

                // æ‰€æœ‰æ­£å¸¸æŸ¥è¯¢éƒ½è®°å½•ï¼Œä¸è¿‡æ»¤é‡å¤æŸ¥è¯¢
                return true;
            }
        }

        private void CleanupOldQueryRecords()
        {
            var cutoff = DateTime.Now.AddMinutes(-5);
            var keysToRemove = _lastQueryTime
                .Where(kvp => kvp.Value < cutoff)
                .Select(kvp => kvp.Key)
                .ToList();

            foreach (var key in keysToRemove)
            {
                _lastQueryTime.Remove(key);
                _queryCount.Remove(key);
            }
        }

        private string TruncateUserAgent(string userAgent)
        {
            if (string.IsNullOrEmpty(userAgent)) return "";
            return userAgent.Length > 30 ? userAgent.Substring(0, 30) + "..." : userAgent;
        }

        public List<string> GetRoomsForBuilding(string building)
        {
            if (string.IsNullOrEmpty(building)) return new List<string>();

            return list.Where(r => r.StartsWith(building))
                      .Select(r => r.Substring(1))
                      .Distinct()
                      .OrderBy(r => r)
                      .ToList();
        }

        // Keep all existing helper methods unchanged
        private bool IsWeekdayMatch(string rowTime, string selectedWeekday)
        {
            string ExtractWeekday(string text)
            {
                if (text.StartsWith("å‘¨") && text.Length >= 2)
                    return text.Substring(0, 2);
                return "";
            }

            return ExtractWeekday(rowTime) == ExtractWeekday(selectedWeekday);
        }

        private string ExtractPeriodFromTime(string rowTime)
        {
            var parts = rowTime.Split(' ');
            if (parts.Length > 1)
            {
                var periodPart = parts[1];
                if (periodPart.EndsWith("èŠ‚"))
                {
                    return periodPart;
                }
                else
                {
                    return periodPart + "èŠ‚";
                }
            }
            return "";
        }

        private string GetTimeRangeForPeriod(string period)
        {
            period = period.Replace("èŠ‚", "");
            if (!period.Contains("-"))
            {
                if (int.TryParse(period, out int num))
                {
                    period = $"{num}-{num}";
                }
            }
            period += "èŠ‚";

            return PeriodTimeMap.GetValueOrDefault(period, "æ—¶é—´æœªçŸ¥");
        }

        private bool IsWeekMatch(string rowWeeks, string selectedWeek)
        {
            if (!int.TryParse(selectedWeek.Replace("ç¬¬", "").Replace("å‘¨", ""), out int weekNumber))
                return false;

            rowWeeks = rowWeeks.Replace("å‘¨", "").Replace(" ", "");
            bool isSingle = rowWeeks.EndsWith("å•");
            bool isDouble = rowWeeks.EndsWith("åŒ");
            bool isAll = rowWeeks.EndsWith("å…¨");

            if (isSingle || isDouble || isAll)
                rowWeeks = rowWeeks.Substring(0, rowWeeks.Length - 1);

            var matched = false;

            foreach (var part in rowWeeks.Split(','))
            {
                if (part.Contains('-'))
                {
                    var bounds = part.Split('-');
                    if (bounds.Length == 2 &&
                        int.TryParse(bounds[0], out int start) &&
                        int.TryParse(bounds[1], out int end))
                    {
                        if (weekNumber >= start && weekNumber <= end)
                        {
                            matched = true;
                            break;
                        }
                    }
                }
                else if (int.TryParse(part, out int val))
                {
                    if (val == weekNumber)
                    {
                        matched = true;
                        break;
                    }
                }
            }

            if (!matched) return false;

            if (isSingle && weekNumber % 2 == 0) return false;
            if (isDouble && weekNumber % 2 != 0) return false;

            return true;
        }

        private bool IsPeriodMatch(string rowTime, string selectedWeekday, string selectedPeriod)
        {
            string Normalize(string text) => text.Replace("èŠ‚", "").Replace(" ", "");

            string ExtractWeekday(string text)
            {
                if (text.StartsWith("å‘¨") && text.Length >= 2)
                    return text.Substring(0, 2);
                return "";
            }

            string ExtractRange(string text)
            {
                var norm = Normalize(text);
                var idx = norm.IndexOfAny("ä¸€äºŒä¸‰å››äº”å…­æ—¥".ToCharArray());
                if (idx >= 0 && idx + 1 < norm.Length)
                    return norm.Substring(idx + 1);
                return "";
            }

            bool TryParseRange(string range, out int start, out int end)
            {
                start = end = 0;
                var nums = range.Split('-');
                if (nums.Length == 2 &&
                    int.TryParse(nums[0], out start) &&
                    int.TryParse(nums[1], out end)) return true;
                return false;
            }

            string rowWeekday = ExtractWeekday(rowTime);
            string userWeekday = ExtractWeekday(selectedWeekday);

            if (rowWeekday != userWeekday) return false;

            string rowRange = ExtractRange(rowTime);
            string userRange = Normalize(selectedPeriod);

            if (TryParseRange(rowRange, out int rowStart, out int rowEnd) &&
                TryParseRange(userRange, out int userStart, out int userEnd))
            {
                return userStart >= rowStart && userEnd <= rowEnd;
            }

            return false;
        }
    }

    public class RoomUsage
    {
        public string Period { get; set; } = "";
        public string TimeRange { get; set; } = "";
        public string CourseName { get; set; } = "";
        public string Teacher { get; set; } = "";
    }
}


============================================================
FILE: VacantRoomWeb.csproj
============================================================
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
	  <AspNetCoreHostingModel>OutOfProcess</AspNetCoreHostingModel>
	  <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="ClosedXML" Version="0.105.0" />
  </ItemGroup>

  <ItemGroup>
    <Folder Include="Data\" />
  </ItemGroup>

  <ItemGroup>
    <None Update="Data\schedule.xlsx">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <ProjectExtensions><VisualStudio><UserProperties properties_4launchsettings_1json__JsonSchema="" /></VisualStudio></ProjectExtensions>

</Project>
    


============================================================
FILE: appsettings.Development.json
============================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}



============================================================
FILE: appsettings.json
============================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "AdminConfig": {
    "Username": "admin_origami",
    "PasswordHash": "JZbYNmQ8Yi6IRfEht363YGJgjY5eaB7UsfyggX953KQ=",
    "Salt": "2BfcmATnJ9qH8oMxrOXqn7JFwQ+mbf5QdGwv76nFmjI=",
    "SecretKey": "mflfYqSSkeacMKzgcH4faGv6FcpYEme9ssPwUEVplacVPYTgYwvomwGkftir+lqdvPolUbsilnmX97vcXeyqCA=="
  },
  "Email": {
    "NotifyHubAPI": {
      "BaseUrl": "https://notify.origami7023.cn",
      "ApiKey": "default-api-key-2024"
    },
    "DefaultRecipient": "origami7023@gmail.com"
  }
}


============================================================
FILE: wwwroot\app.css
============================================================
html, body {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

a, .btn-link {
    color: #006bb7;
}

.btn-primary {
    color: #fff;
    background-color: #1b6ec2;
    border-color: #1861ac;
}

.btn:focus, .btn:active:focus, .btn-link.nav-link:focus, .form-control:focus, .form-check-input:focus {
  box-shadow: 0 0 0 0.1rem white, 0 0 0 0.25rem #258cfb;
}

.content {
    padding-top: 1.1rem;
}

h1:focus {
    outline: none;
}

.valid.modified:not([type=checkbox]) {
    outline: 1px solid #26b050;
}

.invalid {
    outline: 1px solid #e50000;
}

.validation-message {
    color: #e50000;
}

.blazor-error-boundary {
    background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTYiIGhlaWdodD0iNDkiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIG92ZXJmbG93PSJoaWRkZW4iPjxkZWZzPjxjbGlwUGF0aCBpZD0iY2xpcDAiPjxyZWN0IHg9IjIzNSIgeT0iNTEiIHdpZHRoPSI1NiIgaGVpZ2h0PSI0OSIvPjwvY2xpcFBhdGg+PC9kZWZzPjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMCkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yMzUgLTUxKSI+PHBhdGggZD0iTTI2My41MDYgNTFDMjY0LjcxNyA1MSAyNjUuODEzIDUxLjQ4MzcgMjY2LjYwNiA1Mi4yNjU4TDI2Ny4wNTIgNTIuNzk4NyAyNjcuNTM5IDUzLjYyODMgMjkwLjE4NSA5Mi4xODMxIDI5MC41NDUgOTIuNzk1IDI5MC42NTYgOTIuOTk2QzI5MC44NzcgOTMuNTEzIDI5MSA5NC4wODE1IDI5MSA5NC42NzgyIDI5MSA5Ny4wNjUxIDI4OS4wMzggOTkgMjg2LjYxNyA5OUwyNDAuMzgzIDk5QzIzNy45NjMgOTkgMjM2IDk3LjA2NTEgMjM2IDk0LjY3ODIgMjM2IDk0LjM3OTkgMjM2LjAzMSA5NC4wODg2IDIzNi4wODkgOTMuODA3MkwyMzYuMzM4IDkzLjAxNjIgMjM2Ljg1OCA5Mi4xMzE0IDI1OS40NzMgNTMuNjI5NCAyNTkuOTYxIDUyLjc5ODUgMjYwLjQwNyA1Mi4yNjU4QzI2MS4yIDUxLjQ4MzcgMjYyLjI5NiA1MSAyNjMuNTA2IDUxWk0yNjMuNTg2IDY2LjAxODNDMjYwLjczNyA2Ni4wMTgzIDI1OS4zMTMgNjcuMTI0NSAyNTkuMzEzIDY5LjMzNyAyNTkuMzEzIDY5LjYxMDIgMjU5LjMzMiA2OS44NjA4IDI1OS4zNzEgNzAuMDg4N0wyNjEuNzk1IDg0LjAxNjEgMjY1LjM4IDg0LjAxNjEgMjY3LjgyMSA2OS43NDc1QzI2Ny44NiA2OS43MzA5IDI2Ny44NzkgNjkuNTg3NyAyNjcuODc5IDY5LjMxNzkgMjY3Ljg3OSA2Ny4xMTgyIDI2Ni40NDggNjYuMDE4MyAyNjMuNTg2IDY2LjAxODNaTTI2My41NzYgODYuMDU0N0MyNjEuMDQ5IDg2LjA1NDcgMjU5Ljc4NiA4Ny4zMDA1IDI1OS43ODYgODkuNzkyMSAyNTkuNzg2IDkyLjI4MzcgMjYxLjA0OSA5My41Mjk1IDI2My41NzYgOTMuNTI5NSAyNjYuMTE2IDkzLjUyOTUgMjY3LjM4NyA5Mi4yODM3IDI2Ny4zODcgODkuNzkyMSAyNjcuMzg3IDg3LjMwMDUgMjY2LjExNiA4Ni4wNTQ3IDI2My41NzYgODYuMDU0N1oiIGZpbGw9IiNGRkU1MDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvZz48L3N2Zz4=) no-repeat 1rem/1.8rem, #b32121;
    padding: 1rem 1rem 1rem 3.7rem;
    color: white;
}

    .blazor-error-boundary::after {
        content: "An error has occurred."
    }

.darker-border-checkbox.form-check-input {
    border-color: #929292;
}

.query-card {
    background-color: #222;
    padding: 20px;
    border-radius: 10px;
    width: 300px;
}

.form-group {
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

    .form-group label {
        color: white;
        width: 80px;
    }

select {
    background-color: #333;
    color: white;
    border: 1px solid #555;
    padding: 5px;
    width: 150px;
}

.btn {
    background-color: #4CAF50;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

    .btn:hover {
        background-color: #45a049;
    }

.red {
    color: #ff6666;
}

.orange {
    color: #f4a261;
}

.gray {
    color: #aaa;
}



============================================================
FILE: wwwroot\css\layout.css
============================================================
ï»¿/* Full height layout */
html, body {
    height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

.page-wrapper {
    height: 100vh !important;
    display: flex !important;
    flex-direction: column !important;
}

.page {
    flex: 1 !important;
    display: flex !important;
    min-height: 0 !important;
}

/* Sidebar styling */
.sidebar {
    width: 250px !important;
    flex-shrink: 0 !important;
}

/* Main content area with sticky footer */
main {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important;
}

.content {
    flex: 1 !important;
    overflow-y: auto !important;
}

/* Sticky footer - always at bottom of main area */
.sticky-footer {
    background-color: #f8f9fa !important;
    border-top: 1px solid #dee2e6 !important;
    padding: 15px !important;
    text-align: center !important;
    color: #6c757d !important;
    font-size: 0.875rem !important;
    white-space: nowrap !important;
    flex-shrink: 0 !important;
}

    .sticky-footer a {
        color: #007bff !important;
        text-decoration: underline !important;
    }

        .sticky-footer a:hover {
            color: #0056b3 !important;
            text-decoration: underline !important;
        }

/* Mobile responsiveness */
@media (max-width: 768px) {
    .sidebar {
        width: 100% !important;
        height: auto !important;
    }

    .page {
        flex-direction: column !important;
    }

    .sticky-footer {
        white-space: normal !important;
        font-size: 0.8rem !important;
        padding: 10px !important;
    }
}



================================================================================
END OF CODE FILES
================================================================================
