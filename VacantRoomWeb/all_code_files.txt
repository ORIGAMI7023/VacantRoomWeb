================================================================================
VACANTROOM WEB PROJECT - ALL CODE FILES
================================================================================


============================================================
FILE: ClientConnectionTracker.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// ç”¨äºåœ¨ç”¨æˆ·è¿æ¥æ—¶è®°å½• IPï¼Œåœ¨æ–­å¼€æ—¶æŸ¥å‡ºå¯¹åº” IP
    /// </summary>
    public class ClientConnectionTracker
    {
        private readonly Dictionary<string, string> _ipMap = new();
        private readonly object _lock = new();

        public void SetClientIp(string circuitId, string ip)
        {
            lock (_lock)
            {
                _ipMap[circuitId] = ip;
            }
        }

        public string? GetClientIp(string circuitId)
        {
            lock (_lock)
            {
                return _ipMap.TryGetValue(circuitId, out var ip) ? ip : null;
            }
        }

        public void Remove(string circuitId)
        {
            lock (_lock)
            {
                _ipMap.Remove(circuitId);
            }
        }
    }

}



============================================================
FILE: Components\App.razor
============================================================
ï»¿<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="VacantRoomWeb.styles.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <HeadOutlet />
</head>

<body>
    <Routes />
    <script src="_framework/blazor.web.js"></script>
</body>

</html>



============================================================
FILE: Components\Layout\MainLayout.razor
============================================================
ï»¿@inherits LayoutComponentBase

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div>

        <article class="content px-4">
            @Body
        </article>

    </main>
</div>


<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">ğŸ—™</a>
</div>



============================================================
FILE: Components\Layout\NavMenu.razor
============================================================
ï»¿<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">VacantRoomWeb</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="">
                <span class="oi oi-list-rich" aria-hidden="true"></span> ç©ºæ•™å®¤æŸ¥è¯¢
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="counter">
                <span class="bi bi-plus-square-fill-nav-menu" aria-hidden="true"></span> Counter
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="weather">
                <span class="bi bi-list-nested-nav-menu" aria-hidden="true"></span> Weather
            </NavLink>
        </div>
    </nav>
</div>


============================================================
FILE: Components\Pages\Counter.razor
============================================================
ï»¿@page "/counter"
@rendermode InteractiveServer

<PageTitle>Counter</PageTitle>

<h1>Counter</h1>

<p role="status">Current count: @currentCount</p>

<button class="btn btn-primary" @onclick="IncrementCount">Click me</button>

@code {
    private int currentCount = 0;

    private void IncrementCount()
    {
        currentCount++;
    }
}



============================================================
FILE: Components\Pages\Error.razor
============================================================
ï»¿@page "/Error"
@using System.Diagnostics

<PageTitle>Error</PageTitle>

<h1 class="text-danger">Error.</h1>
<h2 class="text-danger">An error occurred while processing your request.</h2>

@if (ShowRequestId)
{
    <p>
        <strong>Request ID:</strong> <code>@RequestId</code>
    </p>
}

<h3>Development Mode</h3>
<p>
    Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
</p>
<p>
    <strong>The Development environment shouldn't be enabled for deployed applications.</strong>
    It can result in displaying sensitive information from exceptions to end users.
    For local debugging, enable the <strong>Development</strong> environment by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
    and restarting the app.
</p>

@code{
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private string? RequestId { get; set; }
    private bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

    protected override void OnInitialized() =>
        RequestId = Activity.Current?.Id ?? HttpContext?.TraceIdentifier;
}



============================================================
FILE: Components\Pages\VacantRoom.razor
============================================================
ï»¿@page "/"
@rendermode InteractiveServer
@inject VacantRoomService VacantService

<h3 style="margin-bottom: 1rem;">æ•™å®¤æŸ¥è¯¢ç³»ç»Ÿ</h3>
<p style="font-size: 1.1rem; color: gray;">@TodayText</p>

<!-- Tab Navigation -->
<div style="margin-bottom: 2rem;">
    <button @onclick="() => SetActiveTab(0)"
            style="@GetTabStyle(0)">
        ç©ºæ•™å®¤æŸ¥è¯¢
    </button>
    <button @onclick="() => SetActiveTab(1)"
            style="@GetTabStyle(1)">
        æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢
    </button>
</div>

<div style="max-width: 500px;">

    @if (ActiveTab == 0)
    {
        <!-- ç©ºæ•™å®¤æŸ¥è¯¢ -->
        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ ¡åŒºï¼š</label>
            <select @bind="Campus" style="width: 200px;">
                <option value="å¥‰è´¤æ ¡åŒº">å¥‰è´¤</option>
                <option value="å¾æ±‡æ ¡åŒº">å¾æ±‡</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ˜ŸæœŸï¼š</label>
            <select @bind="Weekday" style="width: 200px;">
                <option>å‘¨ä¸€</option>
                <option>å‘¨äºŒ</option>
                <option>å‘¨ä¸‰</option>
                <option>å‘¨å››</option>
                <option>å‘¨äº”</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">èŠ‚æ¬¡ï¼š</label>
            <select @bind="Period" style="width: 200px;">
                <option>1-2èŠ‚</option>
                <option>3-4èŠ‚</option>
                <option>5-6èŠ‚</option>
                <option>7-8èŠ‚</option>
                <option>9-10èŠ‚</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å­¦æ¥¼ï¼š</label>
            <select @bind="Building" style="width: 200px;">
                <option>æ‰€æœ‰</option>
                <option>A</option>
                <option>B</option>
                <option>C</option>
                <option>D</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">ç¬¬å‡ å‘¨ï¼š</label>
            <select @bind="Week" style="width: 200px;">
                @for (int i = 1; i <= 18; i++)
                {
                    <option value="@($"ç¬¬{i}å‘¨")">ç¬¬ @i å‘¨</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <button @onclick="QueryVacantRooms" style="padding: 8px 16px; font-weight: bold; background-color: #007bff; color: white; border: none; border-radius: 4px;">
                æŸ¥è¯¢ç©ºæ•™å®¤
            </button>
        </div>

        <hr />

        <p style="color: red;">[Debug]å½“å‰é€‰ä¸­ï¼š @Campus, @Weekday, @Period, @Building, @Week</p>

        @if (VacantResult != null)
        {
            <p style="color: orange;">[Debug]å…±æŸ¥è¯¢åˆ° @VacantResult.Count ä¸ªç©ºæ•™å®¤</p>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 4px;">
                <ul style="margin: 0; padding-left: 20px;">
                    @foreach (var room in VacantResult)
                    {
                        <li>@room</li>
                    }
                </ul>
            </div>
        }
        else
        {
            <p style="color: gray;">è¯·å¡«å†™æ¡ä»¶åç‚¹å‡»æŸ¥è¯¢</p>
        }
    }
    else
    {
        <!-- æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢ -->
        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ ¡åŒºï¼š</label>
            <select @bind="RoomCampus" style="width: 200px;">
                <option value="å¥‰è´¤æ ¡åŒº">å¥‰è´¤</option>
                <option value="å¾æ±‡æ ¡åŒº">å¾æ±‡</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å­¦æ¥¼ï¼š</label>
            <select value="@RoomBuilding" @onchange="OnBuildingChanged" style="width: 200px;">
                <option value="">è¯·é€‰æ‹©æ•™å­¦æ¥¼</option>
                <option value="A">Aæ¥¼</option>
                <option value="B">Bæ¥¼</option>
                <option value="C">Cæ¥¼</option>
                <option value="D">Dæ¥¼</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ•™å®¤å·ï¼š</label>
            <select @bind="RoomNumber" style="width: 200px;" disabled="@string.IsNullOrEmpty(RoomBuilding)">
                @if (string.IsNullOrEmpty(RoomBuilding))
                {
                    <option value="">è¯·å…ˆé€‰æ‹©æ•™å­¦æ¥¼</option>
                }
                else
                {
                    <option value="">è¯·é€‰æ‹©æ•™å®¤</option>
                    @foreach (var room in GetRoomsForBuilding(RoomBuilding))
                    {
                        <option value="@room">@room</option>
                    }
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">æ˜ŸæœŸï¼š</label>
            <select @bind="RoomWeekday" style="width: 200px;">
                <option>å‘¨ä¸€</option>
                <option>å‘¨äºŒ</option>
                <option>å‘¨ä¸‰</option>
                <option>å‘¨å››</option>
                <option>å‘¨äº”</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: inline-block; width: 80px;">ç¬¬å‡ å‘¨ï¼š</label>
            <select @bind="RoomWeek" style="width: 200px;">
                @for (int i = 1; i <= 18; i++)
                {
                    <option value="@($"ç¬¬{i}å‘¨")">ç¬¬ @i å‘¨</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <button @onclick="QueryRoomUsage"
                    disabled="@string.IsNullOrEmpty(RoomNumber)"
                    style="padding: 8px 16px; font-weight: bold; background-color: #28a745; color: white; border: none; border-radius: 4px; opacity: @(string.IsNullOrEmpty(RoomNumber) ? "0.5" : "1");">
                æŸ¥è¯¢æ•™å®¤ä½¿ç”¨æƒ…å†µ
            </button>
        </div>

        <hr />

        <p style="color: red;">[Debug]å½“å‰é€‰ä¸­ï¼š @RoomCampus, @RoomBuilding @RoomNumber, @RoomWeekday, @RoomWeek</p>

        @if (UsageResult != null)
        {
            <div style="border: 1px solid #ccc; border-radius: 4px; padding: 15px; background-color: #f8f9fa;">
                <h4 style="margin-top: 0; color: #495057;">@RoomBuilding@RoomNumber æ•™å®¤ä½¿ç”¨æƒ…å†µ</h4>
                <p style="color: #6c757d; margin-bottom: 15px;">@RoomCampus Â· @RoomWeekday Â· @RoomWeek</p>

                @if (UsageResult.Count == 0)
                {
                    <p style="color: green; font-weight: bold;">âœ… è¯¥æ•™å®¤å½“å¤©å…¨å¤©ç©ºé—²</p>
                }
                else
                {
                    <div style="display: grid; gap: 8px;">
                        @foreach (var usage in UsageResult)
                        {
                            <div style="background-color: white; padding: 12px; border-radius: 4px; border-left: 4px solid #dc3545;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: #dc3545;">@usage.Period</span>
                                    <span style="font-size: 0.9em; color: #6c757d;">@usage.TimeRange</span>
                                </div>
                                <div style="margin-top: 4px; color: #495057;">
                                    <strong>è¯¾ç¨‹ï¼š</strong>@usage.CourseName
                                </div>
                                @if (!string.IsNullOrEmpty(usage.Teacher))
                                {
                                    <div style="font-size: 0.9em; color: #6c757d;">
                                        <strong>æ•™å¸ˆï¼š</strong>@usage.Teacher
                                    </div>
                                }
                                
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <p style="color: gray;">è¯·é€‰æ‹©æ•™å®¤åç‚¹å‡»æŸ¥è¯¢</p>
        }
    }

</div>

<!-- ======= å¤‡æ¡ˆä¿¡æ¯é¡µè„š BEGIN ======= -->
<footer class="text-center text-muted small py-3" style="white-space:nowrap;">
    Â©@(DateTime.Now.Year) origami7023.cn&nbsp;|&nbsp;
    <a href="https://beian.miit.gov.cn/" target="_blank">
        æ²ªICPå¤‡2025129900å·-1
    </a>
</footer>
<!-- ======= å¤‡æ¡ˆä¿¡æ¯é¡µè„š END ======= -->
@code {
    // Tab management
    int ActiveTab = 0;

    // ç©ºæ•™å®¤æŸ¥è¯¢ç›¸å…³å˜é‡
    string Campus = "å¥‰è´¤æ ¡åŒº";
    string Weekday = "";
    string Period = "1-2èŠ‚";
    string Building = "æ‰€æœ‰";
    string Week = "ç¬¬1å‘¨";
    List<string> VacantResult;

    // æ•™å®¤ä½¿ç”¨æƒ…å†µæŸ¥è¯¢ç›¸å…³å˜é‡
    string RoomCampus = "å¥‰è´¤æ ¡åŒº";
    string RoomBuilding = "";
    string RoomNumber = "";
    string RoomWeekday = "";
    string RoomWeek = "ç¬¬1å‘¨";
    List<VacantRoomWeb.RoomUsage> UsageResult;

    string TodayText;

    // RoomUsage class is now in VacantRoomService.cs

    void SetActiveTab(int tabIndex)
    {
        ActiveTab = tabIndex;
        // åˆ‡æ¢æ ‡ç­¾æ—¶æ¸…ç©ºç»“æœ
        if (tabIndex == 0)
        {
            UsageResult = null;
        }
        else
        {
            VacantResult = null;
        }
    }

    string GetTabStyle(int tabIndex)
    {
        var baseStyle = "padding: 10px 20px; margin-right: 5px; border: 1px solid #ccc; border-radius: 4px 4px 0 0; cursor: pointer; background-color: ";
        return baseStyle + (ActiveTab == tabIndex ? "#007bff; color: white;" : "#f8f9fa; color: #495057;");
    }

    // â€”â€” èŠ‚æ¬¡æ—¶é—´è¡¨ï¼ˆä»…ç”¨äºè‡ªåŠ¨é€‰æ‹©ï¼‰â€”â€”
    List<(TimeSpan Start, TimeSpan End, string Label)> PeriodSlots = new()
    {
        (new TimeSpan(8, 00, 00), new TimeSpan(9, 40, 00), "1-2èŠ‚"),
        (new TimeSpan(9, 55, 00), new TimeSpan(11, 35, 00), "3-4èŠ‚"),
        (new TimeSpan(13, 30, 00), new TimeSpan(15, 10, 00), "5-6èŠ‚"),
        (new TimeSpan(15, 25, 00), new TimeSpan(17, 05, 00), "7-8èŠ‚"),
        (new TimeSpan(18, 30, 00), new TimeSpan(20, 10, 00), "9-10èŠ‚"),
    };

    void SetDefaultPeriodByNow()
    {
        DateTime now = DateTime.Now;
        TimeSpan t = now.TimeOfDay;

        for (int i = 0; i < PeriodSlots.Count; i++)
        {
            (TimeSpan Start, TimeSpan End, string Label) slot = PeriodSlots[i];

            if (t >= slot.Start && t <= slot.End)
            {
                int nextIndex = i + 1;
                if (nextIndex < PeriodSlots.Count)
                {
                    Period = PeriodSlots[nextIndex].Label;
                }
                else
                {
                    Period = "1-2èŠ‚";
                }
                return;
            }
        }

        if (t < PeriodSlots[0].Start)
        {
            Period = PeriodSlots[0].Label;
            return;
        }

        Period = "1-2èŠ‚";
    }

    void QueryVacantRooms()
    {
        VacantResult = VacantService.GetVacantRooms(Campus, Weekday, Period, Building, Week);
    }

    void QueryRoomUsage()
    {
        if (string.IsNullOrEmpty(RoomNumber)) return;

        // è°ƒç”¨æœåŠ¡è·å–æ•™å®¤ä½¿ç”¨æƒ…å†µ
        UsageResult = VacantService.GetRoomUsage(RoomCampus, RoomBuilding + RoomNumber, RoomWeekday, RoomWeek);
    }

    void OnBuildingChanged(ChangeEventArgs e)
    {
        RoomBuilding = e.Value?.ToString() ?? "";
        RoomNumber = ""; // æ¸…ç©ºæ•™å®¤å·é€‰æ‹©
    }

    List<string> GetRoomsForBuilding(string building)
    {
        // ä½¿ç”¨æœåŠ¡è·å–å®é™…çš„æ•™å®¤åˆ—è¡¨
        return VacantService.GetRoomsForBuilding(building);
    }

    protected override void OnInitialized()
    {
        var today = DateTime.Today.DayOfWeek;
        TodayText = DateTime.Today.ToString("D");

        string todayWeekday = today switch
        {
            DayOfWeek.Monday => "å‘¨ä¸€",
            DayOfWeek.Tuesday => "å‘¨äºŒ",
            DayOfWeek.Wednesday => "å‘¨ä¸‰",
            DayOfWeek.Thursday => "å‘¨å››",
            DayOfWeek.Friday => "å‘¨äº”",
            _ => "å‘¨ä¸€"
        };

        Weekday = todayWeekday;
        RoomWeekday = todayWeekday;

        DateTime week14Start = new DateTime(2025, 9, 8);
        int passedDays = (DateTime.Today - week14Start).Days;
        int weekOffset = passedDays / 7;
        int currentWeekNumber = 1 + weekOffset;

        if (currentWeekNumber < 1) currentWeekNumber = 1;
        if (currentWeekNumber > 18) currentWeekNumber = 18;

        Week = $"ç¬¬{currentWeekNumber}å‘¨";
        RoomWeek = $"ç¬¬{currentWeekNumber}å‘¨";

        SetDefaultPeriodByNow();
    }
}


============================================================
FILE: Components\Pages\Weather.razor
============================================================
ï»¿@page "/weather"
@attribute [StreamRendering]

<PageTitle>Weather</PageTitle>

<h1>Weather</h1>

<p>This component demonstrates showing data.</p>

@if (forecasts == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Temp. (C)</th>
                <th>Temp. (F)</th>
                <th>Summary</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var forecast in forecasts)
            {
                <tr>
                    <td>@forecast.Date.ToShortDateString()</td>
                    <td>@forecast.TemperatureC</td>
                    <td>@forecast.TemperatureF</td>
                    <td>@forecast.Summary</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private WeatherForecast[]? forecasts;

    protected override async Task OnInitializedAsync()
    {
        // Simulate asynchronous loading to demonstrate streaming rendering
        await Task.Delay(500);

        var startDate = DateOnly.FromDateTime(DateTime.Now);
        var summaries = new[] { "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching" };
        forecasts = Enumerable.Range(1, 5).Select(index => new WeatherForecast
        {
            Date = startDate.AddDays(index),
            TemperatureC = Random.Shared.Next(-20, 55),
            Summary = summaries[Random.Shared.Next(summaries.Length)]
        }).ToArray();
    }

    private class WeatherForecast
    {
        public DateOnly Date { get; set; }
        public int TemperatureC { get; set; }
        public string? Summary { get; set; }
        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
    }
}



============================================================
FILE: Components\Routes.razor
============================================================
ï»¿<Router AppAssembly="typeof(Program).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)" />
        <FocusOnNavigate RouteData="routeData" Selector="h1" />
    </Found>
</Router>



============================================================
FILE: Components\_Imports.razor
============================================================
ï»¿@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@using VacantRoomWeb
@using VacantRoomWeb.Components



============================================================
FILE: ConnectionCounterService.cs
============================================================
ï»¿namespace VacantRoomWeb
{
    /// <summary>
    /// ç»´æŠ¤å½“å‰åœ¨çº¿è¿æ¥æ•°
    /// </summary>
    public class ConnectionCounterService
    {
        private int _count = 0;

        public int Increment()
        {
            return Interlocked.Increment(ref _count);
        }

        public int Decrement()
        {
            return Interlocked.Decrement(ref _count);
        }

        public int GetCount()
        {
            return _count;
        }
    }

}



============================================================
FILE: ConnectionLoggingCircuitHandler.cs
============================================================
ï»¿using Microsoft.AspNetCore.Components.Server.Circuits;
using VacantRoomWeb;

/// <summary>
/// ç”¨äºå¤„ç†è¿æ¥æ•°ç»Ÿè®¡å’Œè·å–å®¢æˆ·ç«¯IPçš„æ ¸å¿ƒäº‹ä»¶å¤„ç†å™¨
/// </summary>
public class ConnectionLoggingCircuitHandler : CircuitHandler
{
    private readonly ConnectionCounterService _counter;
    private readonly ClientConnectionTracker _ipTracker;
    private readonly IHttpContextAccessor _httpContextAccessor;

    public ConnectionLoggingCircuitHandler(
        ConnectionCounterService counter,
        ClientConnectionTracker ipTracker,
        IHttpContextAccessor httpContextAccessor)
    {
        _counter = counter;
        _ipTracker = ipTracker;
        _httpContextAccessor = httpContextAccessor;
    }

    public override Task OnConnectionUpAsync(Circuit circuit, CancellationToken cancellationToken)
    {
        var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "æœªçŸ¥IP";

        _ipTracker.SetClientIp(circuit.Id, ip);

        var count = _counter.Increment();
        Console.WriteLine($"{DateTime.Now:yyyy/M/d HH:mm:ss} IP: {ip,-16} å·²è¿æ¥ å½“å‰è¿æ¥æ•°ï¼š{count}");

        return Task.CompletedTask;
    }

    public override Task OnConnectionDownAsync(Circuit circuit, CancellationToken cancellationToken)
    {
        var ip = _ipTracker.GetClientIp(circuit.Id);

        // åªæœ‰è®°å½•è¿‡ IPï¼ˆå³è¯¥è¿æ¥æ˜¯æˆ‘ä»¬å…³æ³¨çš„ï¼‰æ‰æ‰§è¡Œç§»é™¤å’Œé€’å‡
        if (ip != null)
        {
            _ipTracker.Remove(circuit.Id);
            var count = _counter.Decrement();
            Console.WriteLine($"{DateTime.Now:yyyy/M/d HH:mm:ss} IP: {ip,-16} å·²æ–­å¼€ å½“å‰è¿æ¥æ•°ï¼š{count}");
        }
        else
        {
            // è·³è¿‡æ— æ•ˆæ–­å¼€äº‹ä»¶çš„é€’å‡ï¼Œä½†ä»å¯è®°å½•æ—¥å¿—
            Console.WriteLine($"{DateTime.Now:yyyy/M/d HH:mm:ss} IP: æœªçŸ¥IP        å¿½ç•¥æ–­å¼€äº‹ä»¶");
        }

        return Task.CompletedTask;
    }


}


============================================================
FILE: Program.cs
============================================================
using Microsoft.AspNetCore.Components.Server.Circuits;
using VacantRoomWeb;
using VacantRoomWeb.Components;

var builder = WebApplication.CreateBuilder(args);
builder.Services.AddSingleton<VacantRoomService>();

builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents();

//Ã“ÃƒÃ“ÃšÂ´Â¦Ã€Ã­ÃÂ¬Â½Ã“ÃŠÃ½ÃÂ³Â¼Ã†ÂµÃ„Â·Ã¾ÃÃ±
builder.Services.AddSingleton<ConnectionCounterService>(); 
builder.Services.AddSingleton<ClientConnectionTracker>();
builder.Services.AddSingleton<IHttpContextAccessor, HttpContextAccessor>();
builder.Services.AddSingleton<CircuitHandler, ConnectionLoggingCircuitHandler>();

//ÃŠÂ¹Ã“ÃƒIISÂ¹ÃœÃ€Ã­Â£Â¬Â²Â»Ã“ÃƒKestrelÃ–Â±Â½Ã“Â¼Ã ÃŒÃ½Â¶Ã‹Â¿Ãš
//builder.WebHost.ConfigureKestrel(options =>
//{
//    options.ListenAnyIP(80); 
//    options.ListenAnyIP(443, listen =>
//    {
//        const string pfxPath = @"C:\Users\Administrator\Desktop\scs1750424505694_origami7023.cn_IIS\scs1750424505694_origami7023.cn_server.pfx";
//        const string pfxPwd = "Kn9?cgGxZ9xxXBEf";      

//        listen.UseHttps(pfxPath, pfxPwd);
//    });

//    options.Limits.MaxConcurrentConnections = 20;
//    options.Limits.MaxConcurrentUpgradedConnections = 20;
//});


var app = builder.Build();

if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error", createScopeForErrors: true);
    app.UseHsts();
}


app.UseHttpsRedirection();

app.UseStaticFiles();
app.UseAntiforgery();

app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode();

app.Run();



============================================================
FILE: VacantRoomService.cs
============================================================
ï»¿using ClosedXML.Excel;
using Microsoft.AspNetCore.Components.Server.Circuits;
using System.Collections.Generic;
using System.IO;
using System.Linq;

namespace VacantRoomWeb
{
    public class VacantRoomService
    {
        private readonly ConnectionCounterService _counter;
        private readonly ClientConnectionTracker _ipTracker;
        private readonly IHttpContextAccessor _httpContextAccessor;

        public VacantRoomService(
            ConnectionCounterService counter,
            ClientConnectionTracker ipTracker,
            IHttpContextAccessor httpContextAccessor)
        {
            _counter = counter;
            _ipTracker = ipTracker;
            _httpContextAccessor = httpContextAccessor;
        }

        List<string> list = new List<string> { "A101", "A102", "A103", "A104", "A105", "A106",
                                               "A201", "A202", "A203", "A204", "A205", "A206",
                                               "A301", "A302", "A303", "A304", "A305",
                                               "A401", "A402", "A403", "A404", "A405", "A406",
                                               "B101", "B102", "B103", "B104", "B105", "B106", "B107", "B108",
                                               "B201", "B202", "B203", "B204", "B205", "B206", "B207", "B208",
                                               "B301", "B302", "B303", "B304", "B305", "B306", "B307", "B308",
                                               "B401", "B402", "B403", "B404", "B405", "B406", "B407", "B408",
                                               "B501", "B502", "B503", "B504", "B505", "B506", "B507", "B508",
                                               "C101", "C102", "C103", "C104", "C105", "C106", "C107", "C108",
                                               "C200", "C201", "C202", "C203", "C204", "C205", "C206", "C207", "C208",
                                               "C301", "C302", "C303", "C304", "C305", "C306", "C307", "C308",
                                               "C401", "C402", "C403", "C404", "C405", "C406", "C407", "C408",
                                               "C501", "C502", "C503", "C504", "C505", "C506", "C507", "C508",
                                               "D101", "D102", "D103", "D104", "D105", "D106", "D107", "D108",
                                               "D201", "D202", "D203", "D204", "D205", "D206", "D207", "D208",
                                               "D301", "D302", "D303", "D304", "D305", "D306", "D307", "D308",
                                               "D401", "D402", "D403", "D404", "D405", "D406", "D407", "D408",
                                               "D501", "D502", "D503", "D504", "D505", "D506", "D507", "D508",
                                               "E113", "E115", };

        // Dictionary for period time mapping
        private readonly Dictionary<string, string> PeriodTimeMap = new()
        {
            { "1-2èŠ‚", "08:00-09:40" },
            { "01-02èŠ‚", "08:00-09:40" },
            { "3-4èŠ‚", "09:55-11:35" },
            { "03-04èŠ‚", "09:55-11:35" },
            { "5-6èŠ‚", "13:30-15:10" },
            { "05-06èŠ‚", "13:30-15:10" },
            { "7-8èŠ‚", "15:25-17:05" },
            { "07-08èŠ‚", "15:25-17:05" },
            { "9-10èŠ‚", "18:00-19:35" },
            { "09-10èŠ‚", "18:00-19:35" },
            { "9-11èŠ‚", "18:00-20:30" },
            { "09-11èŠ‚", "18:00-20:30" }
        };

        public List<string> GetVacantRooms(string campus, string weekday, string period, string building, string week)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "æœªçŸ¥IP";

            Console.Write($"{DateTime.Now:yyyy/M/d HH:mm:ss} IP: {ip,-16} ");

            Console.ForegroundColor = ConsoleColor.Yellow;//ä½¿ç”¨é»„è‰²å­—ä½“
            Console.WriteLine("è·å–æ•°æ®");
            Console.ResetColor(); // æ¢å¤é»˜è®¤é¢œè‰²
            Console.WriteLine($"æŸ¥è¯¢æ¡ä»¶ï¼š{campus.Substring(0, 2)} {weekday} {period} {building}æ•™å­¦æ¥¼ {week}");

            var filePath = Path.Combine(AppContext.BaseDirectory, "Data", "schedule.xlsx");
            if (!File.Exists(filePath))
            {
                Console.WriteLine("æ–‡ä»¶æœªæ‰¾åˆ°ï¼š" + filePath);
                return new List<string>();
            }

            var occupiedRooms = new HashSet<string>();

            using var workbook = new XLWorkbook(filePath);
            var sheet = workbook.Worksheets.First();

            foreach (var row in sheet.RowsUsed().Skip(1)) // è·³è¿‡è¡¨å¤´
            {
                var rowCampus = row.Cell(10).GetString();       // Jåˆ—ï¼šæ’è¯¾æ ¡åŒº
                var rowTime = row.Cell(14).GetString();         // Nåˆ—ï¼šä¸Šè¯¾æ—¶é—´ï¼ˆå¦‚ å‘¨ä¸€ 1-2èŠ‚ï¼‰
                var rowWeeks = row.Cell(15).GetString();        // Oåˆ—ï¼šèµ·æ­¢å‘¨ï¼ˆå¦‚ 1-16å‘¨å…¨ï¼‰
                var room = row.Cell(16).GetString();            // Påˆ—ï¼šä¸Šè¯¾åœ°ç‚¹ï¼ˆå¦‚ B303ï¼‰

                if (!room.Any()) continue;

                // æ ¡åŒºåŒ¹é…
                if (rowCampus != campus) continue;

                // æ—¶é—´æ®µåŒ¹é…ï¼ˆæ›´å¼ºåˆ¤æ–­ï¼šèŠ‚æ¬¡åŒºé—´æ˜¯å¦è¦†ç›–ï¼‰
                if (!IsPeriodMatch(rowTime, weekday, period)) continue;

                // å‘¨æ¬¡åŒ¹é…ï¼ˆå¦‚"ç¬¬1å‘¨"æ˜¯å¦åœ¨"1-16å‘¨å…¨"ä¸­ï¼‰
                if (!IsWeekMatch(rowWeeks, week)) continue;

                occupiedRooms.Add(room);
            }

            // å¯æ‰©å±•ä¸ºåŠ¨æ€æå–æ‰€æœ‰æ•™å®¤
            var allRooms = list;

            return allRooms
                .Where(r => !occupiedRooms.Contains(r) &&
                            (building == "æ‰€æœ‰" || r.StartsWith(building)))
                .ToList();
        }

        // NEW METHOD: Get room usage for a specific room
        public List<RoomUsage> GetRoomUsage(string campus, string roomNumber, string weekday, string week)
        {
            var ip = _httpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.MapToIPv4().ToString() ?? "æœªçŸ¥IP";

            Console.Write($"{DateTime.Now:yyyy/M/d HH:mm:ss} IP: {ip,-16} ");
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine("æŸ¥è¯¢æ•™å®¤ä½¿ç”¨æƒ…å†µ");
            Console.ResetColor();
            Console.WriteLine($"æŸ¥è¯¢æ¡ä»¶ï¼š{campus.Substring(0, 2)} {roomNumber} {weekday} {week}");

            var filePath = Path.Combine(AppContext.BaseDirectory, "Data", "schedule.xlsx");
            if (!File.Exists(filePath))
            {
                Console.WriteLine("æ–‡ä»¶æœªæ‰¾åˆ°ï¼š" + filePath);
                return new List<RoomUsage>();
            }

            var roomUsages = new List<RoomUsage>();

            using var workbook = new XLWorkbook(filePath);
            var sheet = workbook.Worksheets.First();

            foreach (var row in sheet.RowsUsed().Skip(1)) // è·³è¿‡è¡¨å¤´
            {
                var rowCampus = row.Cell(10).GetString();       // Jåˆ—ï¼šæ’è¯¾æ ¡åŒº
                var rowTime = row.Cell(14).GetString();         // Nåˆ—ï¼šä¸Šè¯¾æ—¶é—´ï¼ˆå¦‚ å‘¨ä¸€ 1-2èŠ‚ï¼‰
                var rowWeeks = row.Cell(15).GetString();        // Oåˆ—ï¼šèµ·æ­¢å‘¨ï¼ˆå¦‚ 1-16å‘¨å…¨ï¼‰
                var room = row.Cell(16).GetString();            // Påˆ—ï¼šä¸Šè¯¾åœ°ç‚¹ï¼ˆå¦‚ B303ï¼‰
                var courseName = row.Cell(5).GetString();       // Eåˆ—ï¼šè¯¾ç¨‹åç§°
                var teacher = row.Cell(12).GetString();          // Håˆ—ï¼šä»»è¯¾æ•™å¸ˆ

                if (string.IsNullOrEmpty(room)) continue;

                // æ ¡åŒºåŒ¹é…
                if (rowCampus != campus) continue;

                // æ•™å®¤åŒ¹é…
                if (room != roomNumber) continue;

                // æ˜ŸæœŸåŒ¹é…
                if (!IsWeekdayMatch(rowTime, weekday)) continue;

                // å‘¨æ¬¡åŒ¹é…
                if (!IsWeekMatch(rowWeeks, week)) continue;

                // æå–èŠ‚æ¬¡ä¿¡æ¯
                var period = ExtractPeriodFromTime(rowTime);
                var timeRange = GetTimeRangeForPeriod(period);

                roomUsages.Add(new RoomUsage
                {
                    Period = period,
                    TimeRange = timeRange,
                    CourseName = courseName,
                    Teacher = teacher,
                });
            }

            // æŒ‰èŠ‚æ¬¡é¡ºåºæ’åº
            var periodOrder = new Dictionary<string, int>
            {
                { "1-2èŠ‚", 1 }, { "01-02èŠ‚", 1 },
                { "3-4èŠ‚", 2 }, { "03-04èŠ‚", 2 },
                { "5-6èŠ‚", 3 }, { "05-06èŠ‚", 3 },
                { "7-8èŠ‚", 4 }, { "07-08èŠ‚", 4 },
                { "9-10èŠ‚", 5 }, { "09-10èŠ‚", 5 },
                { "9-11èŠ‚", 6 }, { "09-11èŠ‚", 6 },
                { "10-11èŠ‚", 7 }, { "10-12èŠ‚", 8 }
            };

            return roomUsages.OrderBy(r => periodOrder.GetValueOrDefault(r.Period, 999)).ToList();
        }

        // NEW METHOD: Get available rooms for a building (for the dropdown)
        public List<string> GetRoomsForBuilding(string building)
        {
            if (string.IsNullOrEmpty(building)) return new List<string>();

            return list.Where(r => r.StartsWith(building))
                      .Select(r => r.Substring(1)) // Remove building letter (A101 -> 101)
                      .Distinct()
                      .OrderBy(r => r)
                      .ToList();
        }

        // Helper method to check weekday match
        private bool IsWeekdayMatch(string rowTime, string selectedWeekday)
        {
            string ExtractWeekday(string text)
            {
                if (text.StartsWith("å‘¨") && text.Length >= 2)
                    return text.Substring(0, 2); // å¦‚ "å‘¨ä¸‰"
                return "";
            }

            return ExtractWeekday(rowTime) == ExtractWeekday(selectedWeekday);
        }

        // Helper method to extract period from time string
        private string ExtractPeriodFromTime(string rowTime)
        {
            // Extract period range from time string like "å‘¨ä¸‰ 9-10èŠ‚" -> "9-10èŠ‚"
            var parts = rowTime.Split(' ');
            if (parts.Length > 1)
            {
                var periodPart = parts[1];
                if (periodPart.EndsWith("èŠ‚"))
                {
                    return periodPart;
                }
                else
                {
                    return periodPart + "èŠ‚";
                }
            }
            return "";
        }

        // Helper method to get time range for a period
        private string GetTimeRangeForPeriod(string period)
        {
            // Normalize period format
            period = period.Replace("èŠ‚", "");
            if (!period.Contains("-"))
            {
                // Handle single periods like "1" -> "1-1"
                if (int.TryParse(period, out int num))
                {
                    period = $"{num}-{num}";
                }
            }
            period += "èŠ‚";

            return PeriodTimeMap.GetValueOrDefault(period, "æ—¶é—´æœªçŸ¥");
        }

        private bool IsWeekMatch(string rowWeeks, string selectedWeek)
        {
            if (!int.TryParse(selectedWeek.Replace("ç¬¬", "").Replace("å‘¨", ""), out int weekNumber))
                return false;

            rowWeeks = rowWeeks.Replace("å‘¨", "").Replace(" ", "");
            bool isSingle = rowWeeks.EndsWith("å•");
            bool isDouble = rowWeeks.EndsWith("åŒ");
            bool isAll = rowWeeks.EndsWith("å…¨");

            // å»æ‰ç»“å°¾æè¿°ï¼ˆå•/åŒ/å…¨ï¼‰
            if (isSingle || isDouble || isAll)
                rowWeeks = rowWeeks.Substring(0, rowWeeks.Length - 1);

            var matched = false;

            foreach (var part in rowWeeks.Split(','))
            {
                if (part.Contains('-'))
                {
                    var bounds = part.Split('-');
                    if (bounds.Length == 2 &&
                        int.TryParse(bounds[0], out int start) &&
                        int.TryParse(bounds[1], out int end))
                    {
                        if (weekNumber >= start && weekNumber <= end)
                        {
                            matched = true;
                            break;
                        }
                    }
                }
                else if (int.TryParse(part, out int val))
                {
                    if (val == weekNumber)
                    {
                        matched = true;
                        break;
                    }
                }
            }

            if (!matched) return false;

            if (isSingle && weekNumber % 2 == 0) return false;
            if (isDouble && weekNumber % 2 != 0) return false;

            return true;
        }

        private bool IsPeriodMatch(string rowTime, string selectedWeekday, string selectedPeriod)
        {
            string Normalize(string text) => text.Replace("èŠ‚", "").Replace(" ", "");

            // æå–"å‘¨å‡ "å’Œ"èŠ‚æ¬¡èŒƒå›´"
            string ExtractWeekday(string text)
            {
                if (text.StartsWith("å‘¨") && text.Length >= 2)
                    return text.Substring(0, 2); // å¦‚ "å‘¨ä¸‰"
                return "";
            }

            string ExtractRange(string text)
            {
                var norm = Normalize(text);
                var idx = norm.IndexOfAny("ä¸€äºŒä¸‰å››äº”å…­æ—¥".ToCharArray());
                if (idx >= 0 && idx + 1 < norm.Length)
                    return norm.Substring(idx + 1); // ä»èŠ‚æ¬¡èŒƒå›´å¼€å§‹
                return "";
            }

            bool TryParseRange(string range, out int start, out int end)
            {
                start = end = 0;
                var nums = range.Split('-');
                if (nums.Length == 2 &&
                    int.TryParse(nums[0], out start) &&
                    int.TryParse(nums[1], out end)) return true;
                return false;
            }

            string rowWeekday = ExtractWeekday(rowTime);        // å‘¨ä¸‰
            string userWeekday = ExtractWeekday(selectedWeekday); // å‘¨ä¸‰

            if (rowWeekday != userWeekday) return false;

            string rowRange = ExtractRange(rowTime);             // 09-11
            string userRange = Normalize(selectedPeriod);        // 9-10

            if (TryParseRange(rowRange, out int rowStart, out int rowEnd) &&
                TryParseRange(userRange, out int userStart, out int userEnd))
            {
                return userStart >= rowStart && userEnd <= rowEnd;
            }

            return false;
        }
    }

    // NEW CLASS: Room usage data model
    public class RoomUsage
    {
        public string Period { get; set; } = "";
        public string TimeRange { get; set; } = "";
        public string CourseName { get; set; } = "";
        public string Teacher { get; set; } = "";
    }
}


============================================================
FILE: VacantRoomWeb.csproj
============================================================
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
	  <AspNetCoreHostingModel>OutOfProcess</AspNetCoreHostingModel>
	  <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="ClosedXML" Version="0.105.0" />
  </ItemGroup>

  <ItemGroup>
    <Folder Include="Data\" />
  </ItemGroup>

  <ItemGroup>
    <None Update="Data\schedule.xlsx">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <ProjectExtensions><VisualStudio><UserProperties properties_4launchsettings_1json__JsonSchema="" /></VisualStudio></ProjectExtensions>

</Project>
    


============================================================
FILE: appsettings.Development.json
============================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}



============================================================
FILE: appsettings.json
============================================================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}



================================================================================
END OF CODE FILES
================================================================================
